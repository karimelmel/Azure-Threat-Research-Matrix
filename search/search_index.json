{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"# Reconnaissance Initial Access Execution Privilege Escalation Persistence Credential Access Exfiltration Port Mapping Valid Credentials Virtual Machine Scripting Privileged Identity Management Role Account Manipulation Steal Managed Identity JsonWebToken SAS URI Generation IP Discovery Password Spraying Unmanaged Scripting Elevated Access Toggle Account Creation Steal Service Principal Certificate File Share Mounting Public Accessible Resource Malicious Application Consent Managed Device Scripting Local Resource Hijack HTTP Trigger Service Principal Secret Reveal Replication Gather User Information Principal Impersonation Watcher Tasks Azure KeyVault Dumping Soft-Delete Recovery Gather Application Information Azure AD Application Scheduled Jobs Resource Secret Reveal Gather Role Information Network Security Group Modification Gather Resource Data External Entity Access Gather Victim Data Azure Policy How to Use The top row designates the tactic being used and the rows below it are the specific techniques pertaining to that tactic. Clicking on a specific tactic will list the techniques specific to it. Clicking on a specific technique will bring you to the page on that technique and the details around it. You can also utilize the search bar at the top to recursively search for specific text. For example, to search for what techniques a certain action or permission has, just enter the action in the search bar and it will show all relevant techniques. When viewing the page of a technique, specific examples of how to abuse the technique with different methods are shown. By clicking on the given command, it will bring you to the documentation around it. Disclaimer The purpose of the Azure Threat Research Matrix (ATRM) is to educate readers on the potential of Azure-based tactics, techniques, and procedures (TTPs). It is not to teach how to weaponize or specifically abuse them. For this reason, some specific commands will be obfuscated or parts will be omitted to prevent abuse. Feedback With the intent of ATRM being a collaborative effort with the community, feedback is greatly appreciated. Is there a new or missing technique? Is the formatting off-putting? Please let me know @haus3c . Acknowledgements #","title":"Home"},{"location":"#_1","text":"","title":""},{"location":"#acknowledgements","text":"","title":"Acknowledgements"},{"location":"about/","text":"Purpose # The purpose of the Azure Threat Research Matrix (ATRM) is to conceptualize the known tactics, techniques, and procedures (TTP) that adversaries may use against the Azure platform. Inspired from MITRE ATT&CK, ATRM is designed to give quick insight into a potential TTP that an adversary may be using in their attack campaign. While some tactics in ATT&CK may pertain to Azure, the ATRM is meant to be specific within Azure AD and Azure Resources. The ATRM is created by Ryan Hausknecht (@haus3c) of the Microsoft EDG Raptor team. You can read the release blog post here: https://techcommunity.microsoft.com/t5/security-compliance-and-identity/introducing-the-azure-threat-research-matrix/ba-p/3584976","title":"About"},{"location":"about/#purpose","text":"The purpose of the Azure Threat Research Matrix (ATRM) is to conceptualize the known tactics, techniques, and procedures (TTP) that adversaries may use against the Azure platform. Inspired from MITRE ATT&CK, ATRM is designed to give quick insight into a potential TTP that an adversary may be using in their attack campaign. While some tactics in ATT&CK may pertain to Azure, the ATRM is meant to be specific within Azure AD and Azure Resources. The ATRM is created by Ryan Hausknecht (@haus3c) of the Microsoft EDG Raptor team. You can read the release blog post here: https://techcommunity.microsoft.com/t5/security-compliance-and-identity/introducing-the-azure-threat-research-matrix/ba-p/3584976","title":"Purpose"},{"location":"acknowledgments/","text":"The Azure Threat Research Matrix is a collaborative effort with Microsoft and the greater information security industry. This project would not be possible without the following individuals and their contributions: Karl Fosaaen Nestori Syynimaa Ryan Cobb Roberto Rodriguez Manuel Berrueta Jonny Johnson Dor Edry Ram Pliskin Nikhil Mittal MITRE ATT&CK - \u00a9 2021 The MITRE Corporation. This work is reproduced and distributed with the permission of The MITRE Corporation. AlertIQ","title":"Acknowledgments"},{"location":"CredentialAccess/CredentialAccess/","text":"Credential Access # The adversary is trying to steal account usernames, passwords, or access tokens. Credential access in Azure consists of stealing methods of authentication which includes passwords and tokens. Stealing these credentials can give adversaries a potential avenue of privilege escalation or persistence. ID Name Description AZT601 Steal Managed Identity JsonWebToken An adverary may utilize the resource's functionality to obtain a JWT for the applied Managed Identity Service Principal account. .001 Virtual Machine IMDS Request By utilizing access to IMDS, an attacker can request a JWT for a Managed Identity on an Azure VM if they have access to execute commands on the system. .002 Azure Kubernetes Service IMDS Request By utilizing access to IMDS, an attacker can request a JWT for a Managed Identity on an AKS Cluster if they have access to execute commands on the system. .003 Logic Application JWT PUT Request If a Logic App is using a Managed Identity, an adversary can modify the logic to make an HTTP POST request to reveal the Managed Identity's JWT. .004 Function Application JWT GET Request If a Function App is using a Managed Identity, an adversary can modify the logic respond to an HTTP GET request to reveal the Managed Identity's JWT. .005 Automation Account Runbook If an Automation Account is using a Managed Identity, an adversary can create a Runbook to request the Managed Identity's JWT. AZT602 Steal Service Principal Certificate An Adversary may steal a Service Principal's certificate for authentication. .001 Automation Account RunAs Account If a Runbook is utilizing a 'RunAs' account, then an adversary may manipulate the Runbook to reveal the certificate the Service Principal is using for authentication. AZT603 Service Principal Secret Reveal An Adversary may reveal a service principal's secret in plain text. .001 Function App Settings If a Function App is using a service principal for authentication, an adversary may manipulate the function app logic to reveal the service principal's secret in plain text. AZT604 Azure KeyVault Dumping An adverary may access an Azure KeyVault in an attempt to view secrets, certificates, or keys. .001 Azure KeyVault Secret Dump By accessing an Azure KeyVault, an adversary may dump any or all secrets. .002 Azure KeyVault Certificate Dump By accessing an Azure KeyVault, an adversary may dump any or all certificates. .003 Azure KeyVault Key Dump By accessing an Azure KeyVault, an adversary may dump any or all keys. AZT605 Resource Secret Reveal .001 Storage Account Access Key Dumping By accessing a Storage Account, an adversary may dump access keys pertaining to the Storage Account, which will give them full access to the Storage Account. .002 Automation Account Credential Secret Dump By editing a Runbook, a credential configured in an Automation Account may be revealed .003 Resource Group Deployment History Secret Dump By accessing deployment history of a Resource Group, secrets used in the ARM template may be revealed.","title":"Credential Access"},{"location":"CredentialAccess/CredentialAccess/#credential-access","text":"The adversary is trying to steal account usernames, passwords, or access tokens. Credential access in Azure consists of stealing methods of authentication which includes passwords and tokens. Stealing these credentials can give adversaries a potential avenue of privilege escalation or persistence. ID Name Description AZT601 Steal Managed Identity JsonWebToken An adverary may utilize the resource's functionality to obtain a JWT for the applied Managed Identity Service Principal account. .001 Virtual Machine IMDS Request By utilizing access to IMDS, an attacker can request a JWT for a Managed Identity on an Azure VM if they have access to execute commands on the system. .002 Azure Kubernetes Service IMDS Request By utilizing access to IMDS, an attacker can request a JWT for a Managed Identity on an AKS Cluster if they have access to execute commands on the system. .003 Logic Application JWT PUT Request If a Logic App is using a Managed Identity, an adversary can modify the logic to make an HTTP POST request to reveal the Managed Identity's JWT. .004 Function Application JWT GET Request If a Function App is using a Managed Identity, an adversary can modify the logic respond to an HTTP GET request to reveal the Managed Identity's JWT. .005 Automation Account Runbook If an Automation Account is using a Managed Identity, an adversary can create a Runbook to request the Managed Identity's JWT. AZT602 Steal Service Principal Certificate An Adversary may steal a Service Principal's certificate for authentication. .001 Automation Account RunAs Account If a Runbook is utilizing a 'RunAs' account, then an adversary may manipulate the Runbook to reveal the certificate the Service Principal is using for authentication. AZT603 Service Principal Secret Reveal An Adversary may reveal a service principal's secret in plain text. .001 Function App Settings If a Function App is using a service principal for authentication, an adversary may manipulate the function app logic to reveal the service principal's secret in plain text. AZT604 Azure KeyVault Dumping An adverary may access an Azure KeyVault in an attempt to view secrets, certificates, or keys. .001 Azure KeyVault Secret Dump By accessing an Azure KeyVault, an adversary may dump any or all secrets. .002 Azure KeyVault Certificate Dump By accessing an Azure KeyVault, an adversary may dump any or all certificates. .003 Azure KeyVault Key Dump By accessing an Azure KeyVault, an adversary may dump any or all keys. AZT605 Resource Secret Reveal .001 Storage Account Access Key Dumping By accessing a Storage Account, an adversary may dump access keys pertaining to the Storage Account, which will give them full access to the Storage Account. .002 Automation Account Credential Secret Dump By editing a Runbook, a credential configured in an Automation Account may be revealed .003 Resource Group Deployment History Secret Dump By accessing deployment history of a Resource Group, secrets used in the ARM template may be revealed.","title":"Credential Access"},{"location":"CredentialAccess/AZT601/AZT601-1/","text":"AZT601.1 - Steal Managed Identity JsonWebToken: Virtual Machine IMDS Request # By utilizing access to IMDS, an attacker can request a JWT for a Managed Identity on an Azure VM if they have access to execute commands on the system. Resource Virtual Machine Actions Microsoft.Compute/virtualMachines/write Microsoft.Compute/virtualMachines/extensions/* Examples PowerShell Azure Portal powershell . exe -c $a = Invoke-Restmethod -Uri 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01\"&\"resource=https://management.azure.com/' -Method GET -Headers @{ Metadata = 'true' } -UseBasicParsing ; $a . access_token Detections The detection will be based off of the Command Execution technique chosen. If using RDP, then no logs will be generated in Azure. Since the command to retrieve the JWT requires local PowerShell execution, script block logging will reveal the request used to gather the token. Additional Resources https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-use-vm-token","title":"AZT601.1 - Virtual Machine IMDS Request"},{"location":"CredentialAccess/AZT601/AZT601-1/#azt6011-steal-managed-identity-jsonwebtoken-virtual-machine-imds-request","text":"By utilizing access to IMDS, an attacker can request a JWT for a Managed Identity on an Azure VM if they have access to execute commands on the system. Resource Virtual Machine Actions Microsoft.Compute/virtualMachines/write Microsoft.Compute/virtualMachines/extensions/* Examples PowerShell Azure Portal powershell . exe -c $a = Invoke-Restmethod -Uri 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01\"&\"resource=https://management.azure.com/' -Method GET -Headers @{ Metadata = 'true' } -UseBasicParsing ; $a . access_token Detections The detection will be based off of the Command Execution technique chosen. If using RDP, then no logs will be generated in Azure. Since the command to retrieve the JWT requires local PowerShell execution, script block logging will reveal the request used to gather the token. Additional Resources https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-use-vm-token","title":"AZT601.1 - Steal Managed Identity JsonWebToken: Virtual Machine IMDS Request"},{"location":"CredentialAccess/AZT601/AZT601-2/","text":"AZT601.2 - Steal Managed Identity JsonWebToken: Azure Kubernetes Service IMDS Request # By utilizing access to IMDS, an attacker can request a JWT for a Managed Identity on an AKS Cluster if they have access to execute commands on the system. Resource Azure Kubernetes Service Actions Microsoft.ContainerService/managedClusters/runcommand/action Microsoft.ContainerService/managedclusters/commandResults/read Examples Python PowerShell Azure Portal curl 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https%3A %2F%2F management.azure.com %2F ' - H Metadata : true - s powershell . exe -c $a = Invoke-Restmethod -Uri 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01\"&\"resource=https://management.azure.com/' -Method GET -Headers @{ Metadata = 'true' } -UseBasicParsing ; $a . access_token Detections Detection Details # Logs are only generated when running a command through az cli or Az PowerShell. Using kubectl will not generate logs. Logs # Data Source Operation Name Action Log Location Resource RunCommand Microsoft.ContainerService/managedClusters/runCommand/action Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.ContainerService/managedClusters/runCommand/action\" Additional Resources https://docs.microsoft.com/en-us/azure/aks/command-invoke https://docs.microsoft.com/en-us/azure/aks/use-managed-identity","title":"AZT601.2 - Azure Kubernetes Service IMDS Request"},{"location":"CredentialAccess/AZT601/AZT601-2/#azt6012-steal-managed-identity-jsonwebtoken-azure-kubernetes-service-imds-request","text":"By utilizing access to IMDS, an attacker can request a JWT for a Managed Identity on an AKS Cluster if they have access to execute commands on the system. Resource Azure Kubernetes Service Actions Microsoft.ContainerService/managedClusters/runcommand/action Microsoft.ContainerService/managedclusters/commandResults/read Examples Python PowerShell Azure Portal curl 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https%3A %2F%2F management.azure.com %2F ' - H Metadata : true - s powershell . exe -c $a = Invoke-Restmethod -Uri 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01\"&\"resource=https://management.azure.com/' -Method GET -Headers @{ Metadata = 'true' } -UseBasicParsing ; $a . access_token Detections","title":"AZT601.2 - Steal Managed Identity JsonWebToken: Azure Kubernetes Service IMDS Request"},{"location":"CredentialAccess/AZT601/AZT601-2/#detection-details","text":"Logs are only generated when running a command through az cli or Az PowerShell. Using kubectl will not generate logs.","title":"Detection Details"},{"location":"CredentialAccess/AZT601/AZT601-2/#logs","text":"Data Source Operation Name Action Log Location Resource RunCommand Microsoft.ContainerService/managedClusters/runCommand/action Azure Activity Log","title":"Logs"},{"location":"CredentialAccess/AZT601/AZT601-2/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.ContainerService/managedClusters/runCommand/action\" Additional Resources https://docs.microsoft.com/en-us/azure/aks/command-invoke https://docs.microsoft.com/en-us/azure/aks/use-managed-identity","title":"Queries"},{"location":"CredentialAccess/AZT601/AZT601-3/","text":"AZT601.3 - Steal Managed Identity JsonWebToken: Logic Application JWT PUT Request # If a Logic App is using a Managed Identity, an adversary can modify the logic to make an HTTP POST request to reveal the Managed Identity's JWT. Resource Logic Application Actions Microsoft.Logic/workflows/write Microsoft.Logic/workflows/run/action Microsoft.Logic/operations/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzLogicApp az logicapp start PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Logic / workflows / { workflowName } ? api - version = 2016 - 06 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Gets workflow recommend operation groups Microsoft.Logic/locations/workflows/recommendOperationGroups/action Azure Activity Log Resource List Trigger Callback URL Microsoft.Logic/workflows/triggers/listCallbackUrl/action Azure Activity Log Resource Add or Update Connection Microsoft.Web/connections/write Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Logic/locations/workflows/recommendOperationGroups/action\" or OperationNameValue==\"Microsoft.Logic/workflows/triggers/listCallbackUrl/action\"orOperationNameValue==\"Microsoft.Web/connections/write\" Additional Resources https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-overview","title":"AZT601.3 - Logic Application JWT PUT Request"},{"location":"CredentialAccess/AZT601/AZT601-3/#azt6013-steal-managed-identity-jsonwebtoken-logic-application-jwt-put-request","text":"If a Logic App is using a Managed Identity, an adversary can modify the logic to make an HTTP POST request to reveal the Managed Identity's JWT. Resource Logic Application Actions Microsoft.Logic/workflows/write Microsoft.Logic/workflows/run/action Microsoft.Logic/operations/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzLogicApp az logicapp start PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Logic / workflows / { workflowName } ? api - version = 2016 - 06 - 01 Detections","title":"AZT601.3 - Steal Managed Identity JsonWebToken: Logic Application JWT PUT Request"},{"location":"CredentialAccess/AZT601/AZT601-3/#logs","text":"Data Source Operation Name Action Log Location Resource Gets workflow recommend operation groups Microsoft.Logic/locations/workflows/recommendOperationGroups/action Azure Activity Log Resource List Trigger Callback URL Microsoft.Logic/workflows/triggers/listCallbackUrl/action Azure Activity Log Resource Add or Update Connection Microsoft.Web/connections/write Azure Activity Log","title":"Logs"},{"location":"CredentialAccess/AZT601/AZT601-3/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Logic/locations/workflows/recommendOperationGroups/action\" or OperationNameValue==\"Microsoft.Logic/workflows/triggers/listCallbackUrl/action\"orOperationNameValue==\"Microsoft.Web/connections/write\" Additional Resources https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-overview","title":"Queries"},{"location":"CredentialAccess/AZT601/AZT601-4/","text":"AZT601.4 - Steal Managed Identity JsonWebToken: Function Application JWT GET Request # If a Function App is using a Managed Identity, an adversary can modify the logic respond to an HTTP GET request to reveal the Managed Identity's JWT. Resource Function App Actions Microsoft.Web/sites/Write Microsoft.web/sites/functions/action Microsoft.web/sites/functions/write Examples Az PowerShell Azure CLI Azure Portal Update-AzFunctionApp az functionapp update Detections Logs # Data Source Operation Name Action Log Location Azure Active Directory Update website Microsoft.Web/sites/write AzureAD Audit Logs Azure Active Directory Start Web App Microsoft.Web/sites/start/action AzureAD Audit Logs Queries # Log Analytics AuditLogs| where ActivityDisplayName == \"Update website\" or ActivityDisplayName == \"Start Web App\" Additional Resources https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview","title":"AZT601.4 - Function Application JWT GET Request"},{"location":"CredentialAccess/AZT601/AZT601-4/#azt6014-steal-managed-identity-jsonwebtoken-function-application-jwt-get-request","text":"If a Function App is using a Managed Identity, an adversary can modify the logic respond to an HTTP GET request to reveal the Managed Identity's JWT. Resource Function App Actions Microsoft.Web/sites/Write Microsoft.web/sites/functions/action Microsoft.web/sites/functions/write Examples Az PowerShell Azure CLI Azure Portal Update-AzFunctionApp az functionapp update Detections","title":"AZT601.4 - Steal Managed Identity JsonWebToken: Function Application JWT GET Request"},{"location":"CredentialAccess/AZT601/AZT601-4/#logs","text":"Data Source Operation Name Action Log Location Azure Active Directory Update website Microsoft.Web/sites/write AzureAD Audit Logs Azure Active Directory Start Web App Microsoft.Web/sites/start/action AzureAD Audit Logs","title":"Logs"},{"location":"CredentialAccess/AZT601/AZT601-4/#queries","text":"Log Analytics AuditLogs| where ActivityDisplayName == \"Update website\" or ActivityDisplayName == \"Start Web App\" Additional Resources https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview","title":"Queries"},{"location":"CredentialAccess/AZT601/AZT601-5/","text":"AZT601.4 - Steal Managed Identity JsonWebToken: Automation Account Runbook # If an Automation Account is using a Managed Identity, an adversary can create a Runbook to request the Managed Identity's JWT. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook az automation runbook create PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Automation / automationAccounts /{ automationAccountName }/ runbooks /{ runbookName } ? api-version = 2019 - 06 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution https://posts.specterops.io/managed-identity-attack-paths-part-1-automation-accounts-82667d17187a","title":"AZT601.5 - Automation Account Runbook"},{"location":"CredentialAccess/AZT601/AZT601-5/#azt6014-steal-managed-identity-jsonwebtoken-automation-account-runbook","text":"If an Automation Account is using a Managed Identity, an adversary can create a Runbook to request the Managed Identity's JWT. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook az automation runbook create PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Automation / automationAccounts /{ automationAccountName }/ runbooks /{ runbookName } ? api-version = 2019 - 06 - 01 Detections","title":"AZT601.4 - Steal Managed Identity JsonWebToken: Automation Account Runbook"},{"location":"CredentialAccess/AZT601/AZT601-5/#logs","text":"Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log","title":"Logs"},{"location":"CredentialAccess/AZT601/AZT601-5/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution https://posts.specterops.io/managed-identity-attack-paths-part-1-automation-accounts-82667d17187a","title":"Queries"},{"location":"CredentialAccess/AZT601/AZT601/","text":"AZT601 - Steal Managed Identity JsonWebToken # An adverary may utilize the resource's functionality to obtain a JWT for the applied Managed Identity Service Principal account. ID Name Description Action Resources AZT601.1 Virtual Machine IMDS Request By utilizing access to IMDS, an attacker can request a JWT for a Managed Identity on an Azure VM if they have access to execute commands on the system. Microsoft.Compute/virtualMachines/write Virtual Machine Microsoft.Compute/virtualMachines/extensions/* AZT601.2 Azure Kubernetes Service IMDS Request By utilizing access to IMDS, an attacker can request a JWT for a Managed Identity on an AKS Cluster if they have access to execute commands on the system. Microsoft.ContainerService/managedClusters/runcommand/action Azure Kubernetes Service Microsoft.ContainerService/managedclusters/commandResults/read AZT601.3 Logic Application JWT PUT Request If a Logic App is using a Managed Identity, an adversary can modify the logic to make an HTTP POST request to reveal the Managed Identity's JWT. Microsoft.Logic/workflows/write Logic Application Microsoft.Logic/workflows/run/action Microsoft.Logic/operations/read AZT601.4 Function Application JWT GET Request If a Function App is using a Managed Identity, an adversary can modify the logic respond to an HTTP GET request to reveal the Managed Identity's JWT. Microsoft.Web/sites/Write Function App microsoft.web/sites/functions/action microsoft.web/sites/functions/write AZT601.5 Automation Account Runbook If an Automation Account is using a Managed Identity, an adversary can create a Runbook to request the Managed Identity's JWT. Microsoft.Automation/automationAccounts/runbooks/write Automation Account","title":"AZT601 - Steal Managed Identity JsonWebToken"},{"location":"CredentialAccess/AZT601/AZT601/#azt601-steal-managed-identity-jsonwebtoken","text":"An adverary may utilize the resource's functionality to obtain a JWT for the applied Managed Identity Service Principal account. ID Name Description Action Resources AZT601.1 Virtual Machine IMDS Request By utilizing access to IMDS, an attacker can request a JWT for a Managed Identity on an Azure VM if they have access to execute commands on the system. Microsoft.Compute/virtualMachines/write Virtual Machine Microsoft.Compute/virtualMachines/extensions/* AZT601.2 Azure Kubernetes Service IMDS Request By utilizing access to IMDS, an attacker can request a JWT for a Managed Identity on an AKS Cluster if they have access to execute commands on the system. Microsoft.ContainerService/managedClusters/runcommand/action Azure Kubernetes Service Microsoft.ContainerService/managedclusters/commandResults/read AZT601.3 Logic Application JWT PUT Request If a Logic App is using a Managed Identity, an adversary can modify the logic to make an HTTP POST request to reveal the Managed Identity's JWT. Microsoft.Logic/workflows/write Logic Application Microsoft.Logic/workflows/run/action Microsoft.Logic/operations/read AZT601.4 Function Application JWT GET Request If a Function App is using a Managed Identity, an adversary can modify the logic respond to an HTTP GET request to reveal the Managed Identity's JWT. Microsoft.Web/sites/Write Function App microsoft.web/sites/functions/action microsoft.web/sites/functions/write AZT601.5 Automation Account Runbook If an Automation Account is using a Managed Identity, an adversary can create a Runbook to request the Managed Identity's JWT. Microsoft.Automation/automationAccounts/runbooks/write Automation Account","title":"AZT601 - Steal Managed Identity JsonWebToken"},{"location":"CredentialAccess/AZT602/AZT602-1/","text":"AZT602.1 - Steal Service Principal Certificate: Automation Account RunAs Account # If a Runbook is utilizing a 'RunAs' account, then an adversary may manipulate the Runbook to reveal the certificate the Service Principal is using for authentication. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/* Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook Set-AzAutomationRunbook az automation runbook PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Automation / automationAccounts / { automationAccountName } / runbooks / { runbookName } ? api - version = 2019 - 06 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution","title":"AZT602 - Steal Service Principal Certificate"},{"location":"CredentialAccess/AZT602/AZT602-1/#azt6021-steal-service-principal-certificate-automation-account-runas-account","text":"If a Runbook is utilizing a 'RunAs' account, then an adversary may manipulate the Runbook to reveal the certificate the Service Principal is using for authentication. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/* Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook Set-AzAutomationRunbook az automation runbook PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Automation / automationAccounts / { automationAccountName } / runbooks / { runbookName } ? api - version = 2019 - 06 - 01 Detections","title":"AZT602.1 - Steal Service Principal Certificate: Automation Account RunAs Account"},{"location":"CredentialAccess/AZT602/AZT602-1/#logs","text":"Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log","title":"Logs"},{"location":"CredentialAccess/AZT602/AZT602-1/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution","title":"Queries"},{"location":"CredentialAccess/AZT603/AZT603-1/","text":"AZT603.1 - Service Principal Secret Reveal: Function App Settings # If a Function App is using a service principal for authentication, an adversary may manipulate the function app logic to reveal the service principal's secret in plain text. Resource Function App Actions Microsoft.web/sites/functions/read Microsoft.Web/sites/read Microsoft.Web/sites/config/list/action Examples Az PowerShell Azure CLI Azure REST API Get-AzFunctionAppSetting az functionapp config appsettings PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Web / sites / { name } / config / appsettings ? api - version = 2021 - 02 - 01 Detections Detection Details # No logs are generated when retrieving the settings of a function app. Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution","title":"AZT603 - Service Principal Secret Reveal"},{"location":"CredentialAccess/AZT603/AZT603-1/#azt6031-service-principal-secret-reveal-function-app-settings","text":"If a Function App is using a service principal for authentication, an adversary may manipulate the function app logic to reveal the service principal's secret in plain text. Resource Function App Actions Microsoft.web/sites/functions/read Microsoft.Web/sites/read Microsoft.Web/sites/config/list/action Examples Az PowerShell Azure CLI Azure REST API Get-AzFunctionAppSetting az functionapp config appsettings PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Web / sites / { name } / config / appsettings ? api - version = 2021 - 02 - 01 Detections","title":"AZT603.1 - Service Principal Secret Reveal: Function App Settings"},{"location":"CredentialAccess/AZT603/AZT603-1/#detection-details","text":"No logs are generated when retrieving the settings of a function app. Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution","title":"Detection Details"},{"location":"CredentialAccess/AZT604/AZT604-1/","text":"AZT604.1 - Azure Key Vault Dumping: Azure Key Vault Secret Dump # By accessing an Azure Key Vault, an adversary may dump any or all secrets. Resource Azure Key Vault Actions Microsoft.KeyVault/vaults/secrets/getSecret/action Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzKeyVaultSecret az keyvault secret GET { vaultBaseUrl } / secrets / { secret - name } / { secret - version } ? api - version = 7.3 Detections Detection Details # By default, logging is not enabled on Key Vaults, meaning whenever a secret/key/certificate is accessed, it will not be logged unless Key Vault logging is turned on. Logs # Data Source Operation Name Action Log Location Azure Diagnostics SecretGet N/A Log Analytics Queries # Platform Query Log Analytics AzureDiagnostics | where ResourceProvider == \"MICROSOFT.KEYVAULT\" and OperationName == \"SecretGet\" Additional Resources https://docs.microsoft.com/en-us/azure/key-vault/general/logging?WT.mc_id=Portal-fx&tabs=Vault","title":"AZT604.1 - Azure KeyVault Secret Dump"},{"location":"CredentialAccess/AZT604/AZT604-1/#azt6041-azure-key-vault-dumping-azure-key-vault-secret-dump","text":"By accessing an Azure Key Vault, an adversary may dump any or all secrets. Resource Azure Key Vault Actions Microsoft.KeyVault/vaults/secrets/getSecret/action Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzKeyVaultSecret az keyvault secret GET { vaultBaseUrl } / secrets / { secret - name } / { secret - version } ? api - version = 7.3 Detections","title":"AZT604.1 - Azure Key Vault Dumping: Azure Key Vault Secret Dump"},{"location":"CredentialAccess/AZT604/AZT604-1/#detection-details","text":"By default, logging is not enabled on Key Vaults, meaning whenever a secret/key/certificate is accessed, it will not be logged unless Key Vault logging is turned on.","title":"Detection Details"},{"location":"CredentialAccess/AZT604/AZT604-1/#logs","text":"Data Source Operation Name Action Log Location Azure Diagnostics SecretGet N/A Log Analytics","title":"Logs"},{"location":"CredentialAccess/AZT604/AZT604-1/#queries","text":"Platform Query Log Analytics AzureDiagnostics | where ResourceProvider == \"MICROSOFT.KEYVAULT\" and OperationName == \"SecretGet\" Additional Resources https://docs.microsoft.com/en-us/azure/key-vault/general/logging?WT.mc_id=Portal-fx&tabs=Vault","title":"Queries"},{"location":"CredentialAccess/AZT604/AZT604-2/","text":"AZT604.2 - Azure Key Vault Dumping: Azure Key Vault Certificate Dump # By accessing an Azure Key Vault, an adversary may dump any or all certificates. Resource Azure Key Vault Actions Microsoft.KeyVault/vaults/secrets/getSecret/action Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzKeyVaultCertificate az keyvault certificate GET { vaultBaseUrl } / certificates / { certificate - name } / { certificate - version } ? api - version = 7.3 Detections Detection Details # By default, logging is not enabled on Key Vaults, meaning whenever a secret/key/certificate is accessed, it will not be logged unless Key Vault logging is turned on. Logs # Data Source Operation Name Action Log Location Azure Diagnostics CertificateList N/A Log Analytics Azure Diagnostics SecretGet N/A Log Analytics Queries # Platform Query Log Analytics AzureDiagnostics | where ResourceProvider == \"MICROSOFT.KEYVAULT\" and OperationName == \"CertificateList\" or OperationName == \"SecretGet\" Additional Resources https://docs.microsoft.com/en-us/azure/key-vault/general/logging?WT.mc_id=Portal-fx&tabs=Vault","title":"AZT604.2 - Azure KeyVault Certificate Dump"},{"location":"CredentialAccess/AZT604/AZT604-2/#azt6042-azure-key-vault-dumping-azure-key-vault-certificate-dump","text":"By accessing an Azure Key Vault, an adversary may dump any or all certificates. Resource Azure Key Vault Actions Microsoft.KeyVault/vaults/secrets/getSecret/action Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzKeyVaultCertificate az keyvault certificate GET { vaultBaseUrl } / certificates / { certificate - name } / { certificate - version } ? api - version = 7.3 Detections","title":"AZT604.2 - Azure Key Vault Dumping: Azure Key Vault Certificate Dump"},{"location":"CredentialAccess/AZT604/AZT604-2/#detection-details","text":"By default, logging is not enabled on Key Vaults, meaning whenever a secret/key/certificate is accessed, it will not be logged unless Key Vault logging is turned on.","title":"Detection Details"},{"location":"CredentialAccess/AZT604/AZT604-2/#logs","text":"Data Source Operation Name Action Log Location Azure Diagnostics CertificateList N/A Log Analytics Azure Diagnostics SecretGet N/A Log Analytics","title":"Logs"},{"location":"CredentialAccess/AZT604/AZT604-2/#queries","text":"Platform Query Log Analytics AzureDiagnostics | where ResourceProvider == \"MICROSOFT.KEYVAULT\" and OperationName == \"CertificateList\" or OperationName == \"SecretGet\" Additional Resources https://docs.microsoft.com/en-us/azure/key-vault/general/logging?WT.mc_id=Portal-fx&tabs=Vault","title":"Queries"},{"location":"CredentialAccess/AZT604/AZT604-3/","text":"AZT604.3 - Azure Key Vault Dumping: Azure Key Vault Key Dump # By accessing an Azure Key Vault, an adversary may dump any or all public keys. Note that Private keys cannot be retrieved. Resource Azure Key Vault Actions Microsoft.KeyVault/vaults/keys/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzKeyVaultKey az keyvault key GET { vaultBaseUrl } / keys / { key - name } / { key - version } ? api - version = 7.3 Detections Detection Details # By default, logging is not enabled on Key Vaults, meaning whenever a secret/key/certificate is accessed, it will not be logged unless Key Vault logging is turned on. Logs # Data Source Operation Name Action Log Location Azure Diagnostics KeyList N/A Log Analytics Queries # Platform Query Log Analytics AzureDiagnostics | where ResourceProvider == \"MICROSOFT.KEYVAULT\" and OperationName == \"KeyList\" Additional Resources https://docs.microsoft.com/en-us/azure/key-vault/general/logging?WT.mc_id=Portal-fx&tabs=Vault","title":"AZT604.3 - Azure KeyVault Key Dump"},{"location":"CredentialAccess/AZT604/AZT604-3/#azt6043-azure-key-vault-dumping-azure-key-vault-key-dump","text":"By accessing an Azure Key Vault, an adversary may dump any or all public keys. Note that Private keys cannot be retrieved. Resource Azure Key Vault Actions Microsoft.KeyVault/vaults/keys/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzKeyVaultKey az keyvault key GET { vaultBaseUrl } / keys / { key - name } / { key - version } ? api - version = 7.3 Detections","title":"AZT604.3 - Azure Key Vault Dumping: Azure Key Vault Key Dump"},{"location":"CredentialAccess/AZT604/AZT604-3/#detection-details","text":"By default, logging is not enabled on Key Vaults, meaning whenever a secret/key/certificate is accessed, it will not be logged unless Key Vault logging is turned on.","title":"Detection Details"},{"location":"CredentialAccess/AZT604/AZT604-3/#logs","text":"Data Source Operation Name Action Log Location Azure Diagnostics KeyList N/A Log Analytics","title":"Logs"},{"location":"CredentialAccess/AZT604/AZT604-3/#queries","text":"Platform Query Log Analytics AzureDiagnostics | where ResourceProvider == \"MICROSOFT.KEYVAULT\" and OperationName == \"KeyList\" Additional Resources https://docs.microsoft.com/en-us/azure/key-vault/general/logging?WT.mc_id=Portal-fx&tabs=Vault","title":"Queries"},{"location":"CredentialAccess/AZT604/AZT604/","text":"AZT604 - Azure KeyVault Dumping # An adverary may access an Azure KeyVault in an attempt to view secrets, certificates, or keys. ID Name Description Action Resources AZT604.1 Azure KeyVault Secret Dump By accessing an Azure KeyVault, an adversary may dump any or all secrets. Microsoft.KeyVault/vaults/secrets/getSecret/action Azure KeyVault AZT604.2 Azure KeyVault Certificate Dump By accessing an Azure KeyVault, an adversary may dump any or all certificates. Microsoft.KeyVault/vaults/certificates/read Azure KeyVault AZT604.3 Azure KeyVault Key Dump By accessing an Azure KeyVault, an adversary may dump any or all keys. Microsoft.KeyVault/vaults/keys/read Azure KeyVault","title":"AZT604 - Azure KeyVault Dumping"},{"location":"CredentialAccess/AZT604/AZT604/#azt604-azure-keyvault-dumping","text":"An adverary may access an Azure KeyVault in an attempt to view secrets, certificates, or keys. ID Name Description Action Resources AZT604.1 Azure KeyVault Secret Dump By accessing an Azure KeyVault, an adversary may dump any or all secrets. Microsoft.KeyVault/vaults/secrets/getSecret/action Azure KeyVault AZT604.2 Azure KeyVault Certificate Dump By accessing an Azure KeyVault, an adversary may dump any or all certificates. Microsoft.KeyVault/vaults/certificates/read Azure KeyVault AZT604.3 Azure KeyVault Key Dump By accessing an Azure KeyVault, an adversary may dump any or all keys. Microsoft.KeyVault/vaults/keys/read Azure KeyVault","title":"AZT604 - Azure KeyVault Dumping"},{"location":"CredentialAccess/AZT605/AZT605-1/","text":"AZT605.1 - Resource Secret Reveal: Storage Account Access Key Dumping # By accessing a Storage Account, an adversary may dump access keys pertaining to the Storage Account, which will give them full access to the Storage Account. Resource Azure Storage Account Actions Microsoft.Storage/storageAccounts/listkeys/action Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzStorageAccountKey az storage account keys https : // { myaccount } . blob . core . windows . net / ? restype = service & comp = userdelegationkey Detections Logs # Data Source Operation Name Action Log Location Resource TBD TBD Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"TBD\" Additional Resources https://docs.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage?tabs=azure-portal","title":"AZT605.1 - Storage Account Access Key Dumping"},{"location":"CredentialAccess/AZT605/AZT605-1/#azt6051-resource-secret-reveal-storage-account-access-key-dumping","text":"By accessing a Storage Account, an adversary may dump access keys pertaining to the Storage Account, which will give them full access to the Storage Account. Resource Azure Storage Account Actions Microsoft.Storage/storageAccounts/listkeys/action Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzStorageAccountKey az storage account keys https : // { myaccount } . blob . core . windows . net / ? restype = service & comp = userdelegationkey Detections","title":"AZT605.1 - Resource Secret Reveal: Storage Account Access Key Dumping"},{"location":"CredentialAccess/AZT605/AZT605-1/#logs","text":"Data Source Operation Name Action Log Location Resource TBD TBD Azure Activity Log","title":"Logs"},{"location":"CredentialAccess/AZT605/AZT605-1/#queries","text":"Log Analytics |where OperationNameValue==\"TBD\" Additional Resources https://docs.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage?tabs=azure-portal","title":"Queries"},{"location":"CredentialAccess/AZT605/AZT605-2/","text":"AZT605.1 - Resource Secret Reveal: Automation Account Credential Secret Dump # By editing a Runbook, a credential configured in an Automation Account may be revealed Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/* Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook Set-AzAutomationRunbook az automation runbook PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Automation / automationAccounts / { automationAccountName } / runbooks / { runbookName } ? api - version = 2019 - 06 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage?tabs=azure-portal","title":"AZT605.2 - Automation Account Credential Secret Dump"},{"location":"CredentialAccess/AZT605/AZT605-2/#azt6051-resource-secret-reveal-automation-account-credential-secret-dump","text":"By editing a Runbook, a credential configured in an Automation Account may be revealed Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/* Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook Set-AzAutomationRunbook az automation runbook PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Automation / automationAccounts / { automationAccountName } / runbooks / { runbookName } ? api - version = 2019 - 06 - 01 Detections","title":"AZT605.1 - Resource Secret Reveal: Automation Account Credential Secret Dump"},{"location":"CredentialAccess/AZT605/AZT605-2/#logs","text":"Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log","title":"Logs"},{"location":"CredentialAccess/AZT605/AZT605-2/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage?tabs=azure-portal","title":"Queries"},{"location":"CredentialAccess/AZT605/AZT605-3/","text":"AZT605.3 - Resource Secret Reveal: Resource Group Deployment History Secret Dump # By accessing deployment history of a Resource Group, secrets used in the ARM template may be revealed. Resource Resource Group Actions Microsoft.Resources/deployments/read Microsoft.Resources/subscriptions/resourceGroups/read Examples Az PowerShell Azure CLI Azure Portal Get-AzResourceGroupDeployment az deployment group list az deployment group export 605.3.1 605.3.2 Detections Detection Details # When a template is used, the parameters from the template are reflected on the 'Input' page when viewing the deployment detail in the Azure portal. The parameter key value's are shown unless the key 'SecureString' is used. If 'SecureString' is not used, then the value will show in the deployment input details. Logs # Data Source Operation Name Action Log Location Resource N/A N/A Azure Activity Log Additional Resources https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/deployment-history?tabs=azure-portal","title":"AZT605.3 - Resource Group Deployment History Secret Dump"},{"location":"CredentialAccess/AZT605/AZT605-3/#azt6053-resource-secret-reveal-resource-group-deployment-history-secret-dump","text":"By accessing deployment history of a Resource Group, secrets used in the ARM template may be revealed. Resource Resource Group Actions Microsoft.Resources/deployments/read Microsoft.Resources/subscriptions/resourceGroups/read Examples Az PowerShell Azure CLI Azure Portal Get-AzResourceGroupDeployment az deployment group list az deployment group export 605.3.1 605.3.2 Detections","title":"AZT605.3 - Resource Secret Reveal: Resource Group Deployment History Secret Dump"},{"location":"CredentialAccess/AZT605/AZT605-3/#detection-details","text":"When a template is used, the parameters from the template are reflected on the 'Input' page when viewing the deployment detail in the Azure portal. The parameter key value's are shown unless the key 'SecureString' is used. If 'SecureString' is not used, then the value will show in the deployment input details.","title":"Detection Details"},{"location":"CredentialAccess/AZT605/AZT605-3/#logs","text":"Data Source Operation Name Action Log Location Resource N/A N/A Azure Activity Log Additional Resources https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/deployment-history?tabs=azure-portal","title":"Logs"},{"location":"CredentialAccess/AZT605/AZT605/","text":"AZT605 - Resource Secret Reveal # An adverary may access an Azure KeyVault in an attempt to view secrets, certificates, or keys. ID Name Description Action Resources .001 Storage Account Access Key Dumping By accessing a Storage Account, an adversary may dump access keys pertaining to the Storage Account, which will give them full access to the Storage Account. Microsoft.Storage/storageAccounts/listkeys/action Storage Account .002 Automation Account Credential Secret Dump By editing a Runbook, a credential configured in an Automation Account may be revealed Microsoft.Automation/automationAccounts/runbooks/* Automation Account .003 Resource Group Deployment History Secret Dump By accessing deployment history of a Resource Group, secrets used in the ARM template may be revealed. Microsoft.Resources/deployments/read Resource Group","title":"AZT605 - Resource Secret Reveal"},{"location":"CredentialAccess/AZT605/AZT605/#azt605-resource-secret-reveal","text":"An adverary may access an Azure KeyVault in an attempt to view secrets, certificates, or keys. ID Name Description Action Resources .001 Storage Account Access Key Dumping By accessing a Storage Account, an adversary may dump access keys pertaining to the Storage Account, which will give them full access to the Storage Account. Microsoft.Storage/storageAccounts/listkeys/action Storage Account .002 Automation Account Credential Secret Dump By editing a Runbook, a credential configured in an Automation Account may be revealed Microsoft.Automation/automationAccounts/runbooks/* Automation Account .003 Resource Group Deployment History Secret Dump By accessing deployment history of a Resource Group, secrets used in the ARM template may be revealed. Microsoft.Resources/deployments/read Resource Group","title":"AZT605 - Resource Secret Reveal"},{"location":"Execution/Execution/","text":"Execution # The adversary is trying to run malicious code. Execution in Azure consists of techniques that run code either through a managed device, virtual machine, or on an unmanaged host. Execution specifically is attributable to when malicious code is ran in an attempt to gain access to a host/device. ID Name Description AZT301 Virtual Machine Scripting Adversaries may abuse access to virtual machines by executing a script through various methods in order to gain access to the Virtual Machine. .001 RunCommand By utilizing the 'RunCommand' feature on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. .002 CustomScriptExtension By utilizing the 'CustomScriptExtension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. .003 Desired State Configuration By utilizing the 'Desired State Configuration extension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. .004 Compute Gallery Application By utilizing Compute Gallery Applications, an attacker can pass MS-DOS or PowerShell commands to the VM as SYSTEM. .005 AKS Command Invoke By utilizing 'command invoke' on an Azure Kubernetes Service (AKS) cluster, an attacker can pass commands to the cluster's VM as SYSTEM .006 Vmss Run Command By utilizing the 'RunCommand' feature on a virtual machine scale set (vmss), an attacker can execute a command on an instance of a VM as SYSTEM. .007 Serial Console By utilizing the serial console feature on an Azure Virtual Machine, an adversary can pass arbitrary commands. AZT302 Serverless Scripting Adversaries may abuse access to serverless resources that are able to execute PowerShell or Python scripts on an Azure Resource. .001 Automation Account Runbook Hybrid Worker Group By utilizing an Automation Account configured with a Hybrid Worker Group, an attacker can execute Azure commands on any Azure VM within that Hybrid Worker Group. .002 Automation Account Runbook RunAs Account By utilizing an Automation Account configured with a RunAs account, an attacker can execute commands on an Azure VM via RunCommand if that service principal has the correct role and privileges. .003 Automation Account Runbook Managed Identity By utilizing an Automation Account configured with a Managed Identity, an attacker can execute commands on an Azure VM via RunCommand if that service principal has the correct role and privileges. .004 Function Application By utilizing a Function Application, an attacker can execute Azure operations on a given resource. AZT303 Managed Device Scripting Adversaries may abuse access to any managed devices in AzureAD by executing PowerShell or Python scripts on them.","title":"Execution"},{"location":"Execution/Execution/#execution","text":"The adversary is trying to run malicious code. Execution in Azure consists of techniques that run code either through a managed device, virtual machine, or on an unmanaged host. Execution specifically is attributable to when malicious code is ran in an attempt to gain access to a host/device. ID Name Description AZT301 Virtual Machine Scripting Adversaries may abuse access to virtual machines by executing a script through various methods in order to gain access to the Virtual Machine. .001 RunCommand By utilizing the 'RunCommand' feature on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. .002 CustomScriptExtension By utilizing the 'CustomScriptExtension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. .003 Desired State Configuration By utilizing the 'Desired State Configuration extension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. .004 Compute Gallery Application By utilizing Compute Gallery Applications, an attacker can pass MS-DOS or PowerShell commands to the VM as SYSTEM. .005 AKS Command Invoke By utilizing 'command invoke' on an Azure Kubernetes Service (AKS) cluster, an attacker can pass commands to the cluster's VM as SYSTEM .006 Vmss Run Command By utilizing the 'RunCommand' feature on a virtual machine scale set (vmss), an attacker can execute a command on an instance of a VM as SYSTEM. .007 Serial Console By utilizing the serial console feature on an Azure Virtual Machine, an adversary can pass arbitrary commands. AZT302 Serverless Scripting Adversaries may abuse access to serverless resources that are able to execute PowerShell or Python scripts on an Azure Resource. .001 Automation Account Runbook Hybrid Worker Group By utilizing an Automation Account configured with a Hybrid Worker Group, an attacker can execute Azure commands on any Azure VM within that Hybrid Worker Group. .002 Automation Account Runbook RunAs Account By utilizing an Automation Account configured with a RunAs account, an attacker can execute commands on an Azure VM via RunCommand if that service principal has the correct role and privileges. .003 Automation Account Runbook Managed Identity By utilizing an Automation Account configured with a Managed Identity, an attacker can execute commands on an Azure VM via RunCommand if that service principal has the correct role and privileges. .004 Function Application By utilizing a Function Application, an attacker can execute Azure operations on a given resource. AZT303 Managed Device Scripting Adversaries may abuse access to any managed devices in AzureAD by executing PowerShell or Python scripts on them.","title":"Execution"},{"location":"Execution/AZT301/AZT301-1/","text":"AZT301.1 - Virtual Machine Scripting: RunCommand # By utilizing the 'RunCommand' feature on a Virtual Machine, an attacker can pass: Windows : PowerShell commands to the VM as SYSTEM. Linux : Shell commands to the VM as root. Resource Virtual Machine Actions Microsoft.Compute/virtualMachines/runCommand/action Microsoft.Compute/locations/runCommands/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Invoke-AzVMRunCommand az vm run-command POST https :// management . azure . com / subscriptions /{ sub id }/ resourceGroups /{ rg name }/ providers / Microsoft . Compute / virtualMachines /{ vm name }/ runCommand ? api-version = 2022 - 03 - 01 Detections Detection Details # Windows : The commands are stored as .PS1 files. Linux : The commands are stored as script.sh files. Logs # Data Source Operation Name Action Log Location Resource Run Command on Virtual Machine Microsoft.Compute/virtualMachines/runCommand/action Azure Activity Log On-Resource File (Windows) File Creation N/A C:\\Packages\\Plugins\\Microsoft.CPlat.Core.RunCommandWindows\\1.1.11\\Downloads On-Resource File (Windows) File Creation N/A C:\\Packages\\Plugins\\Microsoft.CPlat.Core.RunCommandWindows\\1.1.11\\Status On-Resource File (Linux) File Creation N/A /var/lib/waagent/run-command/download/ On-Resource File (Linux) File Creation N/A /var/lib/waagent/Microsoft.CPlat.Core.RunCommandLinux-1.0.3/status/ Queries # Log Analytics |where OperationNameValue==\"Microsoft.Compute/virtualMachines/runCommand/action\" Additional Resources https://docs.microsoft.com/en-us/azure/virtual-machines/windows/run-command https://docs.microsoft.com/en-us/azure/virtual-machines/linux/run-command https://stratus-red-team.cloud/attack-techniques/azure/azure.execution.vm-run-command/","title":"AZT301.1 - RunCommand"},{"location":"Execution/AZT301/AZT301-1/#azt3011-virtual-machine-scripting-runcommand","text":"By utilizing the 'RunCommand' feature on a Virtual Machine, an attacker can pass: Windows : PowerShell commands to the VM as SYSTEM. Linux : Shell commands to the VM as root. Resource Virtual Machine Actions Microsoft.Compute/virtualMachines/runCommand/action Microsoft.Compute/locations/runCommands/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Invoke-AzVMRunCommand az vm run-command POST https :// management . azure . com / subscriptions /{ sub id }/ resourceGroups /{ rg name }/ providers / Microsoft . Compute / virtualMachines /{ vm name }/ runCommand ? api-version = 2022 - 03 - 01 Detections","title":"AZT301.1 - Virtual Machine Scripting: RunCommand"},{"location":"Execution/AZT301/AZT301-1/#detection-details","text":"Windows : The commands are stored as .PS1 files. Linux : The commands are stored as script.sh files.","title":"Detection Details"},{"location":"Execution/AZT301/AZT301-1/#logs","text":"Data Source Operation Name Action Log Location Resource Run Command on Virtual Machine Microsoft.Compute/virtualMachines/runCommand/action Azure Activity Log On-Resource File (Windows) File Creation N/A C:\\Packages\\Plugins\\Microsoft.CPlat.Core.RunCommandWindows\\1.1.11\\Downloads On-Resource File (Windows) File Creation N/A C:\\Packages\\Plugins\\Microsoft.CPlat.Core.RunCommandWindows\\1.1.11\\Status On-Resource File (Linux) File Creation N/A /var/lib/waagent/run-command/download/ On-Resource File (Linux) File Creation N/A /var/lib/waagent/Microsoft.CPlat.Core.RunCommandLinux-1.0.3/status/","title":"Logs"},{"location":"Execution/AZT301/AZT301-1/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Compute/virtualMachines/runCommand/action\" Additional Resources https://docs.microsoft.com/en-us/azure/virtual-machines/windows/run-command https://docs.microsoft.com/en-us/azure/virtual-machines/linux/run-command https://stratus-red-team.cloud/attack-techniques/azure/azure.execution.vm-run-command/","title":"Queries"},{"location":"Execution/AZT301/AZT301-2/","text":"AZT301.2 - Virtual Machine Scripting: CustomScriptExtension # By utilizing the 'CustomScriptExtension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. Resource Virtual Machine Virtual Machine Scale Sets Azure ARC Actions Microsoft.Compute/virtualMachines/extensions/* Microsoft.Compute/virtualMachines/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzVMCustomScriptExtension az vm extension set PUT https :// management . azure . com / subscriptions /{ subscription-id }/ resourceGroups /{ rg name }/ providers / Microsoft . Compute / virtualMachines /{ vm name ]/ extensions / CustomScriptExtension ? api-version = 2022 - 03 - 01 Detections Detection Details # The commands are stored as .PS1 files and deleted after running. Logs # Data Source Operation Name Action Log Location Resource Create or Update Virtual Machine Extension Microsoft.Compute/virtualMachines/extensions/write Azure Activity Log On-Resource File File Creation N/A C:\\Packages\\Plugins\\Microsoft.Compute.CustomScriptExtension\\1.9.5\\Downloads On-Resource File File Creation N/A C:\\Packages\\Plugins\\Microsoft.Compute.CustomScriptExtension\\1.9.5\\Status Queries # Log Analytics |where OperationNameValue==\"Microsoft.Compute/virtualMachines/extensions/write\" Additional Resources https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/custom-script-windows https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/custom-script-linux https://stratus-red-team.cloud/attack-techniques/azure/azure.execution.vm-custom-script-extension/","title":"AZT301.2 - CustomScriptExtension"},{"location":"Execution/AZT301/AZT301-2/#azt3012-virtual-machine-scripting-customscriptextension","text":"By utilizing the 'CustomScriptExtension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. Resource Virtual Machine Virtual Machine Scale Sets Azure ARC Actions Microsoft.Compute/virtualMachines/extensions/* Microsoft.Compute/virtualMachines/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzVMCustomScriptExtension az vm extension set PUT https :// management . azure . com / subscriptions /{ subscription-id }/ resourceGroups /{ rg name }/ providers / Microsoft . Compute / virtualMachines /{ vm name ]/ extensions / CustomScriptExtension ? api-version = 2022 - 03 - 01 Detections","title":"AZT301.2 - Virtual Machine Scripting: CustomScriptExtension"},{"location":"Execution/AZT301/AZT301-2/#detection-details","text":"The commands are stored as .PS1 files and deleted after running.","title":"Detection Details"},{"location":"Execution/AZT301/AZT301-2/#logs","text":"Data Source Operation Name Action Log Location Resource Create or Update Virtual Machine Extension Microsoft.Compute/virtualMachines/extensions/write Azure Activity Log On-Resource File File Creation N/A C:\\Packages\\Plugins\\Microsoft.Compute.CustomScriptExtension\\1.9.5\\Downloads On-Resource File File Creation N/A C:\\Packages\\Plugins\\Microsoft.Compute.CustomScriptExtension\\1.9.5\\Status","title":"Logs"},{"location":"Execution/AZT301/AZT301-2/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Compute/virtualMachines/extensions/write\" Additional Resources https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/custom-script-windows https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/custom-script-linux https://stratus-red-team.cloud/attack-techniques/azure/azure.execution.vm-custom-script-extension/","title":"Queries"},{"location":"Execution/AZT301/AZT301-3/","text":"AZT301.3 - Virtual Machine Scripting: Desired State Configuration # By utilizing the 'Desired State Configuration extension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. Resource Virtual Machine Virtual Machine Scale Sets Actions Microsoft.Compute/virtualMachines/extensions/* Microsoft.Compute/virtualMachines/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzVMDscExtension az vm extension set PUT https :// management . azure . com / subscriptions /{ subscription-id }/ resourceGroups /{ rg name }/ providers / Microsoft . Compute / virtualMachines /{ vm name ]/ extensions / DSC ? api-version = 2022 - 03 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Create or Update Virtual Machine Extension Microsoft.Compute/virtualMachines/extensions/write Azure Activity Log On-Resource File File Creation N/A C:\\Packages\\Plugins\\Microsoft.Powershell.DSC\\2.83.2.0\\Status Queries # Log Analytics |where OperationNameValue==\"Microsoft.Compute/virtualMachines/extensions/write\" Additional Resources https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/dsc-overview","title":"AZT301.3 - Desired State Configuration"},{"location":"Execution/AZT301/AZT301-3/#azt3013-virtual-machine-scripting-desired-state-configuration","text":"By utilizing the 'Desired State Configuration extension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. Resource Virtual Machine Virtual Machine Scale Sets Actions Microsoft.Compute/virtualMachines/extensions/* Microsoft.Compute/virtualMachines/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzVMDscExtension az vm extension set PUT https :// management . azure . com / subscriptions /{ subscription-id }/ resourceGroups /{ rg name }/ providers / Microsoft . Compute / virtualMachines /{ vm name ]/ extensions / DSC ? api-version = 2022 - 03 - 01 Detections","title":"AZT301.3 - Virtual Machine Scripting: Desired State Configuration"},{"location":"Execution/AZT301/AZT301-3/#logs","text":"Data Source Operation Name Action Log Location Resource Create or Update Virtual Machine Extension Microsoft.Compute/virtualMachines/extensions/write Azure Activity Log On-Resource File File Creation N/A C:\\Packages\\Plugins\\Microsoft.Powershell.DSC\\2.83.2.0\\Status","title":"Logs"},{"location":"Execution/AZT301/AZT301-3/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Compute/virtualMachines/extensions/write\" Additional Resources https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/dsc-overview","title":"Queries"},{"location":"Execution/AZT301/AZT301-4/","text":"AZT301.4 - Virtual Machine Scripting: Compute Gallery Application # By utilizing Compute Gallery Applications, an attacker can pass MS-DOS or PowerShell commands to the VM as SYSTEM. Actions Microsoft.Compute/virtualMachines/write Microsoft.Compute/galleries/write Microsoft.Compute/galleries/applications/write Microsoft.Compute/galleries/applications/versions/write Resource Virtual Machine Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzGalleryApplication New-AzGalleryApplicationVersion az sig gallery-application create az sig image-version create PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Compute / galleries /{ galleryName }/ applications /{ galleryApplicationName } ? api-version = 2021 - 10 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Create or Update Gallery Application Version Microsoft.Compute/galleries/applications/versions/write Azure Activity Log Resource Create or Update Gallery Application Microsoft.Compute/galleries/applications/write Azure Portal Resource Create or Update Gallery Application Version Microsoft.Compute/galleries/applications/versions/write Azure Activity Log Resource Create or Update Gallery Application Version Microsoft.Compute/galleries/applications/versions/write Azure Activity Log On-Resource File File Creation N/A C:\\Packages\\Plugins\\Microsoft.Powershell.DSC\\2.83.2.0\\Status Queries # Log Analytics |where OperationNameValue==\"Microsoft.Compute/galleries/applications/versions/write\" Additional Resources https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications","title":"AZT301.4 - Compute Gallery Application"},{"location":"Execution/AZT301/AZT301-4/#azt3014-virtual-machine-scripting-compute-gallery-application","text":"By utilizing Compute Gallery Applications, an attacker can pass MS-DOS or PowerShell commands to the VM as SYSTEM. Actions Microsoft.Compute/virtualMachines/write Microsoft.Compute/galleries/write Microsoft.Compute/galleries/applications/write Microsoft.Compute/galleries/applications/versions/write Resource Virtual Machine Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzGalleryApplication New-AzGalleryApplicationVersion az sig gallery-application create az sig image-version create PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Compute / galleries /{ galleryName }/ applications /{ galleryApplicationName } ? api-version = 2021 - 10 - 01 Detections","title":"AZT301.4 - Virtual Machine Scripting: Compute Gallery Application"},{"location":"Execution/AZT301/AZT301-4/#logs","text":"Data Source Operation Name Action Log Location Resource Create or Update Gallery Application Version Microsoft.Compute/galleries/applications/versions/write Azure Activity Log Resource Create or Update Gallery Application Microsoft.Compute/galleries/applications/write Azure Portal Resource Create or Update Gallery Application Version Microsoft.Compute/galleries/applications/versions/write Azure Activity Log Resource Create or Update Gallery Application Version Microsoft.Compute/galleries/applications/versions/write Azure Activity Log On-Resource File File Creation N/A C:\\Packages\\Plugins\\Microsoft.Powershell.DSC\\2.83.2.0\\Status","title":"Logs"},{"location":"Execution/AZT301/AZT301-4/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Compute/galleries/applications/versions/write\" Additional Resources https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications","title":"Queries"},{"location":"Execution/AZT301/AZT301-5/","text":"AZT301.5 - Virtual Machine Scripting: AKS Command Invoke # By utilizing 'command invoke' on an Azure Kubernetes Service (AKS) cluster, an attacker can pass commands to the cluster's VM as SYSTEM Resource Azure Kubernetes Service Actions Microsoft.ContainerService/managedClusters/runcommand/action Microsoft.ContainerService/managedclusters/commandResults/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Invoke-AzAksRunCommand az aks command invoke POST https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . ContainerService / managedClusters /{ resourceName }/ runCommand ? api-version = 2022 - 04 - 01 Detections Detection Details # Logs are only generated when running a command through az cli or Az PowerShell. Using kubectl will not generate logs. Logs # Data Source Operation Name Action Log Location Resource RunCommand Microsoft.ContainerService/managedClusters/runCommand/action Azure Activity Log ## Queries Log Analytics |where OperationNameValue==\"Microsoft.ContainerService/managedClusters/runCommand/action\" Additional Resources https://docs.microsoft.com/en-us/azure/aks/command-invoke","title":"AZT301.5 - AKS Command Invoke"},{"location":"Execution/AZT301/AZT301-5/#azt3015-virtual-machine-scripting-aks-command-invoke","text":"By utilizing 'command invoke' on an Azure Kubernetes Service (AKS) cluster, an attacker can pass commands to the cluster's VM as SYSTEM Resource Azure Kubernetes Service Actions Microsoft.ContainerService/managedClusters/runcommand/action Microsoft.ContainerService/managedclusters/commandResults/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Invoke-AzAksRunCommand az aks command invoke POST https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . ContainerService / managedClusters /{ resourceName }/ runCommand ? api-version = 2022 - 04 - 01 Detections","title":"AZT301.5 - Virtual Machine Scripting: AKS Command Invoke"},{"location":"Execution/AZT301/AZT301-5/#detection-details","text":"Logs are only generated when running a command through az cli or Az PowerShell. Using kubectl will not generate logs.","title":"Detection Details"},{"location":"Execution/AZT301/AZT301-5/#logs","text":"Data Source Operation Name Action Log Location Resource RunCommand Microsoft.ContainerService/managedClusters/runCommand/action Azure Activity Log ## Queries Log Analytics |where OperationNameValue==\"Microsoft.ContainerService/managedClusters/runCommand/action\" Additional Resources https://docs.microsoft.com/en-us/azure/aks/command-invoke","title":"Logs"},{"location":"Execution/AZT301/AZT301-6/","text":"AZT301.6 - Virtual Machine Scripting: Vmss Run Command # By utilizing the 'RunCommand' feature on a virtual machine scale set (Vmss), an attacker can execute a command on an instance or instances of VMs as: Windows : PowerShell commands to the VM as SYSTEM. Linux : Shell commands to the VM as root. Resource Virtual Machine Scale Sets Actions Microsoft.Compute/virtualMachineScaleSets/virtualMachines/runCommand/action Examples Az PowerShell Azure CLI Azure REST API Invoke-AzVmssVMRunCommand az vmss run-command PATCH https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Compute / virtualMachineScaleSets /{ vmScaleSetName }/ virtualMachines /{ instanceId }/ runCommands /{ runCommandName } ? api-version = 2022 - 03 - 01 Detections Detection Details # Windows : The commands are stored as .PS1 files. Linux : The commands are stored as script.sh files. Logs # Data Source Operation Name Action Log Location Resource Run Command on a Virtual Machine instance in a Virtual Machine Scale Set Microsoft.Compute/virtualMachineScaleSets/virtualMachines/runCommand/action Azure Activity Log On-Resource File (Windows) File Creation N/A C:\\Packages\\Plugins\\Microsoft.CPlat.Core.RunCommandWindows\\1.1.11\\Downloads On-Resource File (Windows) File Creation N/A C:\\Packages\\Plugins\\Microsoft.CPlat.Core.RunCommandWindows\\1.1.11\\Status On-Resource File (Linux) File Creation N/A /var/lib/waagent/run-command/download/ On-Resource File (Linux) File Creation N/A /var/lib/waagent/Microsoft.CPlat.Core.RunCommandLinux-1.0.3/status/ Queries # Log Analytics |where OperationNameValue==\"Microsoft.Compute/virtualMachineScaleSets/virtualMachines/runCommand/action\" Additional Resources https://docs.microsoft.com/en-us/azure/virtual-machines/windows/run-command https://docs.microsoft.com/en-us/azure/virtual-machines/linux/run-command","title":"AZT301.6 - Vmss Run Command"},{"location":"Execution/AZT301/AZT301-6/#azt3016-virtual-machine-scripting-vmss-run-command","text":"By utilizing the 'RunCommand' feature on a virtual machine scale set (Vmss), an attacker can execute a command on an instance or instances of VMs as: Windows : PowerShell commands to the VM as SYSTEM. Linux : Shell commands to the VM as root. Resource Virtual Machine Scale Sets Actions Microsoft.Compute/virtualMachineScaleSets/virtualMachines/runCommand/action Examples Az PowerShell Azure CLI Azure REST API Invoke-AzVmssVMRunCommand az vmss run-command PATCH https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Compute / virtualMachineScaleSets /{ vmScaleSetName }/ virtualMachines /{ instanceId }/ runCommands /{ runCommandName } ? api-version = 2022 - 03 - 01 Detections","title":"AZT301.6 - Virtual Machine Scripting: Vmss Run Command"},{"location":"Execution/AZT301/AZT301-6/#detection-details","text":"Windows : The commands are stored as .PS1 files. Linux : The commands are stored as script.sh files.","title":"Detection Details"},{"location":"Execution/AZT301/AZT301-6/#logs","text":"Data Source Operation Name Action Log Location Resource Run Command on a Virtual Machine instance in a Virtual Machine Scale Set Microsoft.Compute/virtualMachineScaleSets/virtualMachines/runCommand/action Azure Activity Log On-Resource File (Windows) File Creation N/A C:\\Packages\\Plugins\\Microsoft.CPlat.Core.RunCommandWindows\\1.1.11\\Downloads On-Resource File (Windows) File Creation N/A C:\\Packages\\Plugins\\Microsoft.CPlat.Core.RunCommandWindows\\1.1.11\\Status On-Resource File (Linux) File Creation N/A /var/lib/waagent/run-command/download/ On-Resource File (Linux) File Creation N/A /var/lib/waagent/Microsoft.CPlat.Core.RunCommandLinux-1.0.3/status/","title":"Logs"},{"location":"Execution/AZT301/AZT301-6/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Compute/virtualMachineScaleSets/virtualMachines/runCommand/action\" Additional Resources https://docs.microsoft.com/en-us/azure/virtual-machines/windows/run-command https://docs.microsoft.com/en-us/azure/virtual-machines/linux/run-command","title":"Queries"},{"location":"Execution/AZT301/AZT301-7/","text":"AZT301.1 - Virtual Machine Scripting: Serial Console # By utilizing the serial console feature on an Azure Virtual Machine, an adversary can pass arbitrary commands. Resource Virtual Machine Actions Microsoft.SerialConsole/serialPorts/connect/action Examples Azure Portal Detections Detection Details # Commands are passed directly via COM1 port to the virtual machine. Logging requires boot diagnostics to be enabled. Logs # Data Source Operation Name Action Log Location Resource N/A N/A Boot Diagnostics Additional Resources https://docs.microsoft.com/en-us/troubleshoot/azure/virtual-machines/serial-console-overview","title":"AZT301.7 - Serial Console"},{"location":"Execution/AZT301/AZT301-7/#azt3011-virtual-machine-scripting-serial-console","text":"By utilizing the serial console feature on an Azure Virtual Machine, an adversary can pass arbitrary commands. Resource Virtual Machine Actions Microsoft.SerialConsole/serialPorts/connect/action Examples Azure Portal Detections","title":"AZT301.1 - Virtual Machine Scripting: Serial Console"},{"location":"Execution/AZT301/AZT301-7/#detection-details","text":"Commands are passed directly via COM1 port to the virtual machine. Logging requires boot diagnostics to be enabled.","title":"Detection Details"},{"location":"Execution/AZT301/AZT301-7/#logs","text":"Data Source Operation Name Action Log Location Resource N/A N/A Boot Diagnostics Additional Resources https://docs.microsoft.com/en-us/troubleshoot/azure/virtual-machines/serial-console-overview","title":"Logs"},{"location":"Execution/AZT301/AZT301/","text":"AZT301 - Virtual Machine Scripting # Adversaries may abuse access to virtual machines by executing a script through various methods in order to gain access to the Virtual Machine. ID Name Description Action Resources AZT301.1 RunCommand By utilizing the 'RunCommand' feature on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. Microsoft.Compute/virtualMachines/runCommand/action Virtual Machine Microsoft.Compute/locations/runCommands/read AZT301.2 CustomScriptExtension By utilizing the 'CustomScriptExtension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. Microsoft.Compute/virtualMachines/extensions/* Virtual Machine Microsoft.Compute/virtualMachines/write AZT301.3 Desired State Configuration By utilizing the 'Desired State Configuration extension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. Microsoft.Compute/virtualMachines/extensions/* Virtual Machine Microsoft.Compute/virtualMachines/write AZT301.4 Compute Gallery Application By utilizing Compute Gallery Applications, an attacker can pass MS-DOS or PowerShell commands to the VM as SYSTEM. Microsoft.Compute/virtualMachines/write Virtual Machine, Compute Gallery Microsoft.Compute/galleries/write Microsoft.Compute/galleries/applications/write Microsoft.Compute/galleries/applications/versions/write AZT301.5 AKS Command Invoke By utilizing 'command invoke' on an Azure Kubernetes Service (AKS) cluster, an attacker can pass commands to the cluster's VM as SYSTEM Microsoft.ContainerService/managedClusters/runcommand/action Azure Kubernetes Services Microsoft.ContainerService/managedclusters/commandResults/read AZT301.6 Vmss Run Command By utilizing the 'RunCommand' feature on a virtual machine scale set (vmss), an attacker can execute a command on an instance of a VM as SYSTEM Microsoft.Compute/virtualMachineScaleSets/virtualMachines/runCommand/action Virtual Machine Scale Sets AZT301.7 Serial Console By utilizing the serial console feature on an Azure Virtual Machine, an adversary can pass arbitrary commands. Microsoft.SerialConsole/serialPorts/connect/action Virtual Machine","title":"AZT301 - Virtual Machine Scripting"},{"location":"Execution/AZT301/AZT301/#azt301-virtual-machine-scripting","text":"Adversaries may abuse access to virtual machines by executing a script through various methods in order to gain access to the Virtual Machine. ID Name Description Action Resources AZT301.1 RunCommand By utilizing the 'RunCommand' feature on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. Microsoft.Compute/virtualMachines/runCommand/action Virtual Machine Microsoft.Compute/locations/runCommands/read AZT301.2 CustomScriptExtension By utilizing the 'CustomScriptExtension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. Microsoft.Compute/virtualMachines/extensions/* Virtual Machine Microsoft.Compute/virtualMachines/write AZT301.3 Desired State Configuration By utilizing the 'Desired State Configuration extension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM. Microsoft.Compute/virtualMachines/extensions/* Virtual Machine Microsoft.Compute/virtualMachines/write AZT301.4 Compute Gallery Application By utilizing Compute Gallery Applications, an attacker can pass MS-DOS or PowerShell commands to the VM as SYSTEM. Microsoft.Compute/virtualMachines/write Virtual Machine, Compute Gallery Microsoft.Compute/galleries/write Microsoft.Compute/galleries/applications/write Microsoft.Compute/galleries/applications/versions/write AZT301.5 AKS Command Invoke By utilizing 'command invoke' on an Azure Kubernetes Service (AKS) cluster, an attacker can pass commands to the cluster's VM as SYSTEM Microsoft.ContainerService/managedClusters/runcommand/action Azure Kubernetes Services Microsoft.ContainerService/managedclusters/commandResults/read AZT301.6 Vmss Run Command By utilizing the 'RunCommand' feature on a virtual machine scale set (vmss), an attacker can execute a command on an instance of a VM as SYSTEM Microsoft.Compute/virtualMachineScaleSets/virtualMachines/runCommand/action Virtual Machine Scale Sets AZT301.7 Serial Console By utilizing the serial console feature on an Azure Virtual Machine, an adversary can pass arbitrary commands. Microsoft.SerialConsole/serialPorts/connect/action Virtual Machine","title":"AZT301 - Virtual Machine Scripting"},{"location":"Execution/AZT302/AZT302-1/","text":"AZT302.1 - Unmanaged Scripting: Automation Account Hybrid Worker Group # By utilizing an Automation Account configured with a Hybrid Worker Group, an attacker can execute Azure commands on any Azure VM within that Hybrid Worker Group. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/draft/write Microsoft.Automation/automationAccounts/runbooks/write Microsoft.Automation/automationAccounts/runbooks/publish/action Microsoft.Automation/automationAccounts/jobs/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook az automation runbook create PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Automation / automationAccounts /{ automationAccountName }/ runbooks /{ runbookName } ? api-version = 2019 - 06 - 01 Detections Detection Details # It is recommended to turn on verbose logging for Automation Accounts. Logs # Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log On Target Resource File (Windows) File Creation N/A C:\\Packages\\Plugins\\Microsoft.Azure.Automation.HybridWorker.HybridWorkerForWindows\\0.1.0.18\\Status Queries # Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution","title":"AZT302.1 - Automation Account Runbook Hybrid Worker Group"},{"location":"Execution/AZT302/AZT302-1/#azt3021-unmanaged-scripting-automation-account-hybrid-worker-group","text":"By utilizing an Automation Account configured with a Hybrid Worker Group, an attacker can execute Azure commands on any Azure VM within that Hybrid Worker Group. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/draft/write Microsoft.Automation/automationAccounts/runbooks/write Microsoft.Automation/automationAccounts/runbooks/publish/action Microsoft.Automation/automationAccounts/jobs/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook az automation runbook create PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Automation / automationAccounts /{ automationAccountName }/ runbooks /{ runbookName } ? api-version = 2019 - 06 - 01 Detections","title":"AZT302.1 - Unmanaged Scripting: Automation Account Hybrid Worker Group"},{"location":"Execution/AZT302/AZT302-1/#detection-details","text":"It is recommended to turn on verbose logging for Automation Accounts.","title":"Detection Details"},{"location":"Execution/AZT302/AZT302-1/#logs","text":"Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log On Target Resource File (Windows) File Creation N/A C:\\Packages\\Plugins\\Microsoft.Azure.Automation.HybridWorker.HybridWorkerForWindows\\0.1.0.18\\Status","title":"Logs"},{"location":"Execution/AZT302/AZT302-1/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution","title":"Queries"},{"location":"Execution/AZT302/AZT302-2/","text":"AZT302.3 - Unmanaged Scripting: Automation Account RunAs Account # By utilizing an Automation Account configured with a RunAs account, an attacker can execute commands on an Azure VM via RunCommand (AZT301.1) if that service principal has the correct role and privileges. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/* Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook az automation runbook create PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Automation / automationAccounts /{ automationAccountName }/ runbooks /{ runbookName } ? api-version = 2019 - 06 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution","title":"AZT302.2 - Automation Account Runbook RunAs Account"},{"location":"Execution/AZT302/AZT302-2/#azt3023-unmanaged-scripting-automation-account-runas-account","text":"By utilizing an Automation Account configured with a RunAs account, an attacker can execute commands on an Azure VM via RunCommand (AZT301.1) if that service principal has the correct role and privileges. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/* Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook az automation runbook create PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Automation / automationAccounts /{ automationAccountName }/ runbooks /{ runbookName } ? api-version = 2019 - 06 - 01 Detections","title":"AZT302.3 - Unmanaged Scripting: Automation Account RunAs Account"},{"location":"Execution/AZT302/AZT302-2/#logs","text":"Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log","title":"Logs"},{"location":"Execution/AZT302/AZT302-2/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution","title":"Queries"},{"location":"Execution/AZT302/AZT302-3/","text":"AZT302.3 - Unmanaged Scripting: Automation Account Managed Identity Account # By utilizing an Automation Account configured with a Managed Identity, an attacker can execute commands on an Azure VM via RunCommand (AZT301.1) if that service principal has the correct role and privileges. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/* Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook az automation runbook create PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Automation / automationAccounts /{ automationAccountName }/ runbooks /{ runbookName } ? api-version = 2019 - 06 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution","title":"AZT302.3 - Automation Account Runbook Managed Identity"},{"location":"Execution/AZT302/AZT302-3/#azt3023-unmanaged-scripting-automation-account-managed-identity-account","text":"By utilizing an Automation Account configured with a Managed Identity, an attacker can execute commands on an Azure VM via RunCommand (AZT301.1) if that service principal has the correct role and privileges. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/* Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook az automation runbook create PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Automation / automationAccounts /{ automationAccountName }/ runbooks /{ runbookName } ? api-version = 2019 - 06 - 01 Detections","title":"AZT302.3 - Unmanaged Scripting: Automation Account Managed Identity Account"},{"location":"Execution/AZT302/AZT302-3/#logs","text":"Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log","title":"Logs"},{"location":"Execution/AZT302/AZT302-3/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution","title":"Queries"},{"location":"Execution/AZT302/AZT302-4/","text":"AZT302.4 - Unmanaged Scripting: Function Application # By utilizing a Function Application, an attacker can execute Azure operations on a given resource. Resource Automation Account Actions Microsoft.Web/sites/hostruntime/vfs/run.csx/write Microsoft.Web/sites/functions/write Microsoft.Web/sites/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Update-AzFunctionApp az functionapp update GET https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Web / sites /{ name }/ functions ? api-version = 2021 - 02 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Write Run.csx Microsoft.Web/sites/hostruntime/vfs/run.csx/write Azure Activity Log Resource Update Web Apps Functions Microsoft.Web/sites/functions/write Azure Activity Log Resource Update website Microsoft.Web/sites/write Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Web/sites/hostruntime/vfs/run.csx/write\" or OperationNameValue==\"Microsoft.Web/sites/functions/write\" or OperationNameValue==\"Microsoft.Web/sites/write\" Additional Resources https://docs.microsoft.com/en-us/azure/azure-functions/functions-get-started?pivots=programming-language-powershell","title":"AZT302.4 - Function Application"},{"location":"Execution/AZT302/AZT302-4/#azt3024-unmanaged-scripting-function-application","text":"By utilizing a Function Application, an attacker can execute Azure operations on a given resource. Resource Automation Account Actions Microsoft.Web/sites/hostruntime/vfs/run.csx/write Microsoft.Web/sites/functions/write Microsoft.Web/sites/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Update-AzFunctionApp az functionapp update GET https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Web / sites /{ name }/ functions ? api-version = 2021 - 02 - 01 Detections","title":"AZT302.4 - Unmanaged Scripting: Function Application"},{"location":"Execution/AZT302/AZT302-4/#logs","text":"Data Source Operation Name Action Log Location Resource Write Run.csx Microsoft.Web/sites/hostruntime/vfs/run.csx/write Azure Activity Log Resource Update Web Apps Functions Microsoft.Web/sites/functions/write Azure Activity Log Resource Update website Microsoft.Web/sites/write Azure Activity Log","title":"Logs"},{"location":"Execution/AZT302/AZT302-4/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Web/sites/hostruntime/vfs/run.csx/write\" or OperationNameValue==\"Microsoft.Web/sites/functions/write\" or OperationNameValue==\"Microsoft.Web/sites/write\" Additional Resources https://docs.microsoft.com/en-us/azure/azure-functions/functions-get-started?pivots=programming-language-powershell","title":"Queries"},{"location":"Execution/AZT302/AZT302/","text":"AZT302 - Unmanaged Scripting # Adversaries may abuse access to serverless resources that are able to execute PowerShell or Python scripts on an Azure resource. ID Name Description Action Resources AZT302.1 Automation Account Hybrid Worker Group By utilizing an Automation Account configured with a Hybrid Worker Group, an attacker can execute Azure commands on any Azure VM within that Hybrid Worker Group. Microsoft.Automation/automationAccounts/runbooks/* Automation Account AZT302.2 Automation Account Runbook RunAs Account By utilizing an Automation Account configured with a RunAs account, an attacker can execute commands on an Azure VM via RunCommand (AZT301.1) if that service principal has the correct role and privileges. Microsoft.Automation/automationAccounts/runbooks/* Automation Account AZT302.3 Automation Account Runbook Managed Identity By utilizing an Automation Account configured with a Managed Identity, an attacker can execute commands on an Azure VM via RunCommand (AZT301.1) if that service principal has the correct role and privileges. Microsoft.Automation/automationAccounts/runbooks/* Automation Account AZT302.4 Function Application By utilizing a Function Application, an attacker can execute Azure operations on a given resource. Microsoft.Web/sites/hostruntime/host/action Function App","title":"AZT302 - Serverless Scripting"},{"location":"Execution/AZT302/AZT302/#azt302-unmanaged-scripting","text":"Adversaries may abuse access to serverless resources that are able to execute PowerShell or Python scripts on an Azure resource. ID Name Description Action Resources AZT302.1 Automation Account Hybrid Worker Group By utilizing an Automation Account configured with a Hybrid Worker Group, an attacker can execute Azure commands on any Azure VM within that Hybrid Worker Group. Microsoft.Automation/automationAccounts/runbooks/* Automation Account AZT302.2 Automation Account Runbook RunAs Account By utilizing an Automation Account configured with a RunAs account, an attacker can execute commands on an Azure VM via RunCommand (AZT301.1) if that service principal has the correct role and privileges. Microsoft.Automation/automationAccounts/runbooks/* Automation Account AZT302.3 Automation Account Runbook Managed Identity By utilizing an Automation Account configured with a Managed Identity, an attacker can execute commands on an Azure VM via RunCommand (AZT301.1) if that service principal has the correct role and privileges. Microsoft.Automation/automationAccounts/runbooks/* Automation Account AZT302.4 Function Application By utilizing a Function Application, an attacker can execute Azure operations on a given resource. Microsoft.Web/sites/hostruntime/host/action Function App","title":"AZT302 - Unmanaged Scripting"},{"location":"Execution/AZT303/AZT303/","text":"AZT303 - Managed Device Scripting # Adversaries may abuse access to any managed devices in AzureAD by executing PowerShell or Python scripts on them. Resource Azure Active Directory Intune Actions microsoft.directory/devices/basic/update Examples Microsoft Azure Graph API Azure Portal POST https :// graph . microsoft . com / beta / deviceManagement / deviceManagementScripts Detections Logs # Data Source Operation Name Action Log Location InTune Write Run.csx Microsoft.Web/sites/hostruntime/vfs/run.csx/write Tenant Admin Audit Logs InTune Update Web Apps Functions Microsoft.Web/sites/functions/write Tenant Admin Audit Logs InTune Update website Microsoft.Web/sites/write Tenant Admin Audit Logs Additional Resources https://docs.microsoft.com/en-us/mem/intune/apps/intune-management-extension https://docs.microsoft.com/en-us/graph/api/resources/intune-graph-overview?view=graph-rest-beta","title":"AZT303 - Managed Device Scripting"},{"location":"Execution/AZT303/AZT303/#azt303-managed-device-scripting","text":"Adversaries may abuse access to any managed devices in AzureAD by executing PowerShell or Python scripts on them. Resource Azure Active Directory Intune Actions microsoft.directory/devices/basic/update Examples Microsoft Azure Graph API Azure Portal POST https :// graph . microsoft . com / beta / deviceManagement / deviceManagementScripts Detections","title":"AZT303 - Managed Device Scripting"},{"location":"Execution/AZT303/AZT303/#logs","text":"Data Source Operation Name Action Log Location InTune Write Run.csx Microsoft.Web/sites/hostruntime/vfs/run.csx/write Tenant Admin Audit Logs InTune Update Web Apps Functions Microsoft.Web/sites/functions/write Tenant Admin Audit Logs InTune Update website Microsoft.Web/sites/write Tenant Admin Audit Logs Additional Resources https://docs.microsoft.com/en-us/mem/intune/apps/intune-management-extension https://docs.microsoft.com/en-us/graph/api/resources/intune-graph-overview?view=graph-rest-beta","title":"Logs"},{"location":"Exfiltration/Exfiltration/","text":"Exfiltration # The adversary is trying to steal data. Exfiltration in Azure consists of using techniques to lift resource data from specific resources. This can be done by generating SAS URIs for unauthenticated & persistent downloads, or can be done by directly exfiltrating the data from the resource itself. ID Name Description AZT701 SAS URI Generation By generating an SAS URI for a resource, an adversary may extract the contents of that resource without authentication at any time. .001 VM Disk SAS URI An adversary may create an SAS URI to download the disk attached to a virtual machine. .002 Storage Account File Share SAS By generating a Shared Access Signature (SAS) URI, an adversary can access a container in a Storage Account at any time. AZT702 File Share Mounting An adversary may attach an Azure resource as a file share .001 Storage Account File Share NFS/SMB Mount An adversary can generate a connection string to mount an Azure Storage Account File Share as an NFS or SMB share to their local machine. AZT703 Replication An adversary may exfiltrate data by replicating it. .001 Storage Account Replication By setting up cross-tenant replication, an adversary may set up replication from one tenant's storage account to an extrenal tenant's storage account. AZT704 Soft-Delete Recovery An adversary may leverage resources found at a 'soft deletion' state, restore them and advance their attack by retrieving contents meant to be deleted .001 Key Vault An adversary may recover a key vault object found in a 'soft deletion' state. .002 Storage Blob An adversary may recover a storage blob found in a 'soft deletion' state. .003 Virtual Machine An adversary may recover a virtual machine found in a 'soft deletion' state.","title":"Exfiltration"},{"location":"Exfiltration/Exfiltration/#exfiltration","text":"The adversary is trying to steal data. Exfiltration in Azure consists of using techniques to lift resource data from specific resources. This can be done by generating SAS URIs for unauthenticated & persistent downloads, or can be done by directly exfiltrating the data from the resource itself. ID Name Description AZT701 SAS URI Generation By generating an SAS URI for a resource, an adversary may extract the contents of that resource without authentication at any time. .001 VM Disk SAS URI An adversary may create an SAS URI to download the disk attached to a virtual machine. .002 Storage Account File Share SAS By generating a Shared Access Signature (SAS) URI, an adversary can access a container in a Storage Account at any time. AZT702 File Share Mounting An adversary may attach an Azure resource as a file share .001 Storage Account File Share NFS/SMB Mount An adversary can generate a connection string to mount an Azure Storage Account File Share as an NFS or SMB share to their local machine. AZT703 Replication An adversary may exfiltrate data by replicating it. .001 Storage Account Replication By setting up cross-tenant replication, an adversary may set up replication from one tenant's storage account to an extrenal tenant's storage account. AZT704 Soft-Delete Recovery An adversary may leverage resources found at a 'soft deletion' state, restore them and advance their attack by retrieving contents meant to be deleted .001 Key Vault An adversary may recover a key vault object found in a 'soft deletion' state. .002 Storage Blob An adversary may recover a storage blob found in a 'soft deletion' state. .003 Virtual Machine An adversary may recover a virtual machine found in a 'soft deletion' state.","title":"Exfiltration"},{"location":"Exfiltration/AZT701/AZT701-1/","text":"AZT701.1 - SAS URI Generation: VM Disk SAS URI # An adversary may create an SAS URI to download the disk attached to a virtual machine. Resource Virutal Machine Disk Actions Microsoft.Compute/disks/beginGetAccess/action Examples Az PowerShell Azure CLI Azure Portal New-AzureStorageBlobSASToken New-AzStorageContainerSASToken az storage blob generate - sas Detections Logs # Data Source Operation Name Action Log Location Resource Get Disk SAS URI Microsoft.Compute/disks/BeginGetAccess/action Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Compute/disks/BeginGetAccess/action\" Additional Resources https://docs.microsoft.com/en-us/azure/marketplace/azure-vm-get-sas-uri","title":"AZT701.1 - VM Disk SAS URI"},{"location":"Exfiltration/AZT701/AZT701-1/#azt7011-sas-uri-generation-vm-disk-sas-uri","text":"An adversary may create an SAS URI to download the disk attached to a virtual machine. Resource Virutal Machine Disk Actions Microsoft.Compute/disks/beginGetAccess/action Examples Az PowerShell Azure CLI Azure Portal New-AzureStorageBlobSASToken New-AzStorageContainerSASToken az storage blob generate - sas Detections","title":"AZT701.1 - SAS URI Generation: VM Disk SAS URI"},{"location":"Exfiltration/AZT701/AZT701-1/#logs","text":"Data Source Operation Name Action Log Location Resource Get Disk SAS URI Microsoft.Compute/disks/BeginGetAccess/action Azure Activity Log","title":"Logs"},{"location":"Exfiltration/AZT701/AZT701-1/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Compute/disks/BeginGetAccess/action\" Additional Resources https://docs.microsoft.com/en-us/azure/marketplace/azure-vm-get-sas-uri","title":"Queries"},{"location":"Exfiltration/AZT701/AZT701-2/","text":"AZT701.2 - SAS URI Generation: Storage Account File Share SAS # By generating a Shared Access Signature (SAS) URI, an adversary can access a container in a Storage Account at any time. Resource Azure Storage Account Actions Microsoft.Storage/storageAccounts/listAccountSas/action Examples Az PowerShell Azure CLI Azure Portal New-AzureStorageBlobSASToken New-AzStorageContainerSASToken az storage blob generate - sas Detections No logs are created when creating a SAS URI in an Azure Storage Account. Additional Resources https://docs.microsoft.com/en-us/azure/storage/common/storage-sas-overview","title":"AZT701.2 - Storage Account File Share SAS"},{"location":"Exfiltration/AZT701/AZT701-2/#azt7012-sas-uri-generation-storage-account-file-share-sas","text":"By generating a Shared Access Signature (SAS) URI, an adversary can access a container in a Storage Account at any time. Resource Azure Storage Account Actions Microsoft.Storage/storageAccounts/listAccountSas/action Examples Az PowerShell Azure CLI Azure Portal New-AzureStorageBlobSASToken New-AzStorageContainerSASToken az storage blob generate - sas Detections No logs are created when creating a SAS URI in an Azure Storage Account. Additional Resources https://docs.microsoft.com/en-us/azure/storage/common/storage-sas-overview","title":"AZT701.2 - SAS URI Generation: Storage Account File Share SAS"},{"location":"Exfiltration/AZT701/AZT701/","text":"AZT701 - SAS URI Generation # By generating an SAS URI for a resource, an adversary may extract the contents of that resource without authentication at any time. ID Name Description Action Resources AZT701.1 VM Disk SAS URI An adversary may create an SAS URI to download a VM disk attached to a virtual machine. Microsoft.Compute/disks/beginGetAccess/action Virtual Machine Disk AZT701.2 Storage Account File Share SAS By generating a Shared Access Signature (SAS) URI, an adversary can access a container in a Storage Account at any time. Microsoft.Storage/storageAccounts/listAccountSas/action Azure Storage Account","title":"AZT701 - SAS URI Generation"},{"location":"Exfiltration/AZT701/AZT701/#azt701-sas-uri-generation","text":"By generating an SAS URI for a resource, an adversary may extract the contents of that resource without authentication at any time. ID Name Description Action Resources AZT701.1 VM Disk SAS URI An adversary may create an SAS URI to download a VM disk attached to a virtual machine. Microsoft.Compute/disks/beginGetAccess/action Virtual Machine Disk AZT701.2 Storage Account File Share SAS By generating a Shared Access Signature (SAS) URI, an adversary can access a container in a Storage Account at any time. Microsoft.Storage/storageAccounts/listAccountSas/action Azure Storage Account","title":"AZT701 - SAS URI Generation"},{"location":"Exfiltration/AZT702/AZT702-1/","text":"AZT702.1 - File Share Mounting: Storage Account File Share NFS/SMB Mount # An adversary can generate a connection string to mount an Azure Storage Account File Share as an NFS or SMB share to their local machine. Resource Azure Storage Account Actions Microsoft.Storage/storageAccounts/fileServices/shares/write Examples Azure Portal Detections Connection logs to the share are not generated in Azure. Additional Resources https://docs.microsoft.com/en-us/azure/storage/files/files-smb-protocol?tabs=azure-portal","title":"AZT702 - File Share Mounting"},{"location":"Exfiltration/AZT702/AZT702-1/#azt7021-file-share-mounting-storage-account-file-share-nfssmb-mount","text":"An adversary can generate a connection string to mount an Azure Storage Account File Share as an NFS or SMB share to their local machine. Resource Azure Storage Account Actions Microsoft.Storage/storageAccounts/fileServices/shares/write Examples Azure Portal Detections Connection logs to the share are not generated in Azure. Additional Resources https://docs.microsoft.com/en-us/azure/storage/files/files-smb-protocol?tabs=azure-portal","title":"AZT702.1 - File Share Mounting: Storage Account File Share NFS/SMB Mount"},{"location":"Exfiltration/AZT703/AZT703-1/","text":"AZT703.1 - Replication: Storage Account Replication # By setting up cross-tenant replication, an adversary may set up replication from one tenant's storage account to an extrenal tenant's storage account. Resource Azure Storage Account Actions Microsoft.Storage/storageAccounts/write Examples Az PowerShell Azure CLI Azure Portal New-AzStorageObjectReplicationPolicyRule az storage account or - policy rule add Detections Detection Details # A policy can be created to alert when replication is set up. Logs # Data Source Operation Name Action Log Location Resource Put Object Replication Policy Microsoft.Storage/storageAccounts/objectReplicationPolicies/write Azure Activity Log Queries # |where OperationNameValue==\"Microsoft.Storage/storageAccounts/objectReplicationPolicies/write\" Additional Resources https://docs.microsoft.com/en-us/azure/storage/blobs/object-replication-configure?tabs=portal https://docs.microsoft.com/en-us/azure/storage/blobs/object-replication-prevent-cross-tenant-policies?tabs=portal","title":"AZT703 - Replication"},{"location":"Exfiltration/AZT703/AZT703-1/#azt7031-replication-storage-account-replication","text":"By setting up cross-tenant replication, an adversary may set up replication from one tenant's storage account to an extrenal tenant's storage account. Resource Azure Storage Account Actions Microsoft.Storage/storageAccounts/write Examples Az PowerShell Azure CLI Azure Portal New-AzStorageObjectReplicationPolicyRule az storage account or - policy rule add Detections","title":"AZT703.1 - Replication: Storage Account Replication"},{"location":"Exfiltration/AZT703/AZT703-1/#detection-details","text":"A policy can be created to alert when replication is set up.","title":"Detection Details"},{"location":"Exfiltration/AZT703/AZT703-1/#logs","text":"Data Source Operation Name Action Log Location Resource Put Object Replication Policy Microsoft.Storage/storageAccounts/objectReplicationPolicies/write Azure Activity Log","title":"Logs"},{"location":"Exfiltration/AZT703/AZT703-1/#queries","text":"|where OperationNameValue==\"Microsoft.Storage/storageAccounts/objectReplicationPolicies/write\" Additional Resources https://docs.microsoft.com/en-us/azure/storage/blobs/object-replication-configure?tabs=portal https://docs.microsoft.com/en-us/azure/storage/blobs/object-replication-prevent-cross-tenant-policies?tabs=portal","title":"Queries"},{"location":"Exfiltration/AZT704/AZT704-1/","text":"AZT704.1 - Soft-Delete Recovery: Key Vault # An adversary may recover a key vault object found in a 'soft deletion' state. Resource Azure Key Vault Actions Microsoft.KeyVault/vaults/*/restore Microsoft.KeyVault/locations/deletedVaults/read Examples Az PowerShell Azure CLI Azure Portal Undo-AzKeyVaultRemoval Undo-AzKeyVaultSecretRemoval Undo-AzKeyVaultKeyRemoval Undo-AzKeyVaultCertificateRemoval az keyvault certificate recover az keyvault key recover az keyvault secret recover az keyvault recover Detections Logs # Data Source Operation Name Action Log Location Resource TBD TBD Log Analytics Additional Resources https://docs.microsoft.com/en-us/azure/key-vault/general/soft-delete-overview","title":"AZT704.1 - Key Vault"},{"location":"Exfiltration/AZT704/AZT704-1/#azt7041-soft-delete-recovery-key-vault","text":"An adversary may recover a key vault object found in a 'soft deletion' state. Resource Azure Key Vault Actions Microsoft.KeyVault/vaults/*/restore Microsoft.KeyVault/locations/deletedVaults/read Examples Az PowerShell Azure CLI Azure Portal Undo-AzKeyVaultRemoval Undo-AzKeyVaultSecretRemoval Undo-AzKeyVaultKeyRemoval Undo-AzKeyVaultCertificateRemoval az keyvault certificate recover az keyvault key recover az keyvault secret recover az keyvault recover Detections","title":"AZT704.1 - Soft-Delete Recovery: Key Vault"},{"location":"Exfiltration/AZT704/AZT704-1/#logs","text":"Data Source Operation Name Action Log Location Resource TBD TBD Log Analytics Additional Resources https://docs.microsoft.com/en-us/azure/key-vault/general/soft-delete-overview","title":"Logs"},{"location":"Exfiltration/AZT704/AZT704-2/","text":"AZT704.2 - Soft-Delete Recovery: Storage Account Object # An adversary may recover a storage account object found in a 'soft deletion' state. Resource Azure Storage Account Actions Microsoft.Storage/storageAccounts/blobServices/ \\/ Examples Azure REST API Azure Portal Invoke-RESTMethod -Uri https://myaccount.blob.core.windows.net/mycontainer/myblob?comp=undelete -Method PUT Invoke-RESTMethod -Uri https://myaccount.blob.core.windows.net/destinationcontainer?restype=container&comp=undelete -Method PUT Detections Logs # Data Source Operation Name Action Log Location Resource TBD TBD Log Analytics Additional Resources https://docs.microsoft.com/en-us/azure/storage/blobs/soft-delete-blob-overview","title":"AZT704.2 - Storage Account Object"},{"location":"Exfiltration/AZT704/AZT704-2/#azt7042-soft-delete-recovery-storage-account-object","text":"An adversary may recover a storage account object found in a 'soft deletion' state. Resource Azure Storage Account Actions Microsoft.Storage/storageAccounts/blobServices/ \\/ Examples Azure REST API Azure Portal Invoke-RESTMethod -Uri https://myaccount.blob.core.windows.net/mycontainer/myblob?comp=undelete -Method PUT Invoke-RESTMethod -Uri https://myaccount.blob.core.windows.net/destinationcontainer?restype=container&comp=undelete -Method PUT Detections","title":"AZT704.2 - Soft-Delete Recovery: Storage Account Object"},{"location":"Exfiltration/AZT704/AZT704-2/#logs","text":"Data Source Operation Name Action Log Location Resource TBD TBD Log Analytics Additional Resources https://docs.microsoft.com/en-us/azure/storage/blobs/soft-delete-blob-overview","title":"Logs"},{"location":"Exfiltration/AZT704/AZT704-3/","text":"AZT704.1 - Soft-Delete Recovery: Recovery Services Vault # An adversary may recover a virtual machine object found in a 'soft deletion' state. Resource Azure Recovery Services Vault Actions Microsoft.RecoveryServices/Vaults/backupconfig/write Examples Az PowerShell Azure REST API Azure Portal Undo-AzRecoveryServicesBackupItemDeletion Invoke-RESTMethod -body $body -Method PUT -Uri 'https://management.azure.com/Subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/testVaultRG/providers/Microsoft.RecoveryServices/vaults/testVault/backupFabrics/Azure/protectionContainers/iaasvmcontainer;iaasvmcontainerv2;testRG;testVM/protectedItems/vm;iaasvmcontainerv2;testRG;testVM?api-version=2019-05-13' $Body = { \"properties\" : { \"protectedItemType\" : \"Microsoft.Compute/virtualMachines\" , \"protectionState\" : \"ProtectionStopped\" , \"sourceResourceId\" : \"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/testRG/providers/Microsoft.Compute/virtualMachines/testVM\" , \"isRehydrate\" : true } } Detections Logs # Data Source Operation Name Action Log Location Resource TBD TBD Log Analytics Additional Resources https://docs.microsoft.com/en-us/powershell/module/az.recoveryservices/undo-azrecoveryservicesbackupitemdeletion?view=azps-8.2.0","title":"AZT704.3 - Recovery Services Vault"},{"location":"Exfiltration/AZT704/AZT704-3/#azt7041-soft-delete-recovery-recovery-services-vault","text":"An adversary may recover a virtual machine object found in a 'soft deletion' state. Resource Azure Recovery Services Vault Actions Microsoft.RecoveryServices/Vaults/backupconfig/write Examples Az PowerShell Azure REST API Azure Portal Undo-AzRecoveryServicesBackupItemDeletion Invoke-RESTMethod -body $body -Method PUT -Uri 'https://management.azure.com/Subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/testVaultRG/providers/Microsoft.RecoveryServices/vaults/testVault/backupFabrics/Azure/protectionContainers/iaasvmcontainer;iaasvmcontainerv2;testRG;testVM/protectedItems/vm;iaasvmcontainerv2;testRG;testVM?api-version=2019-05-13' $Body = { \"properties\" : { \"protectedItemType\" : \"Microsoft.Compute/virtualMachines\" , \"protectionState\" : \"ProtectionStopped\" , \"sourceResourceId\" : \"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/testRG/providers/Microsoft.Compute/virtualMachines/testVM\" , \"isRehydrate\" : true } } Detections","title":"AZT704.1 - Soft-Delete Recovery: Recovery Services Vault"},{"location":"Exfiltration/AZT704/AZT704-3/#logs","text":"Data Source Operation Name Action Log Location Resource TBD TBD Log Analytics Additional Resources https://docs.microsoft.com/en-us/powershell/module/az.recoveryservices/undo-azrecoveryservicesbackupitemdeletion?view=azps-8.2.0","title":"Logs"},{"location":"Exfiltration/AZT704/AZT704/","text":"AZT704 - Soft-Delete Recovery # An adversary may leverage resources found at a 'soft deletion' state, restore them and advance their attack by retrieving contents meant to be deleted ID Name Description Action Resources AZT704.1 Key Vault An adversary may recover a key vault object found in a 'soft deletion' state. Microsoft.KeyVault/vaults//restore Key Vault AZT704.2 Storage Account Object An adversary may recover a storage account object found in a 'soft deletion' state. Microsoft.Storage/storageAccounts/blobServices/ \\/ Azure Storage Account AZT704.3 Recovery Services Vault An adversary may recover a virtual machine object found in a 'soft deletion' state. Microsoft.RecoveryServices/Vaults/backupconfig/write Azure Recovery Services Vault","title":"AZT704 - Soft-Delete Recovery"},{"location":"Exfiltration/AZT704/AZT704/#azt704-soft-delete-recovery","text":"An adversary may leverage resources found at a 'soft deletion' state, restore them and advance their attack by retrieving contents meant to be deleted ID Name Description Action Resources AZT704.1 Key Vault An adversary may recover a key vault object found in a 'soft deletion' state. Microsoft.KeyVault/vaults//restore Key Vault AZT704.2 Storage Account Object An adversary may recover a storage account object found in a 'soft deletion' state. Microsoft.Storage/storageAccounts/blobServices/ \\/ Azure Storage Account AZT704.3 Recovery Services Vault An adversary may recover a virtual machine object found in a 'soft deletion' state. Microsoft.RecoveryServices/Vaults/backupconfig/write Azure Recovery Services Vault","title":"AZT704 - Soft-Delete Recovery"},{"location":"InitialAccess/InitialAccess/","text":"Initial Access # The adversary is attempting to gain access to an Azure Resource or Azure AD. ID Name Description AZT201 Valid Credentials Adversaries may login to AzureAD using valid credentials. .001 User Account By obtaining valid user credentials, an adversary may login to AzureAD via command line or through the Azure Portal. .002 Service Principal By obtaining a valid secret or certificate, an adversary may login to AzureAD via command line. AZT202 Password Spraying An adversary may potentially gain access to AzureAD by guessing a common password for multiple users. AZT203 Malicious Application Consent An adversary may lure a victim into giving their access to a malicious application registered in AzureAD.","title":"Initial Access"},{"location":"InitialAccess/InitialAccess/#initial-access","text":"The adversary is attempting to gain access to an Azure Resource or Azure AD. ID Name Description AZT201 Valid Credentials Adversaries may login to AzureAD using valid credentials. .001 User Account By obtaining valid user credentials, an adversary may login to AzureAD via command line or through the Azure Portal. .002 Service Principal By obtaining a valid secret or certificate, an adversary may login to AzureAD via command line. AZT202 Password Spraying An adversary may potentially gain access to AzureAD by guessing a common password for multiple users. AZT203 Malicious Application Consent An adversary may lure a victim into giving their access to a malicious application registered in AzureAD.","title":"Initial Access"},{"location":"InitialAccess/AZT201/AZT201-1/","text":"AZT201.1 - User Account # By obtaining valid user credentials, an adversary may login to AzureAD via command line or through the Azure Portal. Resource Azure Active Directory Actions N/A Examples Az PowerShell (Secret) Azure CLI Connect-AzAccount az login -u < username > -p < password > Detections Logs # Data Source Application Resource Log Location Azure Active Directory Azure Portal Windows Azure Service Management API Sign-in Logs Azure Active Directory Microsoft Azure PowerShell Windows Azure Service Management API Sign-in Logs Queries # Log Analytics SigninLogs|where Status ==\"{\\\"errorCode\\\":0}\" and ResourceDisplayName==\"Windows Azure Service Management API\" Detection Screenshots # Portal Sign-in PowerShell Sign-in Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-sign-ins","title":"AZT201.1 - User Account"},{"location":"InitialAccess/AZT201/AZT201-1/#azt2011-user-account","text":"By obtaining valid user credentials, an adversary may login to AzureAD via command line or through the Azure Portal. Resource Azure Active Directory Actions N/A Examples Az PowerShell (Secret) Azure CLI Connect-AzAccount az login -u < username > -p < password > Detections","title":"AZT201.1 - User Account"},{"location":"InitialAccess/AZT201/AZT201-1/#logs","text":"Data Source Application Resource Log Location Azure Active Directory Azure Portal Windows Azure Service Management API Sign-in Logs Azure Active Directory Microsoft Azure PowerShell Windows Azure Service Management API Sign-in Logs","title":"Logs"},{"location":"InitialAccess/AZT201/AZT201-1/#queries","text":"Log Analytics SigninLogs|where Status ==\"{\\\"errorCode\\\":0}\" and ResourceDisplayName==\"Windows Azure Service Management API\"","title":"Queries"},{"location":"InitialAccess/AZT201/AZT201-1/#detection-screenshots","text":"Portal Sign-in PowerShell Sign-in Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-sign-ins","title":"Detection Screenshots"},{"location":"InitialAccess/AZT201/AZT201-2/","text":"AZT201.2 - Service Principal # By obtaining a valid secret or certificate, an adversary may login to AzureAD via command line. Resource Azure Active Directory Actions N/A Examples Az PowerShell (Secret) Az PowerShell (Certificate) Azure CLI $Credential = New-Object -TypeName System . Management . Automation . PSCredential -ArgumentList $ApplicationId , $SecurePassword Connect-AzAccount -Credential $Credential -Tenant '$Context.Tenant.Id' -ServicePrincipal $import = Import-PfxCertificate -FilePath $CertPath -CertStoreLocation Cert :\\ LocalMachine \\ My -Password $SecurePassword -Exportable Connect-AzAccount -CertificateThumbprint \"$thumbprint\" -ApplicationId \"$appID\" -Tenant \"$tenant\" az login - -service-principal -u < app-id > -p < password -or -cert > - -tenant < tenant > Detections Logs # Data Source Application Resource Log Location Azure Active Directory {Service Principal's Application ID} Windows Azure Service Management API Sign-in Logs Queries # Log Analytics SigninLogs|where Status ==\"{\\\"errorCode\\\":0}\" and ResourceDisplayName==\"Windows Azure Service Management API\" Detection Screenshots # Additional Resources https://docs.microsoft.com/en-us/powershell/module/az.accounts/connect-azaccount?view=azps-8.0.0 https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-sign-ins https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli#sign-in-with-a-service-principal","title":"AZT201.2 - Service Principal"},{"location":"InitialAccess/AZT201/AZT201-2/#azt2012-service-principal","text":"By obtaining a valid secret or certificate, an adversary may login to AzureAD via command line. Resource Azure Active Directory Actions N/A Examples Az PowerShell (Secret) Az PowerShell (Certificate) Azure CLI $Credential = New-Object -TypeName System . Management . Automation . PSCredential -ArgumentList $ApplicationId , $SecurePassword Connect-AzAccount -Credential $Credential -Tenant '$Context.Tenant.Id' -ServicePrincipal $import = Import-PfxCertificate -FilePath $CertPath -CertStoreLocation Cert :\\ LocalMachine \\ My -Password $SecurePassword -Exportable Connect-AzAccount -CertificateThumbprint \"$thumbprint\" -ApplicationId \"$appID\" -Tenant \"$tenant\" az login - -service-principal -u < app-id > -p < password -or -cert > - -tenant < tenant > Detections","title":"AZT201.2 - Service Principal"},{"location":"InitialAccess/AZT201/AZT201-2/#logs","text":"Data Source Application Resource Log Location Azure Active Directory {Service Principal's Application ID} Windows Azure Service Management API Sign-in Logs","title":"Logs"},{"location":"InitialAccess/AZT201/AZT201-2/#queries","text":"Log Analytics SigninLogs|where Status ==\"{\\\"errorCode\\\":0}\" and ResourceDisplayName==\"Windows Azure Service Management API\"","title":"Queries"},{"location":"InitialAccess/AZT201/AZT201-2/#detection-screenshots","text":"Additional Resources https://docs.microsoft.com/en-us/powershell/module/az.accounts/connect-azaccount?view=azps-8.0.0 https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-sign-ins https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli#sign-in-with-a-service-principal","title":"Detection Screenshots"},{"location":"InitialAccess/AZT201/AZT201/","text":"AZT201 - Valid Credentials # Adversaries may login to AzureAD using valid credentials. By logging in with valid credentials to an account or service principal, the adversary will assume all privileges of that account or service principal. If the account is privileged, this may lead to other tactics, such as persistence or privilege escalation. ID Name Description Action Resources AZT201.1 User Account By obtaining valid user credentials, an adversary may login to AzureAD via command line or through the Azure Portal. N/A AzureAD AZT201.2 Service Principal By obtaining a valid secret or certificate, an adversary may login to AzureAD via command line. N/A AzureAD","title":"AZT201 - Valid Credentials"},{"location":"InitialAccess/AZT201/AZT201/#azt201-valid-credentials","text":"Adversaries may login to AzureAD using valid credentials. By logging in with valid credentials to an account or service principal, the adversary will assume all privileges of that account or service principal. If the account is privileged, this may lead to other tactics, such as persistence or privilege escalation. ID Name Description Action Resources AZT201.1 User Account By obtaining valid user credentials, an adversary may login to AzureAD via command line or through the Azure Portal. N/A AzureAD AZT201.2 Service Principal By obtaining a valid secret or certificate, an adversary may login to AzureAD via command line. N/A AzureAD","title":"AZT201 - Valid Credentials"},{"location":"InitialAccess/AZT202/AZT202/","text":"AZT202 - Password Spraying # An adversary may potentially gain access to AzureAD by guessing a common password for multiple users. Resource Azure Active Directory Actions N/A Examples Az PowerShell (Secret) Azure CLI Connect-AzAccount az login -u < username > -p < password > Detections Logs # Data Source Application Resource Log Location Azure Active Directory Azure Portal Windows Azure Service Management API Sign-in Logs Azure Active Directory Microsoft Azure PowerShell Windows Azure Service Management API Sign-in Logs Detection Screenshots # Detection Notes # The main difference between a successful and unsuccessful login is the 'Status' field, which will designate a \"Success\" or \"Failure\". Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-sign-ins https://docs.microsoft.com/en-us/security/compass/incident-response-playbook-password-spray https://docs.microsoft.com/en-us/graph/api/resources/azure-ad-auditlog-overview?view=graph-rest-1.0","title":"AZT202 - Password Spraying"},{"location":"InitialAccess/AZT202/AZT202/#azt202-password-spraying","text":"An adversary may potentially gain access to AzureAD by guessing a common password for multiple users. Resource Azure Active Directory Actions N/A Examples Az PowerShell (Secret) Azure CLI Connect-AzAccount az login -u < username > -p < password > Detections","title":"AZT202 - Password Spraying"},{"location":"InitialAccess/AZT202/AZT202/#logs","text":"Data Source Application Resource Log Location Azure Active Directory Azure Portal Windows Azure Service Management API Sign-in Logs Azure Active Directory Microsoft Azure PowerShell Windows Azure Service Management API Sign-in Logs","title":"Logs"},{"location":"InitialAccess/AZT202/AZT202/#detection-screenshots","text":"","title":"Detection Screenshots"},{"location":"InitialAccess/AZT202/AZT202/#detection-notes","text":"The main difference between a successful and unsuccessful login is the 'Status' field, which will designate a \"Success\" or \"Failure\". Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-sign-ins https://docs.microsoft.com/en-us/security/compass/incident-response-playbook-password-spray https://docs.microsoft.com/en-us/graph/api/resources/azure-ad-auditlog-overview?view=graph-rest-1.0","title":"Detection Notes"},{"location":"InitialAccess/AZT203/AZT203/","text":"AZT203 - Malicious Application Consent # An adversary may lure a victim into giving their access to a malicious application registered in AzureAD. Resource Azure Active Directory Actions Any user can consent to an application which will impersonate that user's privileges. Examples N/A Detections Logs # Data Source Application Resource Log Location Azure Active Directory N/A AAD Log Analytics Queries # Log Analytics AuditLogs| where ActivityDisplayName == \"Consent to application\" Detection Details # Please review the incident response playbooks in the 'Additional Resources' section below. Additional Resources https://docs.microsoft.com/en-us/security/compass/incident-response-playbook-compromised-malicious-app https://docs.microsoft.com/en-us/security/compass/incident-response-playbook-app-consent","title":"AZT203 - Malicious Application Consent"},{"location":"InitialAccess/AZT203/AZT203/#azt203-malicious-application-consent","text":"An adversary may lure a victim into giving their access to a malicious application registered in AzureAD. Resource Azure Active Directory Actions Any user can consent to an application which will impersonate that user's privileges. Examples N/A Detections","title":"AZT203 - Malicious Application Consent"},{"location":"InitialAccess/AZT203/AZT203/#logs","text":"Data Source Application Resource Log Location Azure Active Directory N/A AAD Log Analytics","title":"Logs"},{"location":"InitialAccess/AZT203/AZT203/#queries","text":"Log Analytics AuditLogs| where ActivityDisplayName == \"Consent to application\"","title":"Queries"},{"location":"InitialAccess/AZT203/AZT203/#detection-details","text":"Please review the incident response playbooks in the 'Additional Resources' section below. Additional Resources https://docs.microsoft.com/en-us/security/compass/incident-response-playbook-compromised-malicious-app https://docs.microsoft.com/en-us/security/compass/incident-response-playbook-app-consent","title":"Detection Details"},{"location":"Persistence/Persistence/","text":"Persistence # The adversary is trying to persist in the Azure tenant or subscription. Persistence consists of techniques that adversaries use to modify existing resources, or modify and manipulate accounts in order to access Azure Active Directory. ID Name Description AZT501 Account Manipulation An adverary may manipulate an account to maintain access in an Azure tenant AZT501.1 User Account Manipulation An adverary may manipulate a user account to maintain access in an Azure tenant AZT501.2 Service Principal Manipulation An adverary may manipulate a service principal to maintain access in an Azure tenant AZT501.3 Azure VM Local Administrator Manipulation An adverary may manipulate the local admin account on an Azure VM AZT502 Account Creation An adversary may create an account in Azure Active Directory. AZT502.1 User Account Creation An adversary may create a user account in Azure Active Directory. AZT502.2 Service Principal Creation An adversary may create an application & service principal in Azure Active Directory AZT502.3 Guest Account Creation An adversary may create a guest account in Azure Active Directory AZT503 HTTP Trigger Adversaries may configure a resource with an HTTP trigger to run commands without needing authentication. AZT503.1 Logic Application HTTP Trigger Adversaries may configure a Logic Application with an HTTP trigger to run commands without needing authentication. AZT503.2 Function App HTTP Trigger Adversaries may configure a Function App with an HTTP trigger to run commands without needing authentication. AZT503.3 Runbook Webhook Adversaries may create a webhook to a Runbook which allows unauthenticated access into an Azure subscription or tenant. AZT503.4 WebJob Adversaries may create a WebJob on a App Service which allows arbitrary background tasks to be run on a set schedule AZT504 Watcher Tasks By configurating a watcher task and a Runbook, an adversary can establish persistence by executing the Runbook on a triggered event. AZT505 Scheduled Jobs By configurating an Azure resource that supports scheduled execution, an adversary can execute an operation at a defined interval. AZT505.1 Runbook Schedules Adversaries may create a schedule for a Runbook to run at a defined interval. AZT506 Network Security Group Modification Adversaries can modify the rules in a Network Security Group to establish access over additional ports. AZT507 External Entity Access Adversaries may configure the target Azure tenant to be managed by another, externel tenant, or its users. AZT507.1 Azure Lighthouse Adversaries may utilize Azure Lighthouse to manage the target tenant from an external tenant. AZT507.2 Microsoft Partners Adversaries may use Delegated Administrative Privileges to give themselves administrator access to the target tenant. AZT507.3 Subscription Hijack An adversary may transfer a subscription from a target tenant to an attacker-controlled tenant. AZT507.4 Domain Trust Modification An adversary may add an additional identity provider or domain to maintain a backdoor into the tenant. AZT508 Azure Policy By configuring a policy with the 'DeployIfNotExists' definition, an adverary may establish persistence by creating a backdoor when the policy is triggered.","title":"Persistence"},{"location":"Persistence/Persistence/#persistence","text":"The adversary is trying to persist in the Azure tenant or subscription. Persistence consists of techniques that adversaries use to modify existing resources, or modify and manipulate accounts in order to access Azure Active Directory. ID Name Description AZT501 Account Manipulation An adverary may manipulate an account to maintain access in an Azure tenant AZT501.1 User Account Manipulation An adverary may manipulate a user account to maintain access in an Azure tenant AZT501.2 Service Principal Manipulation An adverary may manipulate a service principal to maintain access in an Azure tenant AZT501.3 Azure VM Local Administrator Manipulation An adverary may manipulate the local admin account on an Azure VM AZT502 Account Creation An adversary may create an account in Azure Active Directory. AZT502.1 User Account Creation An adversary may create a user account in Azure Active Directory. AZT502.2 Service Principal Creation An adversary may create an application & service principal in Azure Active Directory AZT502.3 Guest Account Creation An adversary may create a guest account in Azure Active Directory AZT503 HTTP Trigger Adversaries may configure a resource with an HTTP trigger to run commands without needing authentication. AZT503.1 Logic Application HTTP Trigger Adversaries may configure a Logic Application with an HTTP trigger to run commands without needing authentication. AZT503.2 Function App HTTP Trigger Adversaries may configure a Function App with an HTTP trigger to run commands without needing authentication. AZT503.3 Runbook Webhook Adversaries may create a webhook to a Runbook which allows unauthenticated access into an Azure subscription or tenant. AZT503.4 WebJob Adversaries may create a WebJob on a App Service which allows arbitrary background tasks to be run on a set schedule AZT504 Watcher Tasks By configurating a watcher task and a Runbook, an adversary can establish persistence by executing the Runbook on a triggered event. AZT505 Scheduled Jobs By configurating an Azure resource that supports scheduled execution, an adversary can execute an operation at a defined interval. AZT505.1 Runbook Schedules Adversaries may create a schedule for a Runbook to run at a defined interval. AZT506 Network Security Group Modification Adversaries can modify the rules in a Network Security Group to establish access over additional ports. AZT507 External Entity Access Adversaries may configure the target Azure tenant to be managed by another, externel tenant, or its users. AZT507.1 Azure Lighthouse Adversaries may utilize Azure Lighthouse to manage the target tenant from an external tenant. AZT507.2 Microsoft Partners Adversaries may use Delegated Administrative Privileges to give themselves administrator access to the target tenant. AZT507.3 Subscription Hijack An adversary may transfer a subscription from a target tenant to an attacker-controlled tenant. AZT507.4 Domain Trust Modification An adversary may add an additional identity provider or domain to maintain a backdoor into the tenant. AZT508 Azure Policy By configuring a policy with the 'DeployIfNotExists' definition, an adverary may establish persistence by creating a backdoor when the policy is triggered.","title":"Persistence"},{"location":"Persistence/AZT501/AZT501-1/","text":"AZT501.1 - Account Manipulation: User Account Manipulation # An adverary may manipulate a user account to maintain access in an Azure tenant Resource Azure Active Directory Actions microsoft.directory/users/password/update microsoft.directory/users/enable microsoft.directory/users/restore Examples Az PowerShell Azure CLI Microsoft Graph API Azure Portal Update-AzADUser az ad user update PATCH https :// graph . microsoft . com / v1 . 0 / users /{ id } Detections Logs # Data Source Operation Name Action Log Location Azure Active Directory Reset password microsoft.directory/users/password/update AzureAD Audit Logs Azure Active Directory Enable account microsoft.directory/users/enable AzureAD Audit Logs Azure Active Directory Update user microsoft.directory/users/password/update AzureAD Audit Logs Queries # Log Analytics AuditLogs |where OperationName ==\"Reset password\" or OperationName ==\"Enable account\" or OperationName ==\"Update user\" Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-users-reset-password-azure-portal","title":"AZT501.1 - User Account Manipulation"},{"location":"Persistence/AZT501/AZT501-1/#azt5011-account-manipulation-user-account-manipulation","text":"An adverary may manipulate a user account to maintain access in an Azure tenant Resource Azure Active Directory Actions microsoft.directory/users/password/update microsoft.directory/users/enable microsoft.directory/users/restore Examples Az PowerShell Azure CLI Microsoft Graph API Azure Portal Update-AzADUser az ad user update PATCH https :// graph . microsoft . com / v1 . 0 / users /{ id } Detections","title":"AZT501.1 - Account Manipulation: User Account Manipulation"},{"location":"Persistence/AZT501/AZT501-1/#logs","text":"Data Source Operation Name Action Log Location Azure Active Directory Reset password microsoft.directory/users/password/update AzureAD Audit Logs Azure Active Directory Enable account microsoft.directory/users/enable AzureAD Audit Logs Azure Active Directory Update user microsoft.directory/users/password/update AzureAD Audit Logs","title":"Logs"},{"location":"Persistence/AZT501/AZT501-1/#queries","text":"Log Analytics AuditLogs |where OperationName ==\"Reset password\" or OperationName ==\"Enable account\" or OperationName ==\"Update user\" Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-users-reset-password-azure-portal","title":"Queries"},{"location":"Persistence/AZT501/AZT501-2/","text":"AZT501.2 - Account Manipulation: Service Principal Manipulation # An adverary may manipulate a service principal to maintain access in an Azure tenant Resource Azure Active Directory Actions microsoft.directory/servicePrincipals/enable microsoft.directory/servicePrincipals/credentials/update microsoft.directory/servicePrincipals/owners/update Examples Az PowerShell Azure CLI Microsoft Graph API Azure Portal Update-AzADServicePrincipal az ad sp update PATCH https :// graph . microsoft . com / v1 . 0 / servicePrincipals /{ id } Detections Logs # Data Source Operation Name Action Log Location Azure Active Directory Update application \u2013 Certificates and secrets management microsoft.directory/servicePrincipals/credentials/update AzureAD Audit Logs Azure Active Directory Update service principal microsoft.directory/servicePrincipals/credentials/update AzureAD Audit Logs Azure Active Directory Update user microsoft.directory/users/password/update AzureAD Audit Logs Queries # Log Analytics |where OperationName ==\"Update application \u2013 Certificates and secrets management\" or OperationName ==\"Update service principal\" or OperationName ==\"Update user\" Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals","title":"AZT501.2 - Service Principal Manipulation"},{"location":"Persistence/AZT501/AZT501-2/#azt5012-account-manipulation-service-principal-manipulation","text":"An adverary may manipulate a service principal to maintain access in an Azure tenant Resource Azure Active Directory Actions microsoft.directory/servicePrincipals/enable microsoft.directory/servicePrincipals/credentials/update microsoft.directory/servicePrincipals/owners/update Examples Az PowerShell Azure CLI Microsoft Graph API Azure Portal Update-AzADServicePrincipal az ad sp update PATCH https :// graph . microsoft . com / v1 . 0 / servicePrincipals /{ id } Detections","title":"AZT501.2 - Account Manipulation: Service Principal Manipulation"},{"location":"Persistence/AZT501/AZT501-2/#logs","text":"Data Source Operation Name Action Log Location Azure Active Directory Update application \u2013 Certificates and secrets management microsoft.directory/servicePrincipals/credentials/update AzureAD Audit Logs Azure Active Directory Update service principal microsoft.directory/servicePrincipals/credentials/update AzureAD Audit Logs Azure Active Directory Update user microsoft.directory/users/password/update AzureAD Audit Logs","title":"Logs"},{"location":"Persistence/AZT501/AZT501-2/#queries","text":"Log Analytics |where OperationName ==\"Update application \u2013 Certificates and secrets management\" or OperationName ==\"Update service principal\" or OperationName ==\"Update user\" Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals","title":"Queries"},{"location":"Persistence/AZT501/AZT501-3/","text":"AZT501.3 - Account Manipulation: Azure VM Local Administrator Manipulation # An adverary may manipulate the local admin account on an Azure VM Resource Azure Active Directory Actions microsoft.compute/virtualMachines/extensions/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzVMAccessExtension az vm extension set PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Compute / virtualMachines /{ vmName }/ extensions /{ vmExtensionName } ? api-version = 2022 - 03 - 01 Detections Detection Details # After a successful reset, the log 'Validate Deployment' will be created. Specifically, in the scope, a password reset will be mentioned \"VMAccessWindowsPasswordReset\". Logs # Data Source Operation Name Action Log Location Resource Create or Udpate Virutal Machine Extension microsoft.compute/virtualMachines/extensions/write Azure Activity Log Resource Validate Deployment Microsoft.Resources/deployments/validate/action Azure Activity Log Queries # Log Analytics AzureActivity |where OperationNameValue==\"microsoft.compute/virtualMachines/extensions/write\" or OperationNameValue==\"Microsoft.Resources/deployments/validate/action\" Detection Screenshot # Additional Resources https://docs.microsoft.com/en-us/troubleshoot/azure/virtual-machines/reset-rdp","title":"AZT501.3 - Azure VM Local Administrator Manipulation"},{"location":"Persistence/AZT501/AZT501-3/#azt5013-account-manipulation-azure-vm-local-administrator-manipulation","text":"An adverary may manipulate the local admin account on an Azure VM Resource Azure Active Directory Actions microsoft.compute/virtualMachines/extensions/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzVMAccessExtension az vm extension set PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Compute / virtualMachines /{ vmName }/ extensions /{ vmExtensionName } ? api-version = 2022 - 03 - 01 Detections","title":"AZT501.3 - Account Manipulation: Azure VM Local Administrator Manipulation"},{"location":"Persistence/AZT501/AZT501-3/#detection-details","text":"After a successful reset, the log 'Validate Deployment' will be created. Specifically, in the scope, a password reset will be mentioned \"VMAccessWindowsPasswordReset\".","title":"Detection Details"},{"location":"Persistence/AZT501/AZT501-3/#logs","text":"Data Source Operation Name Action Log Location Resource Create or Udpate Virutal Machine Extension microsoft.compute/virtualMachines/extensions/write Azure Activity Log Resource Validate Deployment Microsoft.Resources/deployments/validate/action Azure Activity Log","title":"Logs"},{"location":"Persistence/AZT501/AZT501-3/#queries","text":"Log Analytics AzureActivity |where OperationNameValue==\"microsoft.compute/virtualMachines/extensions/write\" or OperationNameValue==\"Microsoft.Resources/deployments/validate/action\"","title":"Queries"},{"location":"Persistence/AZT501/AZT501-3/#detection-screenshot","text":"Additional Resources https://docs.microsoft.com/en-us/troubleshoot/azure/virtual-machines/reset-rdp","title":"Detection Screenshot"},{"location":"Persistence/AZT501/AZT501/","text":"AZT501 - Account Manipulation # An adverary may manipulate an account to maintain access in an Azure tenant ID Name Description Action Resources AZT501.1 User Account Manipulation An adverary may manipulate a user account to maintain access in an Azure tenant microsoft.directory/users/password/update Azure Active Directory microsoft.directory/users/enable microsoft.directory/users/restore AZT501.2 Service Principal Manipulation An adverary may manipulate a service principal to maintain access in an Azure tenant microsoft.directory/servicePrincipals/enable Azure Active Directory microsoft.directory/servicePrincipals/credentials/update microsoft.directory/servicePrincipals/owners/update AZT501.3 Azure VM Local Administrator Manipulation An adverary may manipulate the local admin account on an Azure VM microsoft.compute/virtualMachines/extensions/write Azure Virtual Machine","title":"AZT501 - Account Manipulation"},{"location":"Persistence/AZT501/AZT501/#azt501-account-manipulation","text":"An adverary may manipulate an account to maintain access in an Azure tenant ID Name Description Action Resources AZT501.1 User Account Manipulation An adverary may manipulate a user account to maintain access in an Azure tenant microsoft.directory/users/password/update Azure Active Directory microsoft.directory/users/enable microsoft.directory/users/restore AZT501.2 Service Principal Manipulation An adverary may manipulate a service principal to maintain access in an Azure tenant microsoft.directory/servicePrincipals/enable Azure Active Directory microsoft.directory/servicePrincipals/credentials/update microsoft.directory/servicePrincipals/owners/update AZT501.3 Azure VM Local Administrator Manipulation An adverary may manipulate the local admin account on an Azure VM microsoft.compute/virtualMachines/extensions/write Azure Virtual Machine","title":"AZT501 - Account Manipulation"},{"location":"Persistence/AZT502/AZT502-1/","text":"AZT502.1 - Account Creation: User Account Creation # An adversary may create an application & service principal in Azure Active Directory Resource Azure Active Directory Actions microsoft.directory/users/create Examples Az PowerShell Azure CLI Microsoft Graph API Azure Portal New-AzADUser az ad user create POST https : // graph . microsoft . com / v1 .0 / users Detections Logs # Data Source Operation Name Action Log Location Azure Active Directory Add user microsoft.directory/users/create AzureAD Audit Logs Queries # Log Analytics AuditLogs| where ActivityDisplayName == \"Add user\" Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-users-reset-password-azure-portal","title":"AZT502.1 - User Account Creation"},{"location":"Persistence/AZT502/AZT502-1/#azt5021-account-creation-user-account-creation","text":"An adversary may create an application & service principal in Azure Active Directory Resource Azure Active Directory Actions microsoft.directory/users/create Examples Az PowerShell Azure CLI Microsoft Graph API Azure Portal New-AzADUser az ad user create POST https : // graph . microsoft . com / v1 .0 / users Detections","title":"AZT502.1 - Account Creation: User Account Creation"},{"location":"Persistence/AZT502/AZT502-1/#logs","text":"Data Source Operation Name Action Log Location Azure Active Directory Add user microsoft.directory/users/create AzureAD Audit Logs","title":"Logs"},{"location":"Persistence/AZT502/AZT502-1/#queries","text":"Log Analytics AuditLogs| where ActivityDisplayName == \"Add user\" Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-users-reset-password-azure-portal","title":"Queries"},{"location":"Persistence/AZT502/AZT502-2/","text":"AZT502.2 - Account Creation: Service Principal Creation # An adversary may create an application & service principal in Azure Active Directory Resource Azure Active Directory Actions microsoft.directory/servicePrincipals/create microsoft.directory/applications/create Examples Az PowerShell Azure CLI Microsoft Graph API Azure Portal New-AzADServicePrincipal az ad sp create POST https : // graph . microsoft . com / v1 .0 / servicePrincipals Detections Logs # Data Source Operation Name Action Log Location Azure Active Directory Add service principal microsoft.directory/servicePrincipals/create AzureAD Audit Logs Azure Active Directory Add application microsoft.directory/applications/create AzureAD Audit Logs Azure Active Directory Add owner to application microsoft.directory/servicePrincipals/owners/update AzureAD Audit Logs Queries # Log Analytics AuditLogs |where OperationName ==\"Add service principal\" or OperationName ==\"Add application\" or OperationName ==\"Add owner to application\" Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals","title":"AZT502.2 - Service Principal Creation"},{"location":"Persistence/AZT502/AZT502-2/#azt5022-account-creation-service-principal-creation","text":"An adversary may create an application & service principal in Azure Active Directory Resource Azure Active Directory Actions microsoft.directory/servicePrincipals/create microsoft.directory/applications/create Examples Az PowerShell Azure CLI Microsoft Graph API Azure Portal New-AzADServicePrincipal az ad sp create POST https : // graph . microsoft . com / v1 .0 / servicePrincipals Detections","title":"AZT502.2 - Account Creation: Service Principal Creation"},{"location":"Persistence/AZT502/AZT502-2/#logs","text":"Data Source Operation Name Action Log Location Azure Active Directory Add service principal microsoft.directory/servicePrincipals/create AzureAD Audit Logs Azure Active Directory Add application microsoft.directory/applications/create AzureAD Audit Logs Azure Active Directory Add owner to application microsoft.directory/servicePrincipals/owners/update AzureAD Audit Logs","title":"Logs"},{"location":"Persistence/AZT502/AZT502-2/#queries","text":"Log Analytics AuditLogs |where OperationName ==\"Add service principal\" or OperationName ==\"Add application\" or OperationName ==\"Add owner to application\" Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals","title":"Queries"},{"location":"Persistence/AZT502/AZT502-3/","text":"AZT502.1 - Account Creation: Guest Account Creation # An adversary may create a guest account in Azure Active Directory Resource Azure Active Directory Actions microsoft.directory/users/create microsoft.directory/users/inviteGuest Examples Azure Portal Detections Logs # Data Source Operation Name Action Log Location Azure Active Directory Invited Users microsoft.directory/users/inviteGuest AzureAD Audit Logs Queries # Log Analytics AuditLogs| where ActivityDisplayName == \"Invited Users\" Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/external-identities/b2b-quickstart-add-guest-users-portal","title":"AZT502.3 - Guest Account Creation"},{"location":"Persistence/AZT502/AZT502-3/#azt5021-account-creation-guest-account-creation","text":"An adversary may create a guest account in Azure Active Directory Resource Azure Active Directory Actions microsoft.directory/users/create microsoft.directory/users/inviteGuest Examples Azure Portal Detections","title":"AZT502.1 - Account Creation: Guest Account Creation"},{"location":"Persistence/AZT502/AZT502-3/#logs","text":"Data Source Operation Name Action Log Location Azure Active Directory Invited Users microsoft.directory/users/inviteGuest AzureAD Audit Logs","title":"Logs"},{"location":"Persistence/AZT502/AZT502-3/#queries","text":"Log Analytics AuditLogs| where ActivityDisplayName == \"Invited Users\" Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/external-identities/b2b-quickstart-add-guest-users-portal","title":"Queries"},{"location":"Persistence/AZT502/AZT502/","text":"AZT502 - Account Creation # An adversary may create an account in Azure Active Directory. ID Name Description Action Resources AZT502.1 User Account Creation An adversary may create a user account in Azure Active Directory. microsoft.directory/users/create Azure Active Directory AZT502.2 Service Principal Creation An adversary may create an application & service principal in Azure Active Directory microsoft.directory/servicePrincipals/create Azure Active Directory microsoft.directory/applications/create AZT502.3 Guest Account Creation An adversary may create a guest account in Azure Active Directory microsoft.directory/servicePrincipals/create Azure Active Directory","title":"AZT502 - Account Creation"},{"location":"Persistence/AZT502/AZT502/#azt502-account-creation","text":"An adversary may create an account in Azure Active Directory. ID Name Description Action Resources AZT502.1 User Account Creation An adversary may create a user account in Azure Active Directory. microsoft.directory/users/create Azure Active Directory AZT502.2 Service Principal Creation An adversary may create an application & service principal in Azure Active Directory microsoft.directory/servicePrincipals/create Azure Active Directory microsoft.directory/applications/create AZT502.3 Guest Account Creation An adversary may create a guest account in Azure Active Directory microsoft.directory/servicePrincipals/create Azure Active Directory","title":"AZT502 - Account Creation"},{"location":"Persistence/AZT503/AZT503-1/","text":"AZT503.1 - HTTP Trigger: Logic Application HTTP Trigger # Adversaries may configure a Logic Application with a user account or managed identity and modify the HTTP trigger to run a command via HTTP request. Resource Logic Application Actions Microsoft.Logic/workflows/write Microsoft.Logic/workflows/run/action Microsoft.Logic/operations/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzLogicApp az logicapp start PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Logic / workflows / { workflowName } ? api - version = 2016 - 06 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Gets workflow recommend operation groups Microsoft.Logic/locations/workflows/recommendOperationGroups/action Azure Activity Log Resource List Trigger Callback URL Microsoft.Logic/workflows/triggers/listCallbackUrl/action Azure Activity Log Resource Add or Update Connection Microsoft.Web/connections/write Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Logic/locations/workflows/recommendOperationGroups/action\" or OperationNameValue==\"Microsoft.Logic/workflows/triggers/listCallbackUrl/action\"orOperationNameValue==\"Microsoft.Web/connections/write\" Additional Resources https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-overview","title":"AZT503.1 - Logic Application HTTP Trigger"},{"location":"Persistence/AZT503/AZT503-1/#azt5031-http-trigger-logic-application-http-trigger","text":"Adversaries may configure a Logic Application with a user account or managed identity and modify the HTTP trigger to run a command via HTTP request. Resource Logic Application Actions Microsoft.Logic/workflows/write Microsoft.Logic/workflows/run/action Microsoft.Logic/operations/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzLogicApp az logicapp start PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Logic / workflows / { workflowName } ? api - version = 2016 - 06 - 01 Detections","title":"AZT503.1 - HTTP Trigger: Logic Application HTTP Trigger"},{"location":"Persistence/AZT503/AZT503-1/#logs","text":"Data Source Operation Name Action Log Location Resource Gets workflow recommend operation groups Microsoft.Logic/locations/workflows/recommendOperationGroups/action Azure Activity Log Resource List Trigger Callback URL Microsoft.Logic/workflows/triggers/listCallbackUrl/action Azure Activity Log Resource Add or Update Connection Microsoft.Web/connections/write Azure Activity Log","title":"Logs"},{"location":"Persistence/AZT503/AZT503-1/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Logic/locations/workflows/recommendOperationGroups/action\" or OperationNameValue==\"Microsoft.Logic/workflows/triggers/listCallbackUrl/action\"orOperationNameValue==\"Microsoft.Web/connections/write\" Additional Resources https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-overview","title":"Queries"},{"location":"Persistence/AZT503/AZT503-2/","text":"AZT503.2 - HTTP Trigger: Function App HTTP Trigger # Adversaries may configure a Function Application with a user account or managed identity and modify the HTTP trigger to run a command via HTTP request. Resource Function App Actions Microsoft.Web/sites/Write Microsoft.web/sites/functions/action Microsoft.web/sites/functions/write Examples Az PowerShell Azure CLI Update-AzFunctionApp az functionapp update Detections Logs # Data Source Operation Name Action Log Location Azure Active Directory Update website Microsoft.Web/sites/write AzureAD Audit Logs Azure Active Directory Start Web App Microsoft.Web/sites/start/action AzureAD Audit Logs Queries # Log Analytics AuditLogs| where ActivityDisplayName == \"Update website\" or ActivityDisplayName == \"Start Web App\" Additional Resources https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview","title":"AZT503.2 - Function App HTTP Trigger"},{"location":"Persistence/AZT503/AZT503-2/#azt5032-http-trigger-function-app-http-trigger","text":"Adversaries may configure a Function Application with a user account or managed identity and modify the HTTP trigger to run a command via HTTP request. Resource Function App Actions Microsoft.Web/sites/Write Microsoft.web/sites/functions/action Microsoft.web/sites/functions/write Examples Az PowerShell Azure CLI Update-AzFunctionApp az functionapp update Detections","title":"AZT503.2 - HTTP Trigger: Function App HTTP Trigger"},{"location":"Persistence/AZT503/AZT503-2/#logs","text":"Data Source Operation Name Action Log Location Azure Active Directory Update website Microsoft.Web/sites/write AzureAD Audit Logs Azure Active Directory Start Web App Microsoft.Web/sites/start/action AzureAD Audit Logs","title":"Logs"},{"location":"Persistence/AZT503/AZT503-2/#queries","text":"Log Analytics AuditLogs| where ActivityDisplayName == \"Update website\" or ActivityDisplayName == \"Start Web App\" Additional Resources https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview","title":"Queries"},{"location":"Persistence/AZT503/AZT503-3/","text":"AZT503.3 - HTTP Trigger: Runbook Webhook # Adversaries may create a webhook to a Runbook which allows unauthenticated access into an Azure subscription or tenant. Resource Automation Accounts Actions Microsoft.Automation/automationAccounts/runbooks/* Microsoft.Automation/automationAccounts/webhooks/write Examples Az PowerShell Azure REST API Azure Portal New-AzAutomationWebhook PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Automation / automationAccounts / { automationAccountName } / webhooks / { webhookName } ? api - version = 2015 - 10 - 31 Detections Logs # Data Source Operation Name Action Log Location Resource Create or Update an Azure Automation webhook Microsoft.Automation/automationAccounts/webhooks/write Azure Activity Log Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-webhooks?tabs=portal https://www.netspi.com/blog/technical/cloud-penetration-testing/maintaining-azure-persistence-via-automation-accounts/","title":"AZT503.3 - Runbook Webhook"},{"location":"Persistence/AZT503/AZT503-3/#azt5033-http-trigger-runbook-webhook","text":"Adversaries may create a webhook to a Runbook which allows unauthenticated access into an Azure subscription or tenant. Resource Automation Accounts Actions Microsoft.Automation/automationAccounts/runbooks/* Microsoft.Automation/automationAccounts/webhooks/write Examples Az PowerShell Azure REST API Azure Portal New-AzAutomationWebhook PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Automation / automationAccounts / { automationAccountName } / webhooks / { webhookName } ? api - version = 2015 - 10 - 31 Detections","title":"AZT503.3 - HTTP Trigger: Runbook Webhook"},{"location":"Persistence/AZT503/AZT503-3/#logs","text":"Data Source Operation Name Action Log Location Resource Create or Update an Azure Automation webhook Microsoft.Automation/automationAccounts/webhooks/write Azure Activity Log Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-webhooks?tabs=portal https://www.netspi.com/blog/technical/cloud-penetration-testing/maintaining-azure-persistence-via-automation-accounts/","title":"Logs"},{"location":"Persistence/AZT503/AZT503-4/","text":"AZT503.4 - HTTP Trigger: WebJob # Adversaries may create a WebJob on a App Service which allows arbitrary background tasks to be run on a set schedule Resource App Service Actions Microsoft.Web/sites/Write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Start-AzWebAppTriggeredWebJob az webapp webjob triggered PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Web / sites / { name } / triggeredwebjobs / { webJobName } / run ? api - version = 2021 - 02 - 01 Detections Detection Details # To enable logging on AppServices, a Diagnostic setting must be enabled to send logs to an aggregator. In addition, App Service Logs should be enabled. WebJob output logs can be viewed on the web application in the format: https://{WEBAPPNAME}.scm.azurewebsites.net/azurejobs/#/jobs/ Detection Screenshot # Web Job Logs Application Logs Additional Resources https://github.com/Azure/azure-webjobs-sdk/wiki#documentation https://docs.microsoft.com/en-us/azure/app-service/webjobs-create","title":"AZT503.4 - WebJob"},{"location":"Persistence/AZT503/AZT503-4/#azt5034-http-trigger-webjob","text":"Adversaries may create a WebJob on a App Service which allows arbitrary background tasks to be run on a set schedule Resource App Service Actions Microsoft.Web/sites/Write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Start-AzWebAppTriggeredWebJob az webapp webjob triggered PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Web / sites / { name } / triggeredwebjobs / { webJobName } / run ? api - version = 2021 - 02 - 01 Detections","title":"AZT503.4 - HTTP Trigger: WebJob"},{"location":"Persistence/AZT503/AZT503-4/#detection-details","text":"To enable logging on AppServices, a Diagnostic setting must be enabled to send logs to an aggregator. In addition, App Service Logs should be enabled. WebJob output logs can be viewed on the web application in the format: https://{WEBAPPNAME}.scm.azurewebsites.net/azurejobs/#/jobs/","title":"Detection Details"},{"location":"Persistence/AZT503/AZT503-4/#detection-screenshot","text":"Web Job Logs Application Logs Additional Resources https://github.com/Azure/azure-webjobs-sdk/wiki#documentation https://docs.microsoft.com/en-us/azure/app-service/webjobs-create","title":"Detection Screenshot"},{"location":"Persistence/AZT503/AZT503/","text":"AZT503 - HTTP Trigger # Adversaries may configure a resource with an HTTP trigger to run commands without needing authentication. ID Name Description Action Resources AZT503.1 Logic Application Adversaries may configure a Logic Application with an HTTP trigger to run commands without needing authentication. Microsoft.Logic/workflows/write Logic Application Microsoft.Logic/workflows/run/action Microsoft.Logic/operations/read AZT503.2 Function App Adversaries may configure a Function App with an HTTP trigger to run commands without needing authentication. Microsoft.Web/sites/Write Function App microsoft.web/sites/functions/action microsoft.web/sites/functions/write AZT503.3 Runbook Webhook Adversaries may create a webhook to a Runbook which allows unauthenticated access into an Azure subscription or tenant. Microsoft.Automation/automationAccounts/runbooks/* Automation Account AZT503.4 WebJob Adversaries may create a WebJob on a App Service which allows arbitrary background tasks to be run on a set schedule Microsoft.Web/sites/Write App Service","title":"AZT503 - HTTP Trigger"},{"location":"Persistence/AZT503/AZT503/#azt503-http-trigger","text":"Adversaries may configure a resource with an HTTP trigger to run commands without needing authentication. ID Name Description Action Resources AZT503.1 Logic Application Adversaries may configure a Logic Application with an HTTP trigger to run commands without needing authentication. Microsoft.Logic/workflows/write Logic Application Microsoft.Logic/workflows/run/action Microsoft.Logic/operations/read AZT503.2 Function App Adversaries may configure a Function App with an HTTP trigger to run commands without needing authentication. Microsoft.Web/sites/Write Function App microsoft.web/sites/functions/action microsoft.web/sites/functions/write AZT503.3 Runbook Webhook Adversaries may create a webhook to a Runbook which allows unauthenticated access into an Azure subscription or tenant. Microsoft.Automation/automationAccounts/runbooks/* Automation Account AZT503.4 WebJob Adversaries may create a WebJob on a App Service which allows arbitrary background tasks to be run on a set schedule Microsoft.Web/sites/Write App Service","title":"AZT503 - HTTP Trigger"},{"location":"Persistence/AZT504/AZT504/","text":"AZT504 - Watcher Tasks # By configurating a watcher task and a Runbook, an adversary can establish persistence by executing the Runbook on a triggered event. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/* Examples Az PowerShell Azure REST API Azure Portal New-AzAutomationWebhook PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Automation / automationAccounts / { automationAccountName } / webhooks / { webhookName } ? api - version = 2015 - 10 - 31 Detections Detection Details # No logs are generated when a watcher task is created. Logs # Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-scenario-using-watcher-task","title":"AZT504 - Watcher Tasks"},{"location":"Persistence/AZT504/AZT504/#azt504-watcher-tasks","text":"By configurating a watcher task and a Runbook, an adversary can establish persistence by executing the Runbook on a triggered event. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/* Examples Az PowerShell Azure REST API Azure Portal New-AzAutomationWebhook PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Automation / automationAccounts / { automationAccountName } / webhooks / { webhookName } ? api - version = 2015 - 10 - 31 Detections","title":"AZT504 - Watcher Tasks"},{"location":"Persistence/AZT504/AZT504/#detection-details","text":"No logs are generated when a watcher task is created.","title":"Detection Details"},{"location":"Persistence/AZT504/AZT504/#logs","text":"Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log","title":"Logs"},{"location":"Persistence/AZT504/AZT504/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-scenario-using-watcher-task","title":"Queries"},{"location":"Persistence/AZT505/AZT505-1/","text":"AZT505.1 - Scheduled Jobs - Runbook Schedules # Adversaries may create a schedule for a Runbook to run at a defined interval. Resource Automation Account Actions Microsoft.Automation/automationAccounts/Schedules/write Examples Az PowerShell Azure REST API Azure Portal New-AzAutomationSchedule PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Automation / automationAccounts / { automationAccountName } / jobSchedules / { jobScheduleId } ? api - version = 2019 - 06 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Create or Update an Azure Automation schedule asset Microsoft.Automation/automationAccounts/Schedules/write Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/Schedules/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/shared-resources/schedules","title":"AZT505 - Scheduled Jobs"},{"location":"Persistence/AZT505/AZT505-1/#azt5051-scheduled-jobs-runbook-schedules","text":"Adversaries may create a schedule for a Runbook to run at a defined interval. Resource Automation Account Actions Microsoft.Automation/automationAccounts/Schedules/write Examples Az PowerShell Azure REST API Azure Portal New-AzAutomationSchedule PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Automation / automationAccounts / { automationAccountName } / jobSchedules / { jobScheduleId } ? api - version = 2019 - 06 - 01 Detections","title":"AZT505.1 - Scheduled Jobs - Runbook Schedules"},{"location":"Persistence/AZT505/AZT505-1/#logs","text":"Data Source Operation Name Action Log Location Resource Create or Update an Azure Automation schedule asset Microsoft.Automation/automationAccounts/Schedules/write Azure Activity Log","title":"Logs"},{"location":"Persistence/AZT505/AZT505-1/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/Schedules/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/shared-resources/schedules","title":"Queries"},{"location":"Persistence/AZT506/AZT506/","text":"AZT506 - Network Security Group Modification # Adversaries can modify the rules in a Network Security Group to establish access over additional ports. Resource Network Security Group Actions Microsoft.Network/networkSecurityGroups/* Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzNetworkSecurityRuleConfig az network nsg rule PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Network / networkSecurityGroups / { networkSecurityGroupName } / securityRules / { securityRuleName } ? api - version = 2021 - 08 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Create or Update Security Rule Microsoft.Network/networkSecurityGroups/securityRules/write Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Network/networkSecurityGroups/securityRules/write\" Additional Resources https://docs.microsoft.com/en-us/azure/virtual-network/manage-network-security-group","title":"AZT506 - Network Security Group Modification"},{"location":"Persistence/AZT506/AZT506/#azt506-network-security-group-modification","text":"Adversaries can modify the rules in a Network Security Group to establish access over additional ports. Resource Network Security Group Actions Microsoft.Network/networkSecurityGroups/* Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzNetworkSecurityRuleConfig az network nsg rule PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Network / networkSecurityGroups / { networkSecurityGroupName } / securityRules / { securityRuleName } ? api - version = 2021 - 08 - 01 Detections","title":"AZT506 - Network Security Group Modification"},{"location":"Persistence/AZT506/AZT506/#logs","text":"Data Source Operation Name Action Log Location Resource Create or Update Security Rule Microsoft.Network/networkSecurityGroups/securityRules/write Azure Activity Log","title":"Logs"},{"location":"Persistence/AZT506/AZT506/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Network/networkSecurityGroups/securityRules/write\" Additional Resources https://docs.microsoft.com/en-us/azure/virtual-network/manage-network-security-group","title":"Queries"},{"location":"Persistence/AZT507/AZT507-1/","text":"AZT507.1 - Azure Lighthouse # Adversaries may utilize Azure Lighthouse to manage the target tenant from an external tenant Resource AzureAD Actions Microsoft.ManagedServices/registrationAssignments/Write Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzSubscriptionDeployment az deployment sub create PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Network / networkSecurityGroups / { networkSecurityGroupName } / securityRules / { securityRuleName } ? api - version = 2021 - 08 - 01 Detections Detection Details # The Az PowerShell cmdlets Get-AzManagedServicesDefinition and Get-AzManagedServicesAssignment , or az cli cmdlets az managedservices definition list and az managedservices assignment list can be used to list the onboarded customers to the tenant. Additional Resources https://docs.microsoft.com/en-us/azure/lighthouse/how-to/onboard-customer","title":"AZT507.1 - Azure Lighthouse"},{"location":"Persistence/AZT507/AZT507-1/#azt5071-azure-lighthouse","text":"Adversaries may utilize Azure Lighthouse to manage the target tenant from an external tenant Resource AzureAD Actions Microsoft.ManagedServices/registrationAssignments/Write Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzSubscriptionDeployment az deployment sub create PUT https : // management . azure . com / subscriptions / { subscriptionId } / resourceGroups / { resourceGroupName } / providers / Microsoft . Network / networkSecurityGroups / { networkSecurityGroupName } / securityRules / { securityRuleName } ? api - version = 2021 - 08 - 01 Detections","title":"AZT507.1 - Azure Lighthouse"},{"location":"Persistence/AZT507/AZT507-1/#detection-details","text":"The Az PowerShell cmdlets Get-AzManagedServicesDefinition and Get-AzManagedServicesAssignment , or az cli cmdlets az managedservices definition list and az managedservices assignment list can be used to list the onboarded customers to the tenant. Additional Resources https://docs.microsoft.com/en-us/azure/lighthouse/how-to/onboard-customer","title":"Detection Details"},{"location":"Persistence/AZT507/AZT507-2/","text":"AZT507.2 - Microsoft Partners # Adversaries may use Delegated Administrative Privileges to give themselves administrator access to the target tenant. Resource AzureAD Actions N/A Examples N/A Detections Detection Details # By reviewing access logs in AzureAD, a key indicator is identifying logins from users that do not contain a domain linked to the tenant. Additional Resources https://docs.microsoft.com/en-us/microsoft-365/commerce/manage-partners?view=o365-worldwide https://o365blog.com/post/partners/","title":"AZT507.2 - Microsoft Partners"},{"location":"Persistence/AZT507/AZT507-2/#azt5072-microsoft-partners","text":"Adversaries may use Delegated Administrative Privileges to give themselves administrator access to the target tenant. Resource AzureAD Actions N/A Examples N/A Detections","title":"AZT507.2 - Microsoft Partners"},{"location":"Persistence/AZT507/AZT507-2/#detection-details","text":"By reviewing access logs in AzureAD, a key indicator is identifying logins from users that do not contain a domain linked to the tenant. Additional Resources https://docs.microsoft.com/en-us/microsoft-365/commerce/manage-partners?view=o365-worldwide https://o365blog.com/post/partners/","title":"Detection Details"},{"location":"Persistence/AZT507/AZT507-3/","text":"AZT507.3 - Subscription Hijack # An adversary may transfer a subscription from a target tenant to an attacker-controlled tenant. This retains the billing account setup by the target and the target tenant administrators will no longer have control over the subscription. Resource Azure Subscription Actions The \"Owner\" role is needed to complete the transfer. Examples Azure Portal Detections Detection Details # A policy can be placed on the subscription to prevent transfers. https://docs.microsoft.com/en-us/azure/cost-management-billing/manage/manage-azure-subscription-policy The logs for the subscription are transfered with the subscription Additional Resources https://docs.microsoft.com/en-us/azure/role-based-access-control/transfer-subscription https://derkvanderwoude.medium.com/azure-subscription-hijacking-and-cryptomining-86c2ac018983","title":"AZT507.3 - Subscription Hijack"},{"location":"Persistence/AZT507/AZT507-3/#azt5073-subscription-hijack","text":"An adversary may transfer a subscription from a target tenant to an attacker-controlled tenant. This retains the billing account setup by the target and the target tenant administrators will no longer have control over the subscription. Resource Azure Subscription Actions The \"Owner\" role is needed to complete the transfer. Examples Azure Portal Detections","title":"AZT507.3 - Subscription Hijack"},{"location":"Persistence/AZT507/AZT507-3/#detection-details","text":"A policy can be placed on the subscription to prevent transfers. https://docs.microsoft.com/en-us/azure/cost-management-billing/manage/manage-azure-subscription-policy The logs for the subscription are transfered with the subscription Additional Resources https://docs.microsoft.com/en-us/azure/role-based-access-control/transfer-subscription https://derkvanderwoude.medium.com/azure-subscription-hijacking-and-cryptomining-86c2ac018983","title":"Detection Details"},{"location":"Persistence/AZT507/AZT507-4/","text":"AZT507.3 - Domain Trust Modification # An adversary may add an additional identity provider or domain to maintain a backdoor into the tenant. Resource AzureAD Actions N/A Examples Detections Detection Details # Monitor the 'Pass-through Authentication' page in the Azure portal. Azure AD Connect > Pass-through Authentication Additional Resources https://o365blog.com/post/aadbackdoor/ https://www.mandiant.com/resources/detecting-microsoft-365-azure-active-directory-backdoors https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Defense%20evasion/ADFSDomainTrustMods%5BNobelium%5D.yaml","title":"AZT507.4 - Domain Trust Modification"},{"location":"Persistence/AZT507/AZT507-4/#azt5073-domain-trust-modification","text":"An adversary may add an additional identity provider or domain to maintain a backdoor into the tenant. Resource AzureAD Actions N/A Examples Detections","title":"AZT507.3 - Domain Trust Modification"},{"location":"Persistence/AZT507/AZT507-4/#detection-details","text":"Monitor the 'Pass-through Authentication' page in the Azure portal. Azure AD Connect > Pass-through Authentication Additional Resources https://o365blog.com/post/aadbackdoor/ https://www.mandiant.com/resources/detecting-microsoft-365-azure-active-directory-backdoors https://github.com/Azure/Azure-Sentinel/blob/master/Hunting%20Queries/Microsoft%20365%20Defender/Defense%20evasion/ADFSDomainTrustMods%5BNobelium%5D.yaml","title":"Detection Details"},{"location":"Persistence/AZT507/AZT507/","text":"AZT507 - External Entity Access # Adversaries may configure the target Azure tenant to be managed by another, externel tenant, or its users. ID Name Description Action Resources AZT507.1 Azure Lighthouse Adversaries may utilize Azure Lighthouse to manage the target tenant from an external tenant. Microsoft.ManagedServices/registrationAssignments/Write AzureAD AZT507.2 Microsoft Partners Adversaries may use Delegated Administrative Privileges to give themselves administrator access to the target tenant. N/A AzureAD AZT507.3 Subscription Hijack An adversary may transfer a subscription from a target tenant to an attacker-controlled tenant. N/A Azure Subscription AZT507.4 Domain Trust Modification An adversary may add an additional identity provider or domain to maintain a backdoor into the tenant. N/A AzureAD","title":"AZT507 - External Entity Access"},{"location":"Persistence/AZT507/AZT507/#azt507-external-entity-access","text":"Adversaries may configure the target Azure tenant to be managed by another, externel tenant, or its users. ID Name Description Action Resources AZT507.1 Azure Lighthouse Adversaries may utilize Azure Lighthouse to manage the target tenant from an external tenant. Microsoft.ManagedServices/registrationAssignments/Write AzureAD AZT507.2 Microsoft Partners Adversaries may use Delegated Administrative Privileges to give themselves administrator access to the target tenant. N/A AzureAD AZT507.3 Subscription Hijack An adversary may transfer a subscription from a target tenant to an attacker-controlled tenant. N/A Azure Subscription AZT507.4 Domain Trust Modification An adversary may add an additional identity provider or domain to maintain a backdoor into the tenant. N/A AzureAD","title":"AZT507 - External Entity Access"},{"location":"Persistence/AZT508/AZT508/","text":"AZT508 - Azure Policy # By configuring a policy with the 'DeployIfNotExists' definition, an adverary may establish persistence by creating a backdoor when the policy is triggered. Resource Azure Policy Actions Microsoft.Authorization/policies/deployIfNotExists/action Microsoft.Authorization/policyAssignments/write Examples Azure Portal Detections Logs # Data Source Operation Name Action Log Location Resource 'deployIfNotExists' Policy Action Microsoft.Authorization/policies/deployIfNotExists/action Activity Log Resource N/A Microsoft.Authorization/policyAssignments/write Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Authorization/policies/deployIfNotExists/action\" or OperationNameValue==\"Microsoft.Authorization/policyAssignments/write\" Additional Resources https://docs.microsoft.com/en-us/azure/governance/policy/concepts/effects#deployifnotexists","title":"AZT508 - Azure Policy"},{"location":"Persistence/AZT508/AZT508/#azt508-azure-policy","text":"By configuring a policy with the 'DeployIfNotExists' definition, an adverary may establish persistence by creating a backdoor when the policy is triggered. Resource Azure Policy Actions Microsoft.Authorization/policies/deployIfNotExists/action Microsoft.Authorization/policyAssignments/write Examples Azure Portal Detections","title":"AZT508 - Azure Policy"},{"location":"Persistence/AZT508/AZT508/#logs","text":"Data Source Operation Name Action Log Location Resource 'deployIfNotExists' Policy Action Microsoft.Authorization/policies/deployIfNotExists/action Activity Log Resource N/A Microsoft.Authorization/policyAssignments/write Activity Log","title":"Logs"},{"location":"Persistence/AZT508/AZT508/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Authorization/policies/deployIfNotExists/action\" or OperationNameValue==\"Microsoft.Authorization/policyAssignments/write\" Additional Resources https://docs.microsoft.com/en-us/azure/governance/policy/concepts/effects#deployifnotexists","title":"Queries"},{"location":"PrivilegeEscalation/PrivEsc/","text":"Privilige Escalation # The adversary is trying to escalate their privileges within Azure Resources or Azure Active Directory. ID Name Description AZT401 Privileged Identity Management Role An adversary may escalate their privileges if their current account has access to Privileged Identity Management (PIM) AZT402 Elevated Access Toggle An adversary may escalate their privileges from Azure AD to all Azure subscriptions in the tenant if they are a global administrator AZT403 Local Resource Hijack An adversary may escalate their privileges by tampering with a local file generated by a resource .001 Cloud Shell .IMG By modifying the .bashrc file in a CloudShell .IMG file, an adversary may escalate their privileges AZT404 Principal Impersonation Adversaries may abuse resources that are configured with a service principal or other identity to further their access to the current or other resources. .001 Function Application By utilizing a Function Application configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. .002 Logic Application By utilizing a Logic Application configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. .003 Automation Account By utilizing a Automation Account configured with a managed identity or RunAs account, an attacker can execute Azure operations on a given resource. .004 App Service By utilizing an App Service configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. AZT405 Azure AD Application Adversaries may abuse the assigned permissions on an Azure AD Application to escalate their privileges. .001 Application API Permissions By compromising a service principal whose application has privileged API permissions, an attacker can escalate their privileges to a higher privileged role. .002 Application Role By compromising a user, user in a group, or service principal that has an application role over an application, they may be able to escalate their privileges by impersonating the associated service principal and leveraging any privileged assigned application role. .003 Application Registration Owner By compromising an account who is an 'Owner' over an application that is configured with additional roles or API permissions, an attacker can escalate their privileges by adding a certificate or credentials & logging in as the service principal.","title":"Privilege Escalation"},{"location":"PrivilegeEscalation/PrivEsc/#privilige-escalation","text":"The adversary is trying to escalate their privileges within Azure Resources or Azure Active Directory. ID Name Description AZT401 Privileged Identity Management Role An adversary may escalate their privileges if their current account has access to Privileged Identity Management (PIM) AZT402 Elevated Access Toggle An adversary may escalate their privileges from Azure AD to all Azure subscriptions in the tenant if they are a global administrator AZT403 Local Resource Hijack An adversary may escalate their privileges by tampering with a local file generated by a resource .001 Cloud Shell .IMG By modifying the .bashrc file in a CloudShell .IMG file, an adversary may escalate their privileges AZT404 Principal Impersonation Adversaries may abuse resources that are configured with a service principal or other identity to further their access to the current or other resources. .001 Function Application By utilizing a Function Application configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. .002 Logic Application By utilizing a Logic Application configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. .003 Automation Account By utilizing a Automation Account configured with a managed identity or RunAs account, an attacker can execute Azure operations on a given resource. .004 App Service By utilizing an App Service configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. AZT405 Azure AD Application Adversaries may abuse the assigned permissions on an Azure AD Application to escalate their privileges. .001 Application API Permissions By compromising a service principal whose application has privileged API permissions, an attacker can escalate their privileges to a higher privileged role. .002 Application Role By compromising a user, user in a group, or service principal that has an application role over an application, they may be able to escalate their privileges by impersonating the associated service principal and leveraging any privileged assigned application role. .003 Application Registration Owner By compromising an account who is an 'Owner' over an application that is configured with additional roles or API permissions, an attacker can escalate their privileges by adding a certificate or credentials & logging in as the service principal.","title":"Privilige Escalation"},{"location":"PrivilegeEscalation/AZT401/AZT401/","text":"AZT401 - Privileged Identity Management Role # An adversary may escalate their privileges if their current account is eligible for role activation via Privileged Identity Management (PIM). Resource Azure Active Directory Azure Resources Actions RoleManagement.ReadWrite.Directory RoleManagement.Read.Directory Examples AzureAD PowerShell Microsoft Azure Graph API Azure REST API Azure Portal Open-AzureADMSPrivilegedRoleAssignmentRequest GET https :// graph . microsoft . com / beta / roleManagement / directory / roleEligibilitySchedules / 313af44a - 07c9 - 43a7 - 9970 - 5072a6b5591f GET https :// management . azure . com /{ scope }/ providers / Microsoft . Authorization / roleEligibilityScheduleRequests /{ roleEligibilityScheduleRequestName } ? api-version = 2020 - 10 - 01 Detections Logs # Data Source Operation Name Action Log Location Azure Active Directory Add member to role requested (PIM activation) RoleManagement.ReadWrite.Directory PIM Audit Logs Azure Active Directory Add member to role completed (PIM activation) RoleManagement.ReadWrite.Directory PIM Audit Logs Azure Active Directory Add eligible member to role in PIM completed (permanent) RoleManagement.ReadWrite.Directory PIM Audit Logs Azure Active Directory Add eligible member to role in PIM requested (permanent) RoleManagement.ReadWrite.Directory PIM Audit Logs Detection Screenshots # Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/privileged-identity-management/pim-configure https://docs.microsoft.com/en-us/azure/active-directory/privileged-identity-management/powershell-for-azure-ad-roles https://docs.microsoft.com/en-us/azure/active-directory/privileged-identity-management/pim-apis","title":"AZT401 - Privileged Identity Management Role"},{"location":"PrivilegeEscalation/AZT401/AZT401/#azt401-privileged-identity-management-role","text":"An adversary may escalate their privileges if their current account is eligible for role activation via Privileged Identity Management (PIM). Resource Azure Active Directory Azure Resources Actions RoleManagement.ReadWrite.Directory RoleManagement.Read.Directory Examples AzureAD PowerShell Microsoft Azure Graph API Azure REST API Azure Portal Open-AzureADMSPrivilegedRoleAssignmentRequest GET https :// graph . microsoft . com / beta / roleManagement / directory / roleEligibilitySchedules / 313af44a - 07c9 - 43a7 - 9970 - 5072a6b5591f GET https :// management . azure . com /{ scope }/ providers / Microsoft . Authorization / roleEligibilityScheduleRequests /{ roleEligibilityScheduleRequestName } ? api-version = 2020 - 10 - 01 Detections","title":"AZT401 - Privileged Identity Management Role"},{"location":"PrivilegeEscalation/AZT401/AZT401/#logs","text":"Data Source Operation Name Action Log Location Azure Active Directory Add member to role requested (PIM activation) RoleManagement.ReadWrite.Directory PIM Audit Logs Azure Active Directory Add member to role completed (PIM activation) RoleManagement.ReadWrite.Directory PIM Audit Logs Azure Active Directory Add eligible member to role in PIM completed (permanent) RoleManagement.ReadWrite.Directory PIM Audit Logs Azure Active Directory Add eligible member to role in PIM requested (permanent) RoleManagement.ReadWrite.Directory PIM Audit Logs","title":"Logs"},{"location":"PrivilegeEscalation/AZT401/AZT401/#detection-screenshots","text":"Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/privileged-identity-management/pim-configure https://docs.microsoft.com/en-us/azure/active-directory/privileged-identity-management/powershell-for-azure-ad-roles https://docs.microsoft.com/en-us/azure/active-directory/privileged-identity-management/pim-apis","title":"Detection Screenshots"},{"location":"PrivilegeEscalation/AZT402/AZT402/","text":"AZT402 - Elevated Access Toggle # An adversary may escalate their privileges from Azure AD to all Azure subscriptions in the tenant if they are a global administrator Resource Azure Active Directory Actions Microsoft.Authorization/elevateAccess/action Examples Azure CLI Azure REST API Azure Portal az rest -- method post -- url \"/providers/Microsoft.Authorization/elevateAccess?api-version=2016-07-01\" POST https :// management . azure . com / providers / Microsoft . Authorization / elevateAccess ? api-version = 2016 - 07 - 01 Detections Logs # Data Source Operation Name Action Log Location Azure Active Directory Assigns the caller to User Access Administrator role Microsoft.Authorization/elevateAccess/action AzureAD Audit Logs Queries # Log Analytics | where ActivityDisplayName == \"Assigns the caller to User Access Administrator role\" Detection Screenshots # Additional Resources https://docs.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin","title":"AZT402 - Elevated Access Toggle"},{"location":"PrivilegeEscalation/AZT402/AZT402/#azt402-elevated-access-toggle","text":"An adversary may escalate their privileges from Azure AD to all Azure subscriptions in the tenant if they are a global administrator Resource Azure Active Directory Actions Microsoft.Authorization/elevateAccess/action Examples Azure CLI Azure REST API Azure Portal az rest -- method post -- url \"/providers/Microsoft.Authorization/elevateAccess?api-version=2016-07-01\" POST https :// management . azure . com / providers / Microsoft . Authorization / elevateAccess ? api-version = 2016 - 07 - 01 Detections","title":"AZT402 - Elevated Access Toggle"},{"location":"PrivilegeEscalation/AZT402/AZT402/#logs","text":"Data Source Operation Name Action Log Location Azure Active Directory Assigns the caller to User Access Administrator role Microsoft.Authorization/elevateAccess/action AzureAD Audit Logs","title":"Logs"},{"location":"PrivilegeEscalation/AZT402/AZT402/#queries","text":"Log Analytics | where ActivityDisplayName == \"Assigns the caller to User Access Administrator role\"","title":"Queries"},{"location":"PrivilegeEscalation/AZT402/AZT402/#detection-screenshots","text":"Additional Resources https://docs.microsoft.com/en-us/azure/role-based-access-control/elevate-access-global-admin","title":"Detection Screenshots"},{"location":"PrivilegeEscalation/AZT403/AZT403-1/","text":"AZT403.1 - Local Resource Hijack: Cloud Shell .IMG # By modifying the .bashrc file in a CloudShell .IMG file, an adversary may escalate their privileges by injecting commands that will add an arbitrary user account to a desired role and scope. Resource Azure CloudShell Actions n/a Examples Azure Portal Detections Detection Details # A storage account is created in order to store the profile .IMG file when using CloudShell. These storage accounts always start with cs followed by a string of numbers + letters. E.g.: cs120000000ff Logs from the storage account require them to be configured with diagnostic settings being sent to a log aggregator. Additionally, ~/.config/PowerShell/Microsoft.PowerShell_profile.ps1 is where the PowerShell startup script is stored, which also may be a target for backdooring. Additional Resources https://docs.microsoft.com/en-us/azure/cloud-shell/overview https://www.netspi.com/blog/technical/cloud-penetration-testing/attacking-azure-cloud-shell/","title":"AZT403 - Local Resource Hijack"},{"location":"PrivilegeEscalation/AZT403/AZT403-1/#azt4031-local-resource-hijack-cloud-shell-img","text":"By modifying the .bashrc file in a CloudShell .IMG file, an adversary may escalate their privileges by injecting commands that will add an arbitrary user account to a desired role and scope. Resource Azure CloudShell Actions n/a Examples Azure Portal Detections","title":"AZT403.1 - Local Resource Hijack: Cloud Shell .IMG"},{"location":"PrivilegeEscalation/AZT403/AZT403-1/#detection-details","text":"A storage account is created in order to store the profile .IMG file when using CloudShell. These storage accounts always start with cs followed by a string of numbers + letters. E.g.: cs120000000ff Logs from the storage account require them to be configured with diagnostic settings being sent to a log aggregator. Additionally, ~/.config/PowerShell/Microsoft.PowerShell_profile.ps1 is where the PowerShell startup script is stored, which also may be a target for backdooring. Additional Resources https://docs.microsoft.com/en-us/azure/cloud-shell/overview https://www.netspi.com/blog/technical/cloud-penetration-testing/attacking-azure-cloud-shell/","title":"Detection Details"},{"location":"PrivilegeEscalation/AZT404/AZT404-1/","text":"AZT404.1 - Principal Impersonation: Function Application # By utilizing a Function Application configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. Resource Function Application Actions Microsoft.Web/sites/hostruntime/vfs/run.csx/write Microsoft.Web/sites/functions/write Microsoft.Web/sites/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Update-AzFunctionApp az functionapp update PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Web / sites /{ name } ? api-version = 2021 - 02 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Write Run.csx Microsoft.Web/sites/hostruntime/vfs/run.csx/write Azure Activity Log Resource Update Web Apps Functions Microsoft.Web/sites/functions/write Azure Activity Log Resource Update website Microsoft.Web/sites/write Azure Activity Log Queries # Log Analytics AzureActivity |where OperationNameValue==\"Microsoft.Web/sites/hostruntime/vfs/run.csx/write\" or OperationNameValue==\"Microsoft.Web/sites/functions/write\" or OperationNameValue==\"Microsoft.Web/sites/write\" Additional Resources https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=ps%2Cdotnet","title":"AZT404.1 - Function Application"},{"location":"PrivilegeEscalation/AZT404/AZT404-1/#azt4041-principal-impersonation-function-application","text":"By utilizing a Function Application configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. Resource Function Application Actions Microsoft.Web/sites/hostruntime/vfs/run.csx/write Microsoft.Web/sites/functions/write Microsoft.Web/sites/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Update-AzFunctionApp az functionapp update PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Web / sites /{ name } ? api-version = 2021 - 02 - 01 Detections","title":"AZT404.1 - Principal Impersonation: Function Application"},{"location":"PrivilegeEscalation/AZT404/AZT404-1/#logs","text":"Data Source Operation Name Action Log Location Resource Write Run.csx Microsoft.Web/sites/hostruntime/vfs/run.csx/write Azure Activity Log Resource Update Web Apps Functions Microsoft.Web/sites/functions/write Azure Activity Log Resource Update website Microsoft.Web/sites/write Azure Activity Log","title":"Logs"},{"location":"PrivilegeEscalation/AZT404/AZT404-1/#queries","text":"Log Analytics AzureActivity |where OperationNameValue==\"Microsoft.Web/sites/hostruntime/vfs/run.csx/write\" or OperationNameValue==\"Microsoft.Web/sites/functions/write\" or OperationNameValue==\"Microsoft.Web/sites/write\" Additional Resources https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=ps%2Cdotnet","title":"Queries"},{"location":"PrivilegeEscalation/AZT404/AZT404-2/","text":"AZT404.2 - Principal Impersonation: Logic Application # By utilizing a Logic Application configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. Resource Logic Application Actions Microsoft.Logic/workflows/write Microsoft.Logic/workflows/run/action Microsoft.Logic/operations/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzLogicApp az logicapp start PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Logic / workflows /{ workflowName } ? api-version = 2016 - 06 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Gets workflow recommend operation groups Microsoft.Logic/locations/workflows/recommendOperationGroups/action Azure Activity Log Resource List Trigger Callback URL Microsoft.Logic/workflows/triggers/listCallbackUrl/action Azure Activity Log Resource Add or Update Connection Microsoft.Web/connections/write Azure Activity Log Azure Active Directory Update website Microsoft.Web/sites/write AzureAD Audit Logs Azure Active Directory Start Web App Microsoft.Web/sites/start/action AzureAD Audit Logs Queries # Log Analytics AzureActivity |where OperationNameValue==\"Microsoft.Logic/locations/workflows/recommendOperationGroups/action\" or OperationNameValue==\"Microsoft.Logic/workflows/triggers/listCallbackUrl/action\" or OperationNameValue==\"Microsoft.Web/connections/write\" or OperationNameValue==\"Microsoft.Web/sites/write\" or OperationNameValue==\"Microsoft.Web/sites/start/action\" Additional Resources https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-overview","title":"AZT404.2 - Logic Application"},{"location":"PrivilegeEscalation/AZT404/AZT404-2/#azt4042-principal-impersonation-logic-application","text":"By utilizing a Logic Application configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. Resource Logic Application Actions Microsoft.Logic/workflows/write Microsoft.Logic/workflows/run/action Microsoft.Logic/operations/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Set-AzLogicApp az logicapp start PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Logic / workflows /{ workflowName } ? api-version = 2016 - 06 - 01 Detections","title":"AZT404.2 - Principal Impersonation: Logic Application"},{"location":"PrivilegeEscalation/AZT404/AZT404-2/#logs","text":"Data Source Operation Name Action Log Location Resource Gets workflow recommend operation groups Microsoft.Logic/locations/workflows/recommendOperationGroups/action Azure Activity Log Resource List Trigger Callback URL Microsoft.Logic/workflows/triggers/listCallbackUrl/action Azure Activity Log Resource Add or Update Connection Microsoft.Web/connections/write Azure Activity Log Azure Active Directory Update website Microsoft.Web/sites/write AzureAD Audit Logs Azure Active Directory Start Web App Microsoft.Web/sites/start/action AzureAD Audit Logs","title":"Logs"},{"location":"PrivilegeEscalation/AZT404/AZT404-2/#queries","text":"Log Analytics AzureActivity |where OperationNameValue==\"Microsoft.Logic/locations/workflows/recommendOperationGroups/action\" or OperationNameValue==\"Microsoft.Logic/workflows/triggers/listCallbackUrl/action\" or OperationNameValue==\"Microsoft.Web/connections/write\" or OperationNameValue==\"Microsoft.Web/sites/write\" or OperationNameValue==\"Microsoft.Web/sites/start/action\" Additional Resources https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-overview","title":"Queries"},{"location":"PrivilegeEscalation/AZT404/AZT404-3/","text":"AZT404.3 - Unmanaged Scripting: Automation Account Runbook # By utilizing a Automation Account configured with a managed identity or RunAs account, an attacker can execute Azure operations on a given resource. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/* Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook az automation runbook PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Automation / automationAccounts /{ automationAccountName }/ runbooks /{ runbookName } ? api-version = 2019 - 06 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log Queries # Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution","title":"AZT404.3 - Automation Account"},{"location":"PrivilegeEscalation/AZT404/AZT404-3/#azt4043-unmanaged-scripting-automation-account-runbook","text":"By utilizing a Automation Account configured with a managed identity or RunAs account, an attacker can execute Azure operations on a given resource. Resource Automation Account Actions Microsoft.Automation/automationAccounts/runbooks/* Examples Az PowerShell Azure CLI Azure REST API Azure Portal New-AzAutomationRunbook az automation runbook PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Automation / automationAccounts /{ automationAccountName }/ runbooks /{ runbookName } ? api-version = 2019 - 06 - 01 Detections","title":"AZT404.3 - Unmanaged Scripting: Automation Account Runbook"},{"location":"PrivilegeEscalation/AZT404/AZT404-3/#logs","text":"Data Source Operation Name Action Log Location Resource Create an Azure Automation job Microsoft.Automation/automationAccounts/jobs/write Azure Activity Log Resource Publish an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/publish/action Azure Activity Log Resource Write an Azure Automation runbook draft Microsoft.Automation/automationAccounts/runbooks/draft/write Azure Activity Log Resource Create or Update an Azure Automation Runbook Microsoft.Automation/automationAccounts/runbooks/write Azure Activity Log","title":"Logs"},{"location":"PrivilegeEscalation/AZT404/AZT404-3/#queries","text":"Log Analytics |where OperationNameValue==\"Microsoft.Automation/automationAccounts/jobs/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/publish/action\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/draft/write\" or OperationNameValue==\"Microsoft.Automation/automationAccounts/runbooks/write\" Additional Resources https://docs.microsoft.com/en-us/azure/automation/automation-runbook-execution","title":"Queries"},{"location":"PrivilegeEscalation/AZT404/AZT404-4/","text":"AZT404.4 - Principal Impersonation: App Service # By utilizing an App Service configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. Resource App Service Actions Microsoft.Web/sites/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Update-AzStaticWebApp az staticwebapp update PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Web / sites /{ name } ? api-version = 2021 - 02 - 01 Detections Logs # Data Source Operation Name Action Log Location Resource Update website Microsoft.Web/sites/write Azure Activity Logs Resource Start Web App Microsoft.Web/sites/start/action Azure Activity Logs Queries # Log Analytics AzureActivity |where OperationNameValue==\"Microsoft.Web/sites/write\" or OperationNameValue==\"Microsoft.Web/sites/start/action\" Additional Resources https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=portal%2Chttp","title":"AZT404.4 - App Service"},{"location":"PrivilegeEscalation/AZT404/AZT404-4/#azt4044-principal-impersonation-app-service","text":"By utilizing an App Service configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. Resource App Service Actions Microsoft.Web/sites/write Examples Az PowerShell Azure CLI Azure REST API Azure Portal Update-AzStaticWebApp az staticwebapp update PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Web / sites /{ name } ? api-version = 2021 - 02 - 01 Detections","title":"AZT404.4 - Principal Impersonation: App Service"},{"location":"PrivilegeEscalation/AZT404/AZT404-4/#logs","text":"Data Source Operation Name Action Log Location Resource Update website Microsoft.Web/sites/write Azure Activity Logs Resource Start Web App Microsoft.Web/sites/start/action Azure Activity Logs","title":"Logs"},{"location":"PrivilegeEscalation/AZT404/AZT404-4/#queries","text":"Log Analytics AzureActivity |where OperationNameValue==\"Microsoft.Web/sites/write\" or OperationNameValue==\"Microsoft.Web/sites/start/action\" Additional Resources https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=portal%2Chttp","title":"Queries"},{"location":"PrivilegeEscalation/AZT404/AZT404/","text":"AZT404 - Principal Impersonation # Adversaries may abuse resources that are configured with a service principal or other identity to further their access to the current or other resources. ID Name Description Action Resources AZT404.1 Function Application By utilizing a Function Application configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. Microsoft.Web/sites/hostruntime/vfs/run.csx/write Function App Microsoft.Web/sites/functions/write Microsoft.Web/sites/write AZT404.2 Logic Application By utilizing a Logic Application configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. Microsoft.Logic/workflows/write Logic Application Microsoft.Logic/workflows/run/action Microsoft.Logic/operations/read AZT404.3 Automation Account By utilizing a Automation Account configured with a managed identity or RunAs account, an attacker can execute Azure operations on a given resource. Microsoft.Automation/automationAccounts/runbooks/* Automation Account AZT404.4 App Service By utilizing an App Service configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. Microsoft.Web/sites/write App Service","title":"AZT404 - Principal Impersonation"},{"location":"PrivilegeEscalation/AZT404/AZT404/#azt404-principal-impersonation","text":"Adversaries may abuse resources that are configured with a service principal or other identity to further their access to the current or other resources. ID Name Description Action Resources AZT404.1 Function Application By utilizing a Function Application configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. Microsoft.Web/sites/hostruntime/vfs/run.csx/write Function App Microsoft.Web/sites/functions/write Microsoft.Web/sites/write AZT404.2 Logic Application By utilizing a Logic Application configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. Microsoft.Logic/workflows/write Logic Application Microsoft.Logic/workflows/run/action Microsoft.Logic/operations/read AZT404.3 Automation Account By utilizing a Automation Account configured with a managed identity or RunAs account, an attacker can execute Azure operations on a given resource. Microsoft.Automation/automationAccounts/runbooks/* Automation Account AZT404.4 App Service By utilizing an App Service configured with a managed identity or other identity provider, an attacker can execute Azure operations on a given resource. Microsoft.Web/sites/write App Service","title":"AZT404 - Principal Impersonation"},{"location":"PrivilegeEscalation/AZT405/AZT405-1/","text":"AZT405.1 - Azure AD Application: Application Role # By compromising a user, user in a group, or service principal that has an application role over an application, they may be able to escalate their privileges by impersonating the associated service principal and leveraging any privileged assigned application role. Resource Azure Active Directory Actions N/A Since the attacker controls the application, no actions are needed. Examples Azure REST API Azure Portal GET https :// graph . microsoft . com / v1 . 0 / servicePrincipals ? $filter = appId eq '00000002-0000-0000-c000-000000000000' Detections Logs # Data Source Operation Name Action Log Location N/A N/A N/A N/A Additional Resources https://docs.microsoft.com/en-us/graph/migrate-azure-ad-graph-configure-permissions","title":"AZT405.1 - Application API Permissions"},{"location":"PrivilegeEscalation/AZT405/AZT405-1/#azt4051-azure-ad-application-application-role","text":"By compromising a user, user in a group, or service principal that has an application role over an application, they may be able to escalate their privileges by impersonating the associated service principal and leveraging any privileged assigned application role. Resource Azure Active Directory Actions N/A Since the attacker controls the application, no actions are needed. Examples Azure REST API Azure Portal GET https :// graph . microsoft . com / v1 . 0 / servicePrincipals ? $filter = appId eq '00000002-0000-0000-c000-000000000000' Detections","title":"AZT405.1 - Azure AD Application: Application Role"},{"location":"PrivilegeEscalation/AZT405/AZT405-1/#logs","text":"Data Source Operation Name Action Log Location N/A N/A N/A N/A Additional Resources https://docs.microsoft.com/en-us/graph/migrate-azure-ad-graph-configure-permissions","title":"Logs"},{"location":"PrivilegeEscalation/AZT405/AZT405-2/","text":"AZT405.2 - Azure AD Application: Application API Permissions # By compromising a service principal whose application has privileged API permissions, an attacker can escalate their privileges to a higher privileged role. Resource Azure Active Directory Actions N/A Since the attacker controls the application, no actions are needed. Examples Azure REST API Azure Portal PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Web / sites /{ name } ? api-version = 2021 - 02 - 01 Detections Logs # Data Source Operation Name Action Log Location N/A N/A N/A N/A Additional Resources https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=portal%2Chttp","title":"AZT405.2 - Application Role"},{"location":"PrivilegeEscalation/AZT405/AZT405-2/#azt4052-azure-ad-application-application-api-permissions","text":"By compromising a service principal whose application has privileged API permissions, an attacker can escalate their privileges to a higher privileged role. Resource Azure Active Directory Actions N/A Since the attacker controls the application, no actions are needed. Examples Azure REST API Azure Portal PUT https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Web / sites /{ name } ? api-version = 2021 - 02 - 01 Detections","title":"AZT405.2 - Azure AD Application: Application API Permissions"},{"location":"PrivilegeEscalation/AZT405/AZT405-2/#logs","text":"Data Source Operation Name Action Log Location N/A N/A N/A N/A Additional Resources https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=portal%2Chttp","title":"Logs"},{"location":"PrivilegeEscalation/AZT405/AZT405-3/","text":"AZT405.3 - Azure AD Application: Application Registration Owner # By compromising an account who is an 'Owner' over an application that is configured with additional roles or API permissions, an attacker can escalate their privileges by adding a certificate or credentials & logging in as the service principal. Resource Azure Active Directory Actions microsoft.directory/servicePrincipals/credentials/update Examples Azure PowerShell az cli Azure REST API Azure Portal New-AzADSpCredential -ServicePrincipalName ServicePrincipalName az ad sp credential reset POST / servicePrincipals /{ id }/ addKey Detections Logs # Data Source Operation Name Category Log Location Azure AD Update application \u2013 Certificates and secrets management ApplicationManagement AzureAD Audit Logs Queries # Log Analytics AuditLogs |where OperationName ==\"Update application \u2013 Certificates and secrets management\" and Category==\"ApplicationManagement\" Additional Resources https://docs.microsoft.com/en-us/powershell/azure/create-azure-service-principal-azureps?view=azps-8.0.0#reset-credentials","title":"AZT405.3 - Application Registration Owner"},{"location":"PrivilegeEscalation/AZT405/AZT405-3/#azt4053-azure-ad-application-application-registration-owner","text":"By compromising an account who is an 'Owner' over an application that is configured with additional roles or API permissions, an attacker can escalate their privileges by adding a certificate or credentials & logging in as the service principal. Resource Azure Active Directory Actions microsoft.directory/servicePrincipals/credentials/update Examples Azure PowerShell az cli Azure REST API Azure Portal New-AzADSpCredential -ServicePrincipalName ServicePrincipalName az ad sp credential reset POST / servicePrincipals /{ id }/ addKey Detections","title":"AZT405.3 - Azure AD Application: Application Registration Owner"},{"location":"PrivilegeEscalation/AZT405/AZT405-3/#logs","text":"Data Source Operation Name Category Log Location Azure AD Update application \u2013 Certificates and secrets management ApplicationManagement AzureAD Audit Logs","title":"Logs"},{"location":"PrivilegeEscalation/AZT405/AZT405-3/#queries","text":"Log Analytics AuditLogs |where OperationName ==\"Update application \u2013 Certificates and secrets management\" and Category==\"ApplicationManagement\" Additional Resources https://docs.microsoft.com/en-us/powershell/azure/create-azure-service-principal-azureps?view=azps-8.0.0#reset-credentials","title":"Queries"},{"location":"PrivilegeEscalation/AZT405/AZT405/","text":"AZT405 - Azure AD Application # Adversaries may abuse the assigned permissions on an Azure AD Application to escalate their privileges. ID Name Description Action Resources AZT405.1 Application Role By compromising a user, user in a group, or service principal that has an application role over an application, they may be able to escalate their privileges by impersonating the associated service principal and leveraging any privileged assigned application role. AzureAD AZT405.2 Application API Permissions By compromising a service principal whose application has privileged API permissions, an attacker can escalate their privileges to a higher privileged role. AzureAD AZT405.3 Application Registration Owner By compromising an account who is an 'Owner' over an application that is configured with additional roles or API permissions, an attacker can escalate their privileges by adding a certificate or credentials & logging in as the service principal. AzureAD","title":"AZT405 - Azure AD Application"},{"location":"PrivilegeEscalation/AZT405/AZT405/#azt405-azure-ad-application","text":"Adversaries may abuse the assigned permissions on an Azure AD Application to escalate their privileges. ID Name Description Action Resources AZT405.1 Application Role By compromising a user, user in a group, or service principal that has an application role over an application, they may be able to escalate their privileges by impersonating the associated service principal and leveraging any privileged assigned application role. AzureAD AZT405.2 Application API Permissions By compromising a service principal whose application has privileged API permissions, an attacker can escalate their privileges to a higher privileged role. AzureAD AZT405.3 Application Registration Owner By compromising an account who is an 'Owner' over an application that is configured with additional roles or API permissions, an attacker can escalate their privileges by adding a certificate or credentials & logging in as the service principal. AzureAD","title":"AZT405 - Azure AD Application"},{"location":"Reconnaissance/Reconnaissance/","text":"Reconnaissance # The adversary is trying to gather information they can use to plan future operations. Reconnaissance consists of techniques that involve adversaries actively or passively gathering information that can be used to support targeting. Such information may include details of the victim organization, infrastructure, or staff/personnel. This information can be leveraged by the adversary to aid in other phases of the adversary lifecycle, such as using gathered information to plan and execute Initial Access, to scope and prioritize post-compromise objectives, or to drive and lead further Reconnaissance efforts. ID Name Description AZT101 Port Mapping By viewing certain Azure resources, it is possible to view the open ports on a resource. AZT102 IP Discovery By viewing certain Azure resources, it is possible to view the private and public IP addresses assigned to a resource. AZT103 Public Accessible Resource A resource within Azure is accessible from the public internet. AZT104 Gather User Information An adversary may obtain information about a user within Azure Active Directory. AZT105 Gather Application Information An adversary may obtain information about an application within Azure Active Directory. AZT106 Gather Role Information An adversary may obtain information about a role. .001 Gather AAD Role Information An adversary may obtain information about a role within Azure Active Directory. .002 Gather Application Role Information An adversary may obtain information about an application role within Azure Active Directory. .003 Gather Azure Resources Role Assignments An adversary may gather role assignments for a specific Azure Resource, Resource Group, or Subscription. AZT107 Gather Resource Data An adversary may obtain information and data within a resource. AZT108 Gather Victim Data An adversary may access a user's personal data if their account is compromised","title":"Reconnaissance"},{"location":"Reconnaissance/Reconnaissance/#reconnaissance","text":"The adversary is trying to gather information they can use to plan future operations. Reconnaissance consists of techniques that involve adversaries actively or passively gathering information that can be used to support targeting. Such information may include details of the victim organization, infrastructure, or staff/personnel. This information can be leveraged by the adversary to aid in other phases of the adversary lifecycle, such as using gathered information to plan and execute Initial Access, to scope and prioritize post-compromise objectives, or to drive and lead further Reconnaissance efforts. ID Name Description AZT101 Port Mapping By viewing certain Azure resources, it is possible to view the open ports on a resource. AZT102 IP Discovery By viewing certain Azure resources, it is possible to view the private and public IP addresses assigned to a resource. AZT103 Public Accessible Resource A resource within Azure is accessible from the public internet. AZT104 Gather User Information An adversary may obtain information about a user within Azure Active Directory. AZT105 Gather Application Information An adversary may obtain information about an application within Azure Active Directory. AZT106 Gather Role Information An adversary may obtain information about a role. .001 Gather AAD Role Information An adversary may obtain information about a role within Azure Active Directory. .002 Gather Application Role Information An adversary may obtain information about an application role within Azure Active Directory. .003 Gather Azure Resources Role Assignments An adversary may gather role assignments for a specific Azure Resource, Resource Group, or Subscription. AZT107 Gather Resource Data An adversary may obtain information and data within a resource. AZT108 Gather Victim Data An adversary may access a user's personal data if their account is compromised","title":"Reconnaissance"},{"location":"Reconnaissance/AZT101/AZT101/","text":"AZT101 - Port Mapping # It is possible to view the open ports on a virtual machine by viewing the Virtual Network Interface's assigned Network Security Group Resource Network Security Group Actions Microsoft.Network/networkSecurityGroups/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzNetworkSecurityGroup az network nsg show GET https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/networkSecurityGroups/{networkSecurityGroupName}?api-version=2021-08-01 Detections N/A Additional Resources https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview","title":"AZT101 - Port Mapping"},{"location":"Reconnaissance/AZT101/AZT101/#azt101-port-mapping","text":"It is possible to view the open ports on a virtual machine by viewing the Virtual Network Interface's assigned Network Security Group Resource Network Security Group Actions Microsoft.Network/networkSecurityGroups/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzNetworkSecurityGroup az network nsg show GET https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/networkSecurityGroups/{networkSecurityGroupName}?api-version=2021-08-01 Detections N/A Additional Resources https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview","title":"AZT101 - Port Mapping"},{"location":"Reconnaissance/AZT102/AZT102/","text":"AZT102 - IP Discovery # It is possible to view the IP address on a resource by viewing the Virtual Network Interface Resource Network Interface Virtual Machine Actions Microsoft.Network/publicIPAddresses/read Microsoft.Compute/virtualMachines/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzPublicIpAddress az network public-ip show GET https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Network / publicIPAddresses /{ publicIpAddressName } ? api-version = 2021 - 08 - 01 Detections N/A Additional Resources https://docs.microsoft.com/en-us/azure/virtual-network/ip-services/public-ip-addresses","title":"AZT102 - IP Discovery"},{"location":"Reconnaissance/AZT102/AZT102/#azt102-ip-discovery","text":"It is possible to view the IP address on a resource by viewing the Virtual Network Interface Resource Network Interface Virtual Machine Actions Microsoft.Network/publicIPAddresses/read Microsoft.Compute/virtualMachines/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzPublicIpAddress az network public-ip show GET https :// management . azure . com / subscriptions /{ subscriptionId }/ resourceGroups /{ resourceGroupName }/ providers / Microsoft . Network / publicIPAddresses /{ publicIpAddressName } ? api-version = 2021 - 08 - 01 Detections N/A Additional Resources https://docs.microsoft.com/en-us/azure/virtual-network/ip-services/public-ip-addresses","title":"AZT102 - IP Discovery"},{"location":"Reconnaissance/AZT103/AZT103/","text":"AZT103 - Public Accessible Resource # A resource within Azure is accessible from the public internet. Resource Network Interface Virtual Machine Actions n/a Examples N/A Detections N/A","title":"AZT103 - Public Accessible Resource"},{"location":"Reconnaissance/AZT103/AZT103/#azt103-public-accessible-resource","text":"A resource within Azure is accessible from the public internet. Resource Network Interface Virtual Machine Actions n/a Examples N/A Detections N/A","title":"AZT103 - Public Accessible Resource"},{"location":"Reconnaissance/AZT104/AZT104/","text":"AZT104 - Gather User Information # An adversary may obtain information about a User within Azure Active Directory. Details may include email addresses, first/last names, job information, addresses, and assigned roles. By default, all users are able to read other user's roles and group memberships within AAD. Resource Azure Active Directory Actions microsoft.directory/*/*/read Examples Az PowerShell Azure CLI Microsoft Graph REST API Azure Portal Get-AzADUser az ad user show GET https :// graph . microsoft . com / v1 . 0 / users /{ id | userPrincipalName } Detections N/A Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions","title":"AZT104 - Gather User Information"},{"location":"Reconnaissance/AZT104/AZT104/#azt104-gather-user-information","text":"An adversary may obtain information about a User within Azure Active Directory. Details may include email addresses, first/last names, job information, addresses, and assigned roles. By default, all users are able to read other user's roles and group memberships within AAD. Resource Azure Active Directory Actions microsoft.directory/*/*/read Examples Az PowerShell Azure CLI Microsoft Graph REST API Azure Portal Get-AzADUser az ad user show GET https :// graph . microsoft . com / v1 . 0 / users /{ id | userPrincipalName } Detections N/A Additional Resources https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions","title":"AZT104 - Gather User Information"},{"location":"Reconnaissance/AZT105/AZT105/","text":"AZT105 - Gather Application Information # An adversary may obtain information about an application within Azure Active Directory. Resource Azure Active Directory Actions microsoft.directory/applications/*/read Examples Az PowerShell Azure CLI Microsoft Graph REST API Azure Portal Get-AzADApplication az ad app show GET https :// graph . microsoft . com / v1 . 0 / applications /{ id } Detections N/A Additional Resources https://docs.microsoft.com/en-us/graph/migrate-azure-ad-graph-configure-permissions","title":"AZT105 - Gather Application Information"},{"location":"Reconnaissance/AZT105/AZT105/#azt105-gather-application-information","text":"An adversary may obtain information about an application within Azure Active Directory. Resource Azure Active Directory Actions microsoft.directory/applications/*/read Examples Az PowerShell Azure CLI Microsoft Graph REST API Azure Portal Get-AzADApplication az ad app show GET https :// graph . microsoft . com / v1 . 0 / applications /{ id } Detections N/A Additional Resources https://docs.microsoft.com/en-us/graph/migrate-azure-ad-graph-configure-permissions","title":"AZT105 - Gather Application Information"},{"location":"Reconnaissance/AZT106/AZT106-1/","text":"AZT106.1 - Gather Role Information: Gather AzureAD Role Assignments # An adversary may gather role assignments within Azure Active Directory. Resource Azure Active Directory Actions microsoft.directory/roleAssignments/standard/read microsoft.directory/directoryRoles/standard/read microsoft.directory/directoryRoles/eligibleMembers/read microsoft.directory/directoryRoles/members/read Examples Microsoft Graph REST API Azure Portal GET https :// graph . microsoft . com / v1 . 0 / directoryRoles /{ role ID } Detections N/A Additional Resources N/A","title":"AZT106.1 - Gather AAD Role Information"},{"location":"Reconnaissance/AZT106/AZT106-1/#azt1061-gather-role-information-gather-azuread-role-assignments","text":"An adversary may gather role assignments within Azure Active Directory. Resource Azure Active Directory Actions microsoft.directory/roleAssignments/standard/read microsoft.directory/directoryRoles/standard/read microsoft.directory/directoryRoles/eligibleMembers/read microsoft.directory/directoryRoles/members/read Examples Microsoft Graph REST API Azure Portal GET https :// graph . microsoft . com / v1 . 0 / directoryRoles /{ role ID } Detections N/A Additional Resources N/A","title":"AZT106.1 - Gather Role Information: Gather AzureAD Role Assignments"},{"location":"Reconnaissance/AZT106/AZT106-2/","text":"AZT106.2 - Gather Role Information: Gather Application Role Assignments # An adversary may gather information about an application role & it's member assignments within Azure Active Directory. Resource Azure Active Directory Actions microsoft.directory/roleAssignments/standard/read microsoft.directory/directoryRoles/standard/read microsoft.directory/directoryRoles/eligibleMembers/read microsoft.directory/directoryRoles/members/read microsoft.directory/users/appRoleAssignments/read microsoft.directory/servicePrincipals/appRoleAssignments/read microsoft.directory/servicePrincipals/appRoleAssignedTo/read microsoft.directory/applications/owners/read Examples Az PowerShell Azure CLI Microsoft Graph REST API Azure Portal Get-AzADAppPermission az ad app permission list GET https :// graph . microsoft . com / v1 . 0 / users /{ id }/ appRoleAssignments GET https :// graph . microsoft . com / v1 . 0 / servicePrincipals /{ id }/ appRoleAssignments GET https :// graph . microsoft . com / v1 . 0 / groups /{ id }/ appRoleAssignments Detections N/A Additional Resources https://docs.microsoft.com/en-us/azure/architecture/multitenant-identity/app-roles","title":"AZT106.2 - Gather Application Role Information"},{"location":"Reconnaissance/AZT106/AZT106-2/#azt1062-gather-role-information-gather-application-role-assignments","text":"An adversary may gather information about an application role & it's member assignments within Azure Active Directory. Resource Azure Active Directory Actions microsoft.directory/roleAssignments/standard/read microsoft.directory/directoryRoles/standard/read microsoft.directory/directoryRoles/eligibleMembers/read microsoft.directory/directoryRoles/members/read microsoft.directory/users/appRoleAssignments/read microsoft.directory/servicePrincipals/appRoleAssignments/read microsoft.directory/servicePrincipals/appRoleAssignedTo/read microsoft.directory/applications/owners/read Examples Az PowerShell Azure CLI Microsoft Graph REST API Azure Portal Get-AzADAppPermission az ad app permission list GET https :// graph . microsoft . com / v1 . 0 / users /{ id }/ appRoleAssignments GET https :// graph . microsoft . com / v1 . 0 / servicePrincipals /{ id }/ appRoleAssignments GET https :// graph . microsoft . com / v1 . 0 / groups /{ id }/ appRoleAssignments Detections N/A Additional Resources https://docs.microsoft.com/en-us/azure/architecture/multitenant-identity/app-roles","title":"AZT106.2 - Gather Role Information: Gather Application Role Assignments"},{"location":"Reconnaissance/AZT106/AZT106-3/","text":"AZT106.3 - Gather Role Information: Gather Azure Resources Role Assignments # An adversary may gather role assignments for a specific Azure Resource, Resource Group, or Subscription. Resource Azure Resources Actions {resource}/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzRoleAssignment az role assignment GET https :// management . azure . com /{ scope }/ providers / Microsoft . Authorization / roleAssignments ? api-version = 2015 - 07 - 01 Detections N/A Additional Resources N/A","title":"AZT106.3 - Gather Azure Resources Role Assignments"},{"location":"Reconnaissance/AZT106/AZT106-3/#azt1063-gather-role-information-gather-azure-resources-role-assignments","text":"An adversary may gather role assignments for a specific Azure Resource, Resource Group, or Subscription. Resource Azure Resources Actions {resource}/read Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzRoleAssignment az role assignment GET https :// management . azure . com /{ scope }/ providers / Microsoft . Authorization / roleAssignments ? api-version = 2015 - 07 - 01 Detections N/A Additional Resources N/A","title":"AZT106.3 - Gather Role Information: Gather Azure Resources Role Assignments"},{"location":"Reconnaissance/AZT106/AZT106/","text":"AZT106 - Gather Role Information # An adversary may obtain information about a role within Azure Active Directory or within Azure Resource Manager. ID Name Description Action Resource AZT106.1 Gather Role Information An adversary may obtain information about a role within Azure Active Directory microsoft.directory/roleAssignments/standard/read Azure Active Directory microsoft.directory/directoryRoles/standard/read microsoft.directory/directoryRoles/eligibleMembers/read microsoft.directory/directoryRoles/members/read AZT106.2 Gather Application Role Information An adversary may obtain information about an application role within Azure Active Directory microsoft.directory/roleAssignments/standard/read Azure Active Directory microsoft.directory/directoryRoles/standard/read microsoft.directory/directoryRoles/eligibleMembers/read microsoft.directory/directoryRoles/members/read microsoft.directory/users/appRoleAssignments/read microsoft.directory/servicePrincipals/appRoleAssignments/read microsoft.directory/servicePrincipals/appRoleAssignedTo/read microsoft.directory/applications/owners/read AZT106.3 Gather Azure Resources Role Assignments An adversary may gather role assignments for a specific Azure Resource, Resource Group, or Subscription. {resource}/read Azure Resources","title":"AZT106 - Gather Role Information"},{"location":"Reconnaissance/AZT106/AZT106/#azt106-gather-role-information","text":"An adversary may obtain information about a role within Azure Active Directory or within Azure Resource Manager. ID Name Description Action Resource AZT106.1 Gather Role Information An adversary may obtain information about a role within Azure Active Directory microsoft.directory/roleAssignments/standard/read Azure Active Directory microsoft.directory/directoryRoles/standard/read microsoft.directory/directoryRoles/eligibleMembers/read microsoft.directory/directoryRoles/members/read AZT106.2 Gather Application Role Information An adversary may obtain information about an application role within Azure Active Directory microsoft.directory/roleAssignments/standard/read Azure Active Directory microsoft.directory/directoryRoles/standard/read microsoft.directory/directoryRoles/eligibleMembers/read microsoft.directory/directoryRoles/members/read microsoft.directory/users/appRoleAssignments/read microsoft.directory/servicePrincipals/appRoleAssignments/read microsoft.directory/servicePrincipals/appRoleAssignedTo/read microsoft.directory/applications/owners/read AZT106.3 Gather Azure Resources Role Assignments An adversary may gather role assignments for a specific Azure Resource, Resource Group, or Subscription. {resource}/read Azure Resources","title":"AZT106 - Gather Role Information"},{"location":"Reconnaissance/AZT107/AZT107/","text":"AZT107 - Gather Resource Data # An adversary may obtain information and data within a resource. Actions {resource}/*/read Resource Azure Resources Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzResource az resource show GET https :// management . azure . com /{ resourceId } ? api-version = 2021 - 04 - 01 Detections N/A Additional Resources N/A","title":"AZT107 - Gather Resource Data"},{"location":"Reconnaissance/AZT107/AZT107/#azt107-gather-resource-data","text":"An adversary may obtain information and data within a resource. Actions {resource}/*/read Resource Azure Resources Examples Az PowerShell Azure CLI Azure REST API Azure Portal Get-AzResource az resource show GET https :// management . azure . com /{ resourceId } ? api-version = 2021 - 04 - 01 Detections N/A Additional Resources N/A","title":"AZT107 - Gather Resource Data"},{"location":"Reconnaissance/AZT108/AZT108/","text":"AZT108 - Gather Victim Data # An adversary may access a user's personal data if their account is compromised. This includes data such as email, OneDrive, Teams, etc. Resource Azure Active Directory Actions N/A Examples N/A Detections N/A Additional Resources","title":"AZT108 - Gather Victim Data"},{"location":"Reconnaissance/AZT108/AZT108/#azt108-gather-victim-data","text":"An adversary may access a user's personal data if their account is compromised. This includes data such as email, OneDrive, Teams, etc. Resource Azure Active Directory Actions N/A Examples N/A Detections N/A Additional Resources","title":"AZT108 - Gather Victim Data"}]}